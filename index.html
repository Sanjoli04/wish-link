<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WishLink - Create Magic Moments</title>
    <link rel="icon" type="image/png" href="favicon.png">

    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { pink: '#FF0055', navy: '#002366', bg: '#F9FAFB' }
                    },
                    fontFamily: { sans: ['Nunito', 'sans-serif'] },
                    animation: {
                        'fade-in': 'fadeIn 0.6s ease-out forwards',
                        'fade-out': 'fadeOut 0.6s ease-out forwards',
                        'slide-up': 'slideUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'spin-slow': 'spin 60s linear infinite',
                        'wave': 'wave 25s linear infinite',
                        'wave-slow': 'wave 35s linear infinite',
                        'pulse-slow': 'pulse 4s ease-in-out infinite',
                        'shooting-star': 'shoot 8s ease-in-out infinite',
                        'bounce-in': 'bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        fadeOut: { '0%': { opacity: '1' }, '100%': { opacity: '0' } },
                        slideUp: { '0%': { opacity: '0', transform: 'translateY(30px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        wave: { '0%': { transform: 'translateX(0)' }, '100%': { transform: 'translateX(-50%)' } },
                        shoot: {
                            '0%': { transform: 'translateX(0) translateY(0) rotate(45deg)', opacity: '0' },
                            '10%': { opacity: '1' },
                            '20%': { transform: 'translateX(-100vh) translateY(100vh) rotate(45deg)', opacity: '0' },
                            '100%': { opacity: '0' }
                        },
                        bounceIn: { '0%': { transform: 'scale(0.3)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Nunito', sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        .font-cursive {
            font-family: 'Nunito', cursive;
            font-weight: 800;
        }

        /* --- THEME ANIMATIONS (Strictly Optimized) --- */

        /* LOVE THEME: Gentle Pulse Pattern */
        .bg-love {
            background-color: #fff0f3;
            background-image: radial-gradient(#ff0055 0.5px, transparent 0.5px), radial-gradient(#ff0055 0.5px, #fff0f3 0.5px);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
        }

        .bg-love::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at center, transparent 0%, rgba(255, 255, 255, 0.8) 100%);
            pointer-events: none;
        }

        /* OCEAN THEME: Parallax Waves */
        .ocean-wave {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 200%;
            height: 100px;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3E%3Cpath fill='%230099ff' fill-opacity='0.2' d='M0,192L48,197.3C96,203,192,213,288,229.3C384,245,480,267,576,250.7C672,235,768,181,864,181.3C960,181,1056,235,1152,234.7C1248,235,1344,181,1392,154.7L1440,128L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: repeat-x;
            background-size: 50% 100%;
        }

        /* SUNSHINE THEME: Rotating Rays */
        .sun-rays {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 150vmax;
            height: 150vmax;
            background: repeating-conic-gradient(from 0deg, rgba(255, 200, 0, 0.05) 0deg 10deg, transparent 10deg 20deg);
            transform: translate(-50%, -50%);
            border-radius: 50%;
            pointer-events: none;
        }

        /* MIDNIGHT THEME: Shooting Stars */
        .bg-midnight {
            background: linear-gradient(to bottom, #0f172a, #1e1b4b);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .shooting-star {
            position: absolute;
            top: 0;
            left: 50%;
            width: 100px;
            height: 1px;
            background: linear-gradient(90deg, white, transparent);
            opacity: 0;
            filter: drop-shadow(0 0 6px white);
        }

        /* Cake Animations */
        @keyframes flicker {

            0%,
            100% {
                transform: translateX(-50%) scale(1);
                opacity: 1;
            }

            50% {
                transform: translateX(-50%) scale(1.1);
                opacity: 0.9;
            }
        }

        .animate-flicker {
            animation: flicker 0.5s infinite alternate;
        }

        /* UI Elements */
        .btn-gift {
            background: #FF0055;
            box-shadow: 0 4px 14px 0 rgba(255, 0, 85, 0.39);
            transition: all 0.2s ease;
        }

        .btn-gift:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 0, 85, 0.23);
        }

        .theme-card.active div:first-child {
            border: 2px solid #FF0055;
            transform: scale(1.05);
        }

        .theme-card.active .check-icon {
            display: flex;
        }
    </style>
</head>

<body class="bg-brand-bg text-gray-800 selection:bg-pink-100 selection:text-brand-pink">

    <script src="config.js"></script>

    <div id="toast-container"></div>

    <div id="ceremony-overlay"
        class="fixed inset-0 bg-black z-[100] hidden flex-col items-center justify-center text-white text-center p-8 transition-opacity duration-1000">
        <div id="ceremony-text"
            class="text-2xl md:text-4xl font-cursive opacity-0 transition-opacity duration-1000 leading-relaxed">
        </div>
        <div id="mic-permission-ui" class="hidden flex-col items-center animate-fade-in mt-8">
            <div
                class="w-16 h-16 rounded-full bg-white/10 flex items-center justify-center mb-4 text-2xl animate-pulse">
                üé§</div>
            <p class="mb-6 text-gray-300">We need to hear you blow out the candles.</p>
            <button onclick="startMicSequence()"
                class="px-8 py-3 bg-white text-black font-bold rounded-full hover:scale-105 transition">Enable Magic
                ‚ú®</button>
            <button onclick="skipMic()" class="mt-4 text-sm text-gray-500 hover:text-white transition">No thanks, I'll
                tap</button>
        </div>
    </div>

    <nav class="fixed top-0 w-full bg-white/90 backdrop-blur-md shadow-sm z-40 h-16 transition-all" id="navbar">
        <div class="max-w-6xl mx-auto px-4 h-full flex items-center justify-between">
            <a href="/" data-link class="flex items-center gap-2 group">
                <img src="logo.png" alt="WishLink Logo" class="h-8 w-auto group-hover:scale-105 transition">
                <span class="text-xl font-bold text-brand-navy tracking-tight hidden md:inline">WishLink<span
                        class="text-brand-pink">.app</span></span>
            </a>

            <div class="flex items-center gap-3 md:gap-6 text-sm font-semibold">
                <a href="/create" data-link
                    class="px-4 py-2 bg-white border border-brand-pink text-brand-pink rounded-full hover:bg-pink-50 transition shadow-sm text-xs md:text-sm whitespace-nowrap gap-2 flex items-center">
                    <i class="fas fa-wand-magic-sparkles"></i> Gift Wish
                </a>
                <button onclick="payForCoffee(50)"
                    class="text-brand-navy hover:text-brand-pink transition px-2 text-lg"><i
                        class="fas fa-coffee"></i></button>
                <button id="nav-login" onclick="navigateTo('/login')"
                    class="text-brand-navy hover:text-brand-pink transition px-2">Login</button>
                <button id="nav-dash" onclick="navigateTo('/dashboard')"
                    class="hidden text-brand-navy hover:text-brand-pink transition flex items-center gap-2"><i
                        class="fas fa-user-circle text-lg"></i> <span class="hidden md:inline">Dashboard</span></button>
                <button id="nav-logout" onclick="handleLogout()"
                    class="hidden text-red-400 hover:text-red-600 transition px-2"><i
                        class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
    </nav>

    <main class="pt-16 min-h-screen flex flex-col">

        <div id="view-home" class="block animate-fade-in">
            <section class="bg-gradient-to-b from-purple-50 via-white to-white pt-24 pb-20 px-4 text-center">
                <span
                    class="px-4 py-1.5 bg-pink-100 text-brand-pink rounded-full text-[10px] md:text-xs font-bold tracking-wider uppercase mb-6 inline-block shadow-sm animate-slide-up">100%
                    Free Forever</span>
                <h1 class="text-4xl md:text-6xl font-extrabold text-brand-navy mb-6 leading-tight animate-slide-up"
                    style="animation-delay: 0.1s;">Make Their Birthday <br> <span
                        class="text-transparent bg-clip-text bg-gradient-to-r from-brand-pink to-brand-navy">Unforgettable</span>
                </h1>
                <p class="text-base md:text-lg text-gray-600 max-w-2xl mx-auto mb-10 leading-relaxed px-4 animate-slide-up"
                    style="animation-delay: 0.2s;">Create a personalized, interactive birthday website in 30 seconds.
                    Send a link that plays music, blows candles, and delivers your love.</p>
                <div class="flex flex-col sm:flex-row gap-4 justify-center px-8 animate-slide-up"
                    style="animation-delay: 0.3s;">
                    <button onclick="navigateTo('/create')"
                        class="btn-gift px-8 py-4 text-white rounded-full font-bold text-lg shadow-xl hover:shadow-2xl">Gift
                        this Wish üéÅ</button>
                </div>
                <div class="mt-20 max-w-4xl mx-auto bg-white rounded-3xl shadow-2xl overflow-hidden border-[6px] border-white transform -rotate-1 hover:rotate-0 transition duration-700 ease-out cursor-pointer group"
                    onclick="navigateTo('/create')">
                    <div class="bg-gray-100 h-10 flex items-center px-4 gap-2 border-b border-gray-200">
                        <div class="w-3 h-3 bg-red-400 rounded-full"></div>
                        <div class="w-3 h-3 bg-yellow-400 rounded-full"></div>
                        <div class="w-3 h-3 bg-green-400 rounded-full"></div>
                    </div>
                    <div
                        class="h-64 md:h-96 bg-gray-50 flex flex-col items-center justify-center text-gray-300 relative overflow-hidden">
                        <div
                            class="absolute inset-0 bg-gradient-to-br from-purple-50 to-pink-50 opacity-0 group-hover:opacity-100 transition duration-500">
                        </div>
                        <i
                            class="fas fa-birthday-cake text-6xl opacity-50 mb-3 group-hover:scale-110 transition duration-500 text-brand-pink"></i>
                        <p class="font-bold opacity-50 group-hover:opacity-100 group-hover:text-brand-navy transition">
                            Tap to Create Yours</p>
                    </div>
                </div>
            </section>
        </div>

        <div id="view-login" class="hidden flex items-center justify-center flex-1 px-4 animate-fade-in bg-gray-50">
            <div class="bg-white p-10 rounded-3xl shadow-2xl max-w-sm w-full text-center border border-gray-100">
                <div
                    class="w-16 h-16 bg-pink-100 text-brand-pink rounded-full flex items-center justify-center mx-auto mb-6 text-2xl shadow-lg">
                    <i class="fas fa-heart"></i></div>
                <h2 class="text-3xl font-bold mb-2 text-brand-navy">Welcome Back!</h2>
                <button onclick="handleLogin()"
                    class="w-full py-3.5 px-4 mt-8 border border-gray-300 rounded-xl flex items-center justify-center gap-3 hover:bg-gray-50 transition group bg-white">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5">
                    <span class="font-bold text-gray-700">Continue with Google</span>
                </button>
            </div>
        </div>

        <div id="view-dashboard" class="hidden max-w-4xl mx-auto px-4 py-10 w-full animate-fade-in">
            <div class="flex justify-between items-end mb-8">
                <div>
                    <h2 class="text-3xl font-bold text-brand-navy">My Wishes</h2>
                    <p class="text-gray-500 text-sm mt-1">Manage the love you've shared</p>
                </div>
                <a href="/create" data-link
                    class="px-5 py-2.5 bg-brand-pink text-white rounded-xl font-bold shadow-md hover:bg-pink-700 text-sm flex items-center gap-2"><i
                        class="fas fa-plus"></i> New Wish</a>
            </div>
            <div id="premium-banner"
                class="bg-gradient-to-r from-yellow-400 to-orange-400 p-6 rounded-2xl text-white flex justify-between items-center mb-10 shadow-lg">
                <div>
                    <h3 class="font-bold text-lg flex items-center gap-2"><i class="fas fa-crown text-yellow-100"></i>
                        Go Premium</h3>
                    <p class="text-white/90 text-sm mt-1">Unlock "Blow to Extinguish" & Premium Themes.</p>
                </div>
                <button onclick="buyPremium()"
                    class="bg-white text-orange-500 px-5 py-2.5 rounded-xl font-bold text-sm hover:bg-orange-50 shadow-sm transition">Upgrade
                    $1</button>
            </div>
            <div id="my-wishes-list" class="grid gap-4"></div>
        </div>

        <div id="view-create" class="hidden max-w-2xl mx-auto px-4 py-10 w-full animate-fade-in">
            <div class="bg-white rounded-3xl shadow-xl p-6 md:p-10 border border-gray-100">
                <h2 class="text-3xl font-bold text-brand-navy mb-8 text-center">Create a New Wish ‚ú®</h2>
                <form id="create-form" class="space-y-8">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1 ml-1">Who is it for?</label>
                        <input type="text" id="recipient" required placeholder="e.g., Sarah"
                            class="w-full px-5 py-4 bg-white border border-gray-200 rounded-xl focus:ring-4 focus:ring-brand-pink/20 outline-none transition font-semibold">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-700 mb-1 ml-1">Your Message</label>
                        <textarea id="message" required rows="4" placeholder="Write something sweet..."
                            class="w-full px-5 py-4 bg-white border border-gray-200 rounded-xl focus:ring-4 focus:ring-brand-pink/20 outline-none transition"></textarea>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-700 mb-4 ml-1">Choose a Theme</label>
                        <div class="grid grid-cols-3 gap-4">
                            <div class="theme-card active cursor-pointer group relative" data-theme="classic">
                                <div
                                    class="h-24 bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl opacity-80 transition-all duration-300 group-hover:opacity-100">
                                </div>
                                <div class="check-icon absolute inset-0 flex items-center justify-center hidden">
                                    <div
                                        class="bg-white text-brand-pink rounded-full w-8 h-8 flex items-center justify-center shadow-md">
                                        <i class="fas fa-check"></i></div>
                                </div>
                                <div class="theme-label text-center text-xs mt-2 font-bold text-gray-400">Classic</div>
                            </div>
                            <div class="theme-card cursor-pointer group relative" data-theme="ocean">
                                <div
                                    class="h-24 bg-gradient-to-br from-blue-400 to-cyan-500 rounded-xl opacity-80 transition-all duration-300 group-hover:opacity-100">
                                </div>
                                <div class="check-icon absolute inset-0 flex items-center justify-center hidden">
                                    <div
                                        class="bg-white text-brand-pink rounded-full w-8 h-8 flex items-center justify-center shadow-md">
                                        <i class="fas fa-check"></i></div>
                                </div>
                                <div class="theme-label text-center text-xs mt-2 font-bold text-gray-400">Ocean</div>
                            </div>
                            <div class="theme-card cursor-pointer group relative" data-theme="sunshine">
                                <div
                                    class="h-24 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-xl opacity-80 transition-all duration-300 group-hover:opacity-100">
                                </div>
                                <div class="check-icon absolute inset-0 flex items-center justify-center hidden">
                                    <div
                                        class="bg-white text-brand-pink rounded-full w-8 h-8 flex items-center justify-center shadow-md">
                                        <i class="fas fa-check"></i></div>
                                </div>
                                <div class="theme-label text-center text-xs mt-2 font-bold text-gray-400">Sunshine</div>
                            </div>
                            <div class="theme-card relative group cursor-pointer overflow-hidden rounded-xl"
                                data-theme="midnight">
                                <div
                                    class="premium-lock absolute inset-0 bg-black/60 z-20 flex items-center justify-center backdrop-blur-[2px]">
                                    <i class="fas fa-lock text-white"></i></div>
                                <div class="h-24 bg-slate-900 rounded-xl opacity-80 group-hover:opacity-100 transition">
                                </div>
                                <div class="check-icon absolute inset-0 flex items-center justify-center hidden z-10">
                                    <div
                                        class="bg-white text-brand-pink rounded-full w-8 h-8 flex items-center justify-center shadow-md">
                                        <i class="fas fa-check"></i></div>
                                </div>
                                <div class="theme-label text-center text-xs mt-2 font-bold text-gray-500">Midnight üåô
                                </div>
                            </div>
                            <div class="theme-card relative group cursor-pointer overflow-hidden rounded-xl"
                                data-theme="love">
                                <div
                                    class="premium-lock absolute inset-0 bg-black/60 z-20 flex items-center justify-center backdrop-blur-[2px]">
                                    <i class="fas fa-lock text-white"></i></div>
                                <div class="h-24 bg-rose-500 rounded-xl opacity-80 group-hover:opacity-100 transition">
                                </div>
                                <div class="check-icon absolute inset-0 flex items-center justify-center hidden z-10">
                                    <div
                                        class="bg-white text-brand-pink rounded-full w-8 h-8 flex items-center justify-center shadow-md">
                                        <i class="fas fa-check"></i></div>
                                </div>
                                <div class="theme-label text-center text-xs mt-2 font-bold text-gray-500">Love ‚ù§Ô∏è</div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2 ml-1">Add a Photo</label>
                        <input type="file" id="image-upload" accept="image/*" onchange="updateFileName(this)"
                            class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-bold file:bg-pink-50 file:text-brand-pink hover:file:bg-pink-100" />
                        <p id="file-upload-text" class="text-xs text-gray-400 mt-2 ml-1">Supports JPG/PNG.</p>
                    </div>
                    <button type="submit" id="submit-btn"
                        class="w-full py-4 btn-gift text-white rounded-xl font-bold text-lg flex items-center justify-center gap-2 mt-8">Gift
                        this Wish üéÅ</button>
                </form>
            </div>
        </div>

        <div id="view-wish" class="hidden min-h-screen animate-fade-in w-full relative overflow-hidden">
            <div id="theme-bg-layer" class="absolute inset-0 z-0"></div> <canvas id="confetti-canvas"
                class="absolute inset-0 w-full h-full pointer-events-none z-20"></canvas>

            <div class="relative z-10 flex flex-col items-center justify-center min-h-screen p-4 text-center">
                <div id="phase-1" class="animate-fade-in">
                    <div
                        class="text-white text-sm md:text-lg font-bold tracking-[0.2em] mb-4 opacity-90 uppercase text-shadow-sm">
                        It's a Special Day</div>
                    <h1 id="wish-recipient-display"
                        class="text-5xl md:text-7xl font-extrabold text-white mb-8 drop-shadow-lg font-cursive leading-tight">
                    </h1>

                    <div class="cake-container relative mt-10 mb-20 cursor-pointer group transition-transform hover:scale-105 duration-300"
                        id="cake-interaction">
                        <div
                            class="plate absolute bottom-0 w-64 h-4 bg-white rounded-full shadow-lg left-1/2 transform -translate-x-1/2 opacity-50">
                        </div>
                        <div
                            class="cake-body w-48 h-32 bg-pink-300 mx-auto rounded-lg relative shadow-2xl flex items-center justify-center">
                            <div class="absolute w-full h-4 bg-pink-400 top-1/2 transform -translate-y-1/2"></div>
                            <div class="icing absolute -top-4 w-52 h-10 bg-white rounded-full shadow-sm"></div>
                        </div>
                        <div
                            class="candle absolute -top-16 left-1/2 transform -translate-x-1/2 w-4 h-16 bg-red-400 border-2 border-red-500 rounded">
                            <div class="stripe w-full h-2 bg-white mt-2 transform -skew-y-12 opacity-50"></div>
                        </div>
                        <div id="flame"
                            class="flame absolute -top-24 left-1/2 transform -translate-x-1/2 w-6 h-8 bg-yellow-400 rounded-full shadow-[0_0_20px_#ffcc00] animate-flicker">
                            <div class="w-2 h-4 bg-white opacity-50 rounded-full mx-auto mt-2"></div>
                        </div>
                        <div id="tap-instruction"
                            class="mt-8 text-white text-sm font-bold bg-black/20 px-4 py-2 rounded-full inline-block backdrop-blur-sm animate-bounce">
                            üëá Tap candle to wish!</div>
                    </div>
                </div>

                <div id="phase-2"
                    class="hidden max-w-2xl w-full mx-auto transform translate-y-20 opacity-0 transition-all duration-1000">
                    <div id="wish-card-inner"
                        class="bg-white/90 backdrop-blur-xl rounded-3xl p-8 md:p-12 shadow-2xl border-4 border-white/50 relative overflow-hidden">
                    </div>
                    <div class="mt-10">
                        <a href="/create" data-link
                            class="inline-block px-8 py-3 bg-white text-brand-pink rounded-full font-bold shadow-lg hover:scale-105 transition transform text-sm md:text-base ring-4 ring-brand-pink/30">Create
                            your own WishLink üéÅ</a>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-admin" class="hidden max-w-6xl mx-auto px-4 py-10 w-full animate-fade-in">
            <h2 class="text-2xl font-bold mb-4 text-brand-navy">Admin Dashboard</h2>
            <div class="bg-white p-6 rounded-xl shadow">
                <div id="admin-stats" class="text-xl font-bold">Loading...</div>
            </div>
        </div>
    </main>

    <footer class="bg-gray-900 text-gray-400 py-10 text-center mt-auto border-t border-gray-800">
        <div class="flex items-center justify-center gap-2 mb-6">
            <span class="font-bold text-white tracking-wide">WishLink</span>
        </div>
        <div class="flex justify-center gap-6 text-sm font-medium mb-6">
            <a href="#" onclick="payForCoffee(50)" class="hover:text-white transition">Buy us a Coffee ‚òï</a>
        </div>
        <p class="text-xs text-gray-600">&copy; 2025 WishLink.</p>
    </footer>

    <audio id="bg-music" loop>
        <source src="h-bday.mp3" type="audio/mpeg">
    </audio>
    <audio id="cheer-audio">
        <source src="https://notificationsounds.com/storage/sounds/file-sounds-1235-victory.mp3" type="audio/mpeg">
    </audio>

    <script>
        // --- CONFIG CHECK ---
        if (typeof CONFIG === 'undefined') { console.error("config.js missing"); alert("Config missing"); }

        // --- GLOBAL STATE ---
        let supabase, currentUser = null;
        let selectedTheme = 'classic';
        let isMicActive = false;
        let audioContext, microphone, analyser;
        let currentWishIsPremium = false; // Determined when loading a wish

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            supabase = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);

            // Auth Listener
            supabase.auth.onAuthStateChange((event, session) => {
                currentUser = session?.user || null;
                updateNavbar();
                if (currentUser && window.location.pathname === '/login') navigateTo('/dashboard');
            });
            supabase.auth.getSession().then(({ data: { session } }) => {
                currentUser = session?.user || null;
                updateNavbar();
            });

            // UI Listeners
            initThemeSelection();
            const form = document.getElementById('create-form');
            if (form) form.addEventListener('submit', handleFormSubmit);

            // Router Start
            router();
        });

        // --- ROUTER (History API) ---
        const navigateTo = (url) => { history.pushState(null, null, url); router(); };
        window.addEventListener("popstate", router);
        document.addEventListener("click", e => {
            const link = e.target.closest("[data-link]");
            if (link) { e.preventDefault(); navigateTo(link.getAttribute("href")); }
        });

        async function router() {
            stopAllAudio(); // Silence on nav
            stopMic(); // Safety kill mic

            const path = window.location.pathname;
            const routes = { "/": "view-home", "/create": "view-create", "/login": "view-login", "/dashboard": "view-dashboard", "/admin": "view-admin" };

            let viewId = routes[path] || "view-home";
            let wishId = null;

            if (path.startsWith("/wish/")) {
                viewId = "view-wish";
                wishId = path.split("/")[2];
            }

            // View Switching
            document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
            const activeEl = document.getElementById(viewId);
            if (activeEl) {
                activeEl.classList.remove('hidden');
                activeEl.classList.add('animate-fade-in');
                window.scrollTo(0, 0);
            }

            checkPremiumStatus();
            updateNavbar();

            if (viewId === 'view-wish' && wishId) {
                loadWish(wishId);
            } else if (viewId === 'view-dashboard') {
                loadDashboard();
            }
        }

        // --- NAVBAR ---
        function updateNavbar() {
            const navLogin = document.getElementById('nav-login');
            const navDash = document.getElementById('nav-dash');
            const navLogout = document.getElementById('nav-logout');
            const path = window.location.pathname;

            if (currentUser) {
                navLogin.classList.add('hidden');
                navDash.classList.remove('hidden');
                navLogout.classList.remove('hidden');
            } else {
                if (path === '/login') navLogin.classList.add('hidden'); else navLogin.classList.remove('hidden');
                navDash.classList.add('hidden');
                navLogout.classList.add('hidden');
            }
        }

        // --- PREMIUM BLOW FEATURE LOGIC ---

        function initCeremony() {
            // Called when the Wish Page Loads if Premium
            const overlay = document.getElementById('ceremony-overlay');
            const text = document.getElementById('ceremony-text');
            const micUI = document.getElementById('mic-permission-ui');

            overlay.classList.remove('hidden');
            overlay.classList.add('flex');
            text.style.opacity = '1';

            // Step 1: Close Eyes
            text.innerHTML = "Close your eyes...";

            setTimeout(() => {
                // Step 2: Make Wish
                text.style.opacity = '0';
                setTimeout(() => {
                    text.innerHTML = "Make a wish...";
                    text.style.opacity = '1';

                    setTimeout(() => {
                        // Step 3: Ask for Mic
                        text.style.opacity = '0';
                        setTimeout(() => {
                            text.innerHTML = "";
                            micUI.classList.remove('hidden');
                            micUI.classList.add('flex');
                        }, 1000);
                    }, 3000); // 3s for wish
                }, 1000);
            }, 3000); // 3s for closing eyes
        }

        async function startMicSequence() {
            const micUI = document.getElementById('mic-permission-ui');
            const text = document.getElementById('ceremony-text');

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                microphone = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                microphone.connect(analyser);

                isMicActive = true;

                // Hide UI, Show "Blow"
                micUI.classList.add('hidden');
                text.innerHTML = "Now...<br>Blow out the candles!";
                text.style.opacity = '1';

                // Transition to Cake View
                setTimeout(() => {
                    document.getElementById('ceremony-overlay').classList.add('opacity-0');
                    setTimeout(() => {
                        document.getElementById('ceremony-overlay').classList.add('hidden');
                        document.getElementById('tap-instruction').innerHTML = "üå¨Ô∏è Blow into your mic!";
                        detectBlow();
                    }, 1000);
                }, 2000);

            } catch (err) {
                console.error("Mic denied:", err);
                skipMic(); // Fallback
            }
        }

        function skipMic() {
            document.getElementById('ceremony-overlay').classList.add('hidden');
            // Fallback to tap
        }

        function detectBlow() {
            if (!isMicActive) return;
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);

            // Calculate average volume
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) sum += dataArray[i];
            let average = sum / dataArray.length;

            // Threshold for "Blowing" (usually > 40-50 depends on device)
            if (average > 45) {
                blowCandle(); // Trigger success
            } else {
                requestAnimationFrame(detectBlow);
            }
        }

        function stopMic() {
            if (audioContext) audioContext.close();
            isMicActive = false;
        }

        // --- CORE ANIMATION & INTERACTION ---

        window.blowCandle = () => {
            const flame = document.getElementById('flame');
            if (!flame || flame.classList.contains('hidden')) return;

            // 1. Logic
            stopMic(); // Stop listening
            flame.classList.add('hidden'); // Extinguish

            // 2. Audio
            const bgMusic = document.getElementById('bg-music');
            const cheer = document.getElementById('cheer-audio');
            bgMusic.currentTime = 0;
            cheer.volume = 1.0;
            cheer.play();
            setTimeout(() => { bgMusic.volume = 0.5; bgMusic.play(); }, 1500);

            // 3. Visuals
            startConfetti();
            const p1 = document.getElementById('phase-1');
            const p2 = document.getElementById('phase-2');

            p1.classList.add('fade-out');
            setTimeout(() => {
                p1.classList.add('hidden');
                p2.classList.remove('hidden');
                setTimeout(() => {
                    p2.classList.remove('translate-y-20', 'opacity-0');
                    p2.classList.add('bounce-in');
                }, 100);
            }, 600);
        };

        // Tap fallback
        document.getElementById('cake-interaction').addEventListener('click', blowCandle);

        // --- WISH LOADING ---
        async function loadWish(id) {
            const recipientEl = document.getElementById('wish-recipient-display');
            const cardInner = document.getElementById('wish-card-inner');
            const bgLayer = document.getElementById('theme-bg-layer');
            const viewWish = document.getElementById('view-wish');

            recipientEl.innerText = "Loading...";

            try {
                const { data, error } = await supabase.from('wishes').select('*').eq('id', id).single();
                if (error || !data) throw new Error("Wish not found");

                // Set Data
                recipientEl.innerText = `Happy Birthday ${data.recipient_name}!`;

                let mediaHtml = '';
                if (data.image_url) {
                    mediaHtml = `<img src="${data.image_url}" class="w-32 h-32 rounded-full mx-auto mb-6 object-cover border-4 border-white/50 shadow-lg transform hover:scale-105 transition duration-500">`;
                }

                cardInner.innerHTML = `
                    <div class="absolute top-0 right-0 p-4 opacity-10 text-4xl">üéâ</div>
                    <div class="absolute bottom-0 left-0 p-4 opacity-10 text-4xl">üéÇ</div>
                    ${mediaHtml}
                    <p class="text-2xl md:text-4xl text-brand-navy font-cursive leading-relaxed mb-8">"${data.message}"</p>
                    <div class="flex items-center justify-center gap-3 text-sm text-gray-500 font-bold tracking-widest uppercase mb-4">
                        <span class="h-px w-8 bg-gray-300"></span> With Love <span class="h-px w-8 bg-gray-300"></span>
                    </div>
                `;

                // Apply Theme Logic
                applyTheme(data.theme);

                // Premium Logic Check (Simulated for demo - in real app check creator's sub status)
                // For now, we assume Love/Midnight are "Premium"
                if (data.theme === 'love' || data.theme === 'midnight') {
                    currentWishIsPremium = true;
                    initCeremony();
                } else {
                    currentWishIsPremium = false;
                    document.getElementById('ceremony-overlay').classList.add('hidden');
                }

            } catch (e) {
                console.error(e);
                recipientEl.innerText = "Wish Not Found üíî";
            }
        }

        function applyTheme(theme) {
            const view = document.getElementById('view-wish');
            const bg = document.getElementById('theme-bg-layer');
            const card = document.getElementById('wish-card-inner');

            // Reset
            view.className = "hidden min-h-screen animate-fade-in w-full relative overflow-hidden";
            bg.className = "absolute inset-0 z-0";
            bg.innerHTML = "";

            if (theme === 'love') {
                view.classList.add('bg-love');
                // Pulse handled by CSS
            } else if (theme === 'ocean') {
                view.classList.add('bg-gradient-to-b', 'from-sky-300', 'to-blue-500');
                bg.innerHTML = '<div class="ocean-wave animate-wave"></div><div class="ocean-wave animate-wave-slow" style="opacity: 0.5; bottom: 10px; animation-direction: reverse;"></div>';
            } else if (theme === 'sunshine') {
                view.classList.add('bg-gradient-to-br', 'from-yellow-300', 'to-orange-500');
                bg.innerHTML = '<div class="sun-rays animate-spin-slow"></div>';
            } else if (theme === 'midnight') {
                view.classList.add('bg-midnight', 'theme-midnight');
                bg.innerHTML = '<div class="shooting-star animate-shooting-star" style="top: 20%; left: 20%;"></div><div class="shooting-star animate-shooting-star" style="top: 50%; left: 60%; animation-delay: 4s;"></div>';
                // Stars
                for (let i = 0; i < 30; i++) {
                    const s = document.createElement('div');
                    s.className = 'absolute bg-white rounded-full opacity-50 animate-pulse-slow';
                    s.style.width = Math.random() * 3 + 'px';
                    s.style.height = s.style.width;
                    s.style.top = Math.random() * 100 + '%';
                    s.style.left = Math.random() * 100 + '%';
                    bg.appendChild(s);
                }
            } else {
                // Classic
                view.classList.add('bg-gradient-to-br', 'from-purple-500', 'to-pink-500');
            }
        }

        // --- UTILS & HELPERS ---
        function stopAllAudio() {
            const bg = document.getElementById('bg-music');
            const ch = document.getElementById('cheer-audio');
            bg.pause(); bg.currentTime = 0;
            ch.pause(); ch.currentTime = 0;
        }

        function checkPremiumStatus() {
            if (!currentUser) return;
            const isPrem = localStorage.getItem('is_premium_' + currentUser.id) === 'true';
            if (isPrem) {
                document.querySelectorAll('.premium-lock').forEach(e => e.classList.add('hidden'));
                const b = document.getElementById('premium-banner');
                if (b) b.style.display = 'none';
            }
        }

        function buyPremium() {
            // Placeholder for Razorpay
            alert("Razorpay would open here. Simulator: Premium Unlocked!");
            if (currentUser) localStorage.setItem('is_premium_' + currentUser.id, 'true');
            checkPremiumStatus();
            loadDashboard();
        }

        // Confetti
        function startConfetti() {
            const c = document.getElementById('confetti-canvas');
            const ctx = c.getContext('2d');
            c.width = window.innerWidth; c.height = window.innerHeight;
            const p = Array.from({ length: 150 }).map(() => ({
                x: Math.random() * c.width, y: Math.random() * c.height - c.height,
                c: ['#f00', '#0f0', '#00f', '#ff0'][Math.floor(Math.random() * 4)],
                s: Math.random() * 5 + 5, d: Math.random() * 5 + 2
            }));
            function step() {
                ctx.clearRect(0, 0, c.width, c.height);
                p.forEach(k => {
                    k.y += k.d; k.x += Math.sin(k.y / 50);
                    ctx.fillStyle = k.c; ctx.fillRect(k.x, k.y, k.s, k.s);
                    if (k.y > c.height) k.y = -10;
                });
                requestAnimationFrame(step);
            }
            step();
        }

        // Auth & DB (Simplified for brevity)
        async function handleLogin() { await supabase.auth.signInWithOAuth({ provider: 'google', options: { redirectTo: window.location.origin } }); }
        async function handleLogout() { await supabase.auth.signOut(); navigateTo('/'); }

        async function loadDashboard() {
            if (!currentUser) return;
            const list = document.getElementById('my-wishes-list');
            list.innerHTML = "Loading...";
            const { data } = await supabase.from('wishes').select('*').eq('creator_id', currentUser.id).order('created_at', { ascending: false });
            list.innerHTML = "";
            if (!data || !data.length) list.innerHTML = "<p class='text-center text-gray-400'>No wishes yet.</p>";
            else data.forEach(w => {
                list.innerHTML += `<div class="bg-white p-4 rounded-xl shadow border flex justify-between"><div><b>${w.recipient_name}</b><br><a href="/wish/${w.id}" data-link class="text-brand-pink text-xs">View</a></div></div>`;
            });
        }

        function initThemeSelection() {
            document.querySelectorAll('.theme-card').forEach(c => c.addEventListener('click', () => {
                if (c.querySelector('.premium-lock:not(.hidden)')) return alert("Upgrade to Premium!");
                document.querySelectorAll('.theme-card').forEach(x => x.classList.remove('active'));
                c.classList.add('active');
                selectedTheme = c.dataset.theme;
            }));
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            if (!currentUser) return navigateTo('/login');

            const btn = document.getElementById('submit-btn');
            btn.disabled = true; btn.innerText = "Creating...";

            // Photo Upload would happen here (Cloudinary)
            // For now, simple insert
            const { data, error } = await supabase.from('wishes').insert([{
                recipient_name: document.getElementById('recipient').value,
                message: document.getElementById('message').value,
                theme: selectedTheme,
                creator_id: currentUser.id
            }]).select().single();

            if (!error) {
                // Show modal with share link
                alert("Created! Share URL: " + window.location.origin + "/wish/" + data.id);
                navigateTo('/dashboard');
            } else {
                alert("Error: " + error.message);
            }
            btn.disabled = false; btn.innerText = "Gift this Wish üéÅ";
        }

        window.updateFileName = (input) => {
            document.getElementById('file-upload-text').innerText = input.files[0] ? input.files[0].name : "Supports JPG/PNG";
        }
    </script>
</body>

</html>