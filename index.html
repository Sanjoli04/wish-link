<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WishLink - Create Magic Moments</title>
    <link rel="icon" type="image/png" href="favicon.png">

    <!-- External SDKs -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { pink: '#FF0055', navy: '#002366', bg: '#F9FAFB' }
                    },
                    fontFamily: {
                        sans: ['Nunito', 'sans-serif'],
                        cursive: ['Nunito', 'cursive'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'slide-up': 'slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'bounce-in': 'bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55)',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        bounceIn: { '0%': { transform: 'scale(0)' }, '70%': { transform: 'scale(1.1)' }, '100%': { transform: 'scale(1)' } }
                    }
                }
            }
        }
    </script>

    <style>
        /* --- CORE STYLES --- */
        body {
            font-family: 'Nunito', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .font-cursive {
            font-weight: 800;
            font-style: italic;
        }

        html {
            scroll-behavior: smooth;
        }

        /* --- TOAST NOTIFICATIONS --- */
        #toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            pointer-events: auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 12px 24px;
            border-radius: 50px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            color: #002366;
            transform: translateY(-50px);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid rgba(255, 255, 255, 0.5);
            min-width: 300px;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            border-left: 4px solid #10b981;
        }

        .toast.error {
            border-left: 4px solid #ef4444;
        }

        /* --- ANIMATIONS & FX --- */
        .btn-gift {
            background: #FF0055;
            box-shadow: 0 4px 14px 0 rgba(255, 0, 85, 0.39);
            transition: all 0.2s ease;
        }

        .btn-gift:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 0, 85, 0.23);
        }

        .btn-gift:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn-gift:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        .theme-card {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .theme-card.active {
            border-color: #FF0055;
            transform: scale(1.02);
            box-shadow: 0 10px 25px -5px rgba(255, 0, 85, 0.25);
        }

        .theme-card.active .check-icon {
            display: flex;
        }

        /* Candle Flame Physics */
        .flame {
            transform-origin: center bottom;
            animation: flicker 3ms ease-in infinite alternate, move 3s infinite linear;
        }

        @keyframes flicker {
            0% {
                transform: scale(1);
                opacity: 0.9;
            }

            100% {
                transform: scale(1.1);
                opacity: 1;
            }
        }

        @keyframes move {
            0% {
                transform: skewX(2deg);
            }

            50% {
                transform: skewX(-2deg);
            }

            100% {
                transform: skewX(2deg);
            }
        }

        /* Premium Themes */
        .bg-love {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
        }

        .bg-midnight {
            background: radial-gradient(circle at bottom, #1b2735 0%, #090a0f 100%);
            color: white;
        }

        .floating-heart {
            position: absolute;
            animation: floatUp 8s linear infinite;
            pointer-events: none;
            opacity: 0;
        }

        @keyframes floatUp {
            0% {
                transform: translateY(100vh) scale(0.5);
                opacity: 0;
            }

            20% {
                opacity: 0.6;
            }

            100% {
                transform: translateY(-20vh) scale(1.2);
                opacity: 0;
            }
        }

        .star-twinkle {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle var(--duration) infinite;
            opacity: 0;
        }

        @keyframes twinkle {

            0%,
            100% {
                opacity: 0.2;
                transform: scale(0.8);
            }

            50% {
                opacity: 1;
                transform: scale(1.2);
                box-shadow: 0 0 10px white;
            }
        }
    </style>
</head>

<body
    class="bg-brand-bg text-gray-800 selection:bg-pink-100 selection:text-brand-pink overflow-x-hidden flex flex-col min-h-screen">

    <!-- LOAD CONFIG -->
    <script src="config.js"></script>

    <!-- TOAST CONTAINER -->
    <div id="toast-container"></div>

    <!-- NAVBAR -->
    <nav class="fixed top-0 w-full bg-white/90 backdrop-blur-md shadow-sm z-50 h-16 transition-all">
        <div class="max-w-6xl mx-auto px-4 h-full flex items-center justify-between">
            <a href="#home" class="flex items-center gap-2 group">
                <img src="logo.png" onerror="this.src='https://placehold.co/40'" alt="WishLink"
                    class="h-8 w-auto group-hover:scale-105 transition">
                <span class="text-xl font-bold text-brand-navy tracking-tight hidden md:inline">WishLink<span
                        class="text-brand-pink">.app</span></span>
            </a>
            <div class="flex items-center gap-3 md:gap-6 text-sm font-semibold">
                <!-- Action Button -->
                <a href="#create"
                    class="px-4 py-2 bg-white border border-brand-pink text-brand-pink rounded-full hover:bg-pink-50 transition shadow-sm text-xs md:text-sm whitespace-nowrap gap-2 flex items-center">
                    <i class="fas fa-wand-magic-sparkles"></i> Gift Wish
                </a>

                <!-- Coffee Button -->
                <button onclick="App.Services.buyCoffee(50)"
                    class="text-brand-navy hover:text-brand-pink transition px-2 text-lg" title="Buy us a Coffee">
                    <i class="fas fa-coffee"></i>
                </button>

                <!-- Auth State Controlled by JS -->
                <div id="nav-auth-container" class="flex items-center gap-4">
                    <!-- Injected by JS -->
                </div>
            </div>
        </div>
    </nav>

    <!-- MAIN APP CONTENT -->
    <main class="pt-16 flex-grow flex flex-col relative">

        <!-- VIEW: HOME -->
        <div id="view-home" class="view-section hidden">
            <section class="bg-gradient-to-b from-purple-50 via-white to-white pt-24 pb-20 px-4 text-center">
                <span
                    class="px-4 py-1.5 bg-pink-100 text-brand-pink rounded-full text-[10px] md:text-xs font-bold tracking-wider uppercase mb-6 inline-block shadow-sm animate-slide-up">100%
                    Free Forever</span>
                <h1 class="text-4xl md:text-6xl font-extrabold text-brand-navy mb-6 leading-tight animate-slide-up"
                    style="animation-delay: 0.1s;">
                    Make Their Birthday <br> <span
                        class="text-transparent bg-clip-text bg-gradient-to-r from-brand-pink to-brand-navy">Unforgettable</span>
                </h1>
                <p class="text-base md:text-lg text-gray-600 max-w-2xl mx-auto mb-10 leading-relaxed px-4 animate-slide-up"
                    style="animation-delay: 0.2s;">
                    Create a personalized, interactive birthday website in 30 seconds. Send a link that plays music,
                    blows candles, and delivers your love.
                </p>
                <div class="flex flex-col sm:flex-row gap-4 justify-center px-8 animate-slide-up"
                    style="animation-delay: 0.3s;">
                    <button onclick="App.Router.go('create')"
                        class="btn-gift px-8 py-4 text-white rounded-full font-bold text-lg shadow-xl">Gift this Wish
                        üéÅ</button>
                    <button onclick="App.Router.go('blog')"
                        class="px-8 py-4 bg-white text-gray-700 border border-gray-200 rounded-full font-bold hover:bg-gray-50 transition">Read
                        Ideas</button>
                </div>

                <!-- Demo Preview -->
                <div class="mt-20 max-w-4xl mx-auto bg-white rounded-3xl shadow-2xl overflow-hidden border-[6px] border-white transform -rotate-1 hover:rotate-0 transition duration-700 cursor-pointer group"
                    onclick="App.Router.go('create')">
                    <div class="bg-gray-100 h-10 flex items-center px-4 gap-2 border-b border-gray-200">
                        <div class="w-3 h-3 bg-red-400 rounded-full"></div>
                        <div class="w-3 h-3 bg-yellow-400 rounded-full"></div>
                        <div class="w-3 h-3 bg-green-400 rounded-full"></div>
                    </div>
                    <div
                        class="h-64 md:h-96 bg-gray-50 flex flex-col items-center justify-center text-gray-300 relative overflow-hidden group-hover:bg-gray-100 transition-colors">
                        <i
                            class="fas fa-birthday-cake text-6xl opacity-50 mb-3 text-brand-pink group-hover:scale-110 transition duration-500"></i>
                        <p class="font-bold opacity-50 text-brand-navy">Tap to Create Yours</p>
                    </div>
                </div>
            </section>
        </div>

        <!-- VIEW: LOGIN -->
        <div id="view-login"
            class="view-section hidden flex items-center justify-center flex-1 px-4 bg-gray-50 min-h-[80vh]">
            <div
                class="bg-white p-10 rounded-3xl shadow-xl max-w-sm w-full text-center border border-gray-100 animate-slide-up">
                <div
                    class="w-16 h-16 bg-pink-100 text-brand-pink rounded-full flex items-center justify-center mx-auto mb-6 text-2xl shadow-lg">
                    <i class="fas fa-heart"></i></div>
                <h2 class="text-3xl font-bold mb-2 text-brand-navy">Welcome Back!</h2>
                <p class="text-gray-500 mb-8 text-sm">Sign in to save your wishes forever.</p>
                <button onclick="App.Services.login()"
                    class="w-full py-3.5 px-4 border border-gray-300 rounded-xl flex items-center justify-center gap-3 hover:bg-gray-50 transition bg-white text-gray-700 font-bold">
                    <i class="fab fa-google text-red-500"></i> Continue with Google
                </button>
                <p class="text-[10px] text-gray-400 mt-6">By continuing, you agree to our Terms.</p>
            </div>
        </div>

        <!-- VIEW: DASHBOARD -->
        <div id="view-dashboard" class="view-section hidden max-w-4xl mx-auto px-4 py-10 w-full">
            <div class="flex justify-between items-end mb-8">
                <div>
                    <h2 class="text-3xl font-bold text-brand-navy">My Wishes</h2>
                    <p class="text-gray-500 text-sm mt-1">Manage the love you've shared</p>
                </div>
                <a href="#create"
                    class="px-5 py-2.5 bg-brand-pink text-white rounded-xl font-bold shadow-md hover:bg-pink-700 text-sm flex items-center gap-2 transition"><i
                        class="fas fa-plus"></i> New Wish</a>
            </div>

            <!-- Premium Banner -->
            <div id="premium-banner"
                class="hidden bg-gradient-to-r from-yellow-400 to-orange-400 p-6 rounded-2xl text-white flex justify-between items-center mb-10 shadow-lg">
                <div>
                    <h3 class="font-bold text-lg flex items-center gap-2"><i class="fas fa-crown text-yellow-100"></i>
                        Go Premium</h3>
                    <p class="text-white/90 text-sm mt-1">Unlock premium themes & remove ads for $1.</p>
                </div>
                <button onclick="App.Services.buyPremium()"
                    class="bg-white text-orange-500 px-5 py-2.5 rounded-xl font-bold text-sm hover:bg-orange-50 shadow-sm transition">Upgrade</button>
            </div>

            <div id="my-wishes-list" class="grid gap-4">
                <!-- Injected via JS -->
            </div>
        </div>

        <!-- VIEW: CREATE -->
        <div id="view-create" class="view-section hidden max-w-2xl mx-auto px-4 py-10 w-full">
            <div class="bg-white rounded-3xl shadow-xl p-6 md:p-10 border border-gray-100 animate-slide-up">
                <h2 class="text-3xl font-bold text-brand-navy mb-8 text-center">Create a New Wish ‚ú®</h2>
                <form id="create-form" class="space-y-6">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1 ml-1">Who is it for?</label>
                        <input type="text" id="recipient" required placeholder="e.g., Sarah"
                            class="w-full px-5 py-4 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-brand-pink focus:border-transparent outline-none transition font-semibold">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1 ml-1">Your Message</label>
                        <textarea id="message" required rows="4" placeholder="Write something sweet..."
                            class="w-full px-5 py-4 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-brand-pink outline-none transition"></textarea>
                    </div>

                    <!-- Theme Selector -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-4 ml-1">Choose a Theme</label>
                        <div class="grid grid-cols-3 gap-4" id="theme-selector">
                            <!-- Themes injected by JS to reduce HTML bloat -->
                        </div>
                    </div>

                    <!-- Image Upload -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2 ml-1">Add a Photo (Optional)</label>
                        <div class="relative group cursor-pointer">
                            <input type="file" id="image-upload" accept="image/*"
                                class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                            <div id="upload-preview"
                                class="w-full bg-gray-50 border-2 border-dashed border-gray-300 rounded-xl p-6 flex flex-col items-center justify-center group-hover:border-brand-pink group-hover:bg-pink-50 transition-all">
                                <div
                                    class="w-12 h-12 bg-white rounded-full flex items-center justify-center mb-3 shadow-sm text-gray-400">
                                    <i class="fas fa-camera text-xl"></i></div>
                                <p id="file-upload-text" class="text-sm text-gray-500 font-medium">Click to upload</p>
                            </div>
                        </div>
                    </div>

                    <button type="submit" id="submit-btn"
                        class="w-full py-4 btn-gift text-white rounded-xl font-bold text-lg flex items-center justify-center gap-2 mt-4">Gift
                        this Wish üéÅ</button>
                </form>
            </div>
        </div>

        <!-- VIEW: WISH (PUBLIC) -->
        <div id="view-wish" class="view-section hidden min-h-screen bg-gray-900 w-full relative overflow-hidden">
            <div id="wish-content"
                class="relative z-10 w-full h-full min-h-screen flex flex-col items-center justify-center">
                <!-- Dynamic Content -->
            </div>
            <!-- Canvas for Confetti -->
            <canvas id="confetti-canvas" class="absolute inset-0 w-full h-full pointer-events-none z-20"></canvas>
            <!-- Watermark -->
            <a href="#home"
                class="fixed bottom-4 right-4 bg-white/20 backdrop-blur-sm px-4 py-1.5 rounded-full text-white text-xs font-bold hover:bg-white/40 transition z-50 flex items-center gap-2">
                <span>Made with</span> <span class="font-cursive text-sm">WishLink</span>
            </a>
        </div>

        <!-- VIEW: BLOG (Placeholder) -->
        <div id="view-blog" class="view-section hidden max-w-4xl mx-auto px-4 py-10">
            <h2 class="text-3xl font-bold text-brand-navy mb-8">Birthday Ideas & Tips üí°</h2>
            <p class="text-gray-500">Coming soon...</p>
        </div>
    </main>

    <!-- FOOTER RESTORED -->
    <footer class="bg-gray-900 text-gray-400 py-10 text-center border-t border-gray-800 z-10 relative">
        <div class="flex items-center justify-center gap-2 mb-6">
            <img src="logo.png" onerror="this.src='https://placehold.co/20'" alt="Logo"
                class="h-6 w-auto brightness-0 invert">
            <span class="font-bold text-white tracking-wide">WishLink</span>
        </div>

        <div class="flex justify-center gap-6 text-sm font-medium mb-6">
            <button class="hover:text-white transition text-gray-400 hover:scale-105"
                onclick="App.Services.buyCoffee(50)">Buy us a Coffee ‚òï</button>
            <a href="#" class="hover:text-white transition text-gray-400 hover:scale-105">Privacy Policy</a>
            <a href="#" class="hover:text-white transition text-gray-400 hover:scale-105">Terms of Service</a>
        </div>
        <p class="text-xs text-gray-600">&copy; 2025 WishLink. Crafted with emotions.</p>
    </footer>

    <!-- AUDIO ELEMENTS -->
    <audio id="bg-music" loop preload="auto">
        <source src="h-bday.mp3" type="audio/mpeg">
    </audio>
    <audio id="cheer-audio" preload="auto">
        <source src="https://notificationsounds.com/storage/sounds/file-sounds-1235-victory.mp3" type="audio/mpeg">
    </audio>

    <!-- APP LOGIC -->
    <script>
        // --- APP NAMESPACE ---
        const App = {
            State: {
                user: null,
                isPremium: false,
                currentTheme: 'classic',
                audioContext: null,
                microphone: null,
                analyser: null,
                isBlowing: false
            },

            // --- UI UTILS & TOASTS ---
            UI: {
                toast(msg, type = 'success') {
                    const container = document.getElementById('toast-container');
                    const el = document.createElement('div');
                    el.className = `toast ${type}`;
                    const icon = type === 'error' ? 'fa-exclamation-circle' : 'fa-check-circle';
                    el.innerHTML = `<i class="fas ${icon} text-lg"></i><span>${msg}</span>`;
                    container.appendChild(el);

                    // Animate In
                    requestAnimationFrame(() => el.classList.add('show'));

                    // Remove
                    setTimeout(() => {
                        el.classList.remove('show');
                        setTimeout(() => el.remove(), 400);
                    }, 3000);
                },

                setLoading(btn, isLoading, text = 'Loading...') {
                    if (isLoading) {
                        btn.dataset.originalText = btn.innerHTML;
                        btn.disabled = true;
                        btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> ${text}`;
                    } else {
                        btn.disabled = false;
                        btn.innerHTML = btn.dataset.originalText || 'Submit';
                    }
                },

                renderThemes() {
                    const themes = [
                        { id: 'classic', name: 'Classic', color: 'from-purple-500 to-pink-500', premium: false },
                        { id: 'ocean', name: 'Ocean', color: 'from-blue-400 to-indigo-600', premium: false },
                        { id: 'sunshine', name: 'Sunshine', color: 'from-yellow-400 to-orange-500', premium: false },
                        { id: 'midnight', name: 'Midnight üåô', color: 'from-slate-900 to-slate-700', premium: true },
                        { id: 'love', name: 'Love ‚ù§Ô∏è', color: 'from-red-500 to-rose-600', premium: true }
                    ];

                    const container = document.getElementById('theme-selector');
                    if (!container) return;

                    container.innerHTML = themes.map(t => `
                        <div class="theme-card relative group cursor-pointer overflow-hidden rounded-xl h-24 ${App.State.currentTheme === t.id ? 'active' : ''}" 
                             onclick="App.Controllers.selectTheme('${t.id}', ${t.premium})">
                            <div class="absolute inset-0 bg-gradient-to-br ${t.color} opacity-80 group-hover:opacity-100 transition"></div>
                            ${t.premium ? `<div class="premium-lock absolute inset-0 bg-black/40 z-10 flex items-center justify-center ${App.State.isPremium ? 'hidden' : ''}"><i class="fas fa-lock text-white"></i></div>` : ''}
                            <div class="check-icon absolute inset-0 flex items-center justify-center ${App.State.currentTheme === t.id ? 'flex' : 'hidden'} z-20">
                                <div class="bg-white text-brand-pink rounded-full w-8 h-8 flex items-center justify-center shadow-md animate-bounce-in"><i class="fas fa-check"></i></div>
                            </div>
                            <div class="absolute bottom-2 w-full text-center text-white text-xs font-bold shadow-sm z-10">${t.name}</div>
                        </div>
                    `).join('');
                }
            },

            // --- SERVICES (Supabase, Uploads) ---
            Services: {
                supabase: null,

                init() {
                    if (typeof CONFIG === 'undefined') {
                        App.UI.toast('Config missing!', 'error');
                        return;
                    }
                    this.supabase = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);

                    // Auth Listener
                    this.supabase.auth.onAuthStateChange((event, session) => {
                        App.State.user = session?.user || null;
                        App.Controllers.updateNav();
                        App.Services.checkPremium();

                        // Handle Login Redirect
                        if (App.State.user && window.location.hash === '#login') {
                            const returnTo = sessionStorage.getItem('return_to') || 'dashboard';
                            sessionStorage.removeItem('return_to');
                            App.Router.go(returnTo);
                        }
                    });
                },

                async login() {
                    const { error } = await this.supabase.auth.signInWithOAuth({
                        provider: 'google',
                        options: { redirectTo: window.location.origin }
                    });
                    if (error) App.UI.toast(error.message, 'error');
                },

                async logout() {
                    await this.supabase.auth.signOut();
                    App.UI.toast('Logged out successfully');
                    App.Router.go('home');
                },

                async uploadImage(file) {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('upload_preset', CONFIG.CLOUDINARY_PRESET);

                    const res = await fetch(`https://api.cloudinary.com/v1_1/${CONFIG.CLOUDINARY_CLOUD_NAME}/image/upload`, { method: 'POST', body: formData });
                    if (!res.ok) throw new Error('Upload failed');
                    const data = await res.json();
                    return data.secure_url;
                },

                checkPremium() {
                    if (!App.State.user) return;
                    const isPrem = localStorage.getItem(`premium_${App.State.user.id}`) === 'true';
                    App.State.isPremium = isPrem;
                    // Update UI
                    if (isPrem) {
                        document.querySelectorAll('.premium-lock').forEach(el => el.classList.add('hidden'));
                        const banner = document.getElementById('premium-banner');
                        if (banner) banner.classList.add('hidden');
                    }
                },

                buyPremium() {
                    this.triggerPayment(4900, "WishLink Premium", "Unlock all themes", () => {
                        App.UI.toast("Payment Successful! Premium Unlocked üëë");
                        localStorage.setItem(`premium_${App.State.user.id}`, 'true');
                        App.Services.checkPremium();
                    });
                },

                buyCoffee(amount) {
                    this.triggerPayment(amount * 100, "Buy us a Coffee", "Thanks for your support! ‚òï", () => {
                        App.UI.toast("Thank you for the coffee! ‚ù§Ô∏è");
                    });
                },

                triggerPayment(amount, name, desc, successCallback) {
                    if (typeof Razorpay === 'undefined' || !CONFIG.RAZORPAY_KEY) {
                        alert("Payment Config Missing. Simulating success for demo.");
                        successCallback();
                        return;
                    }
                    const options = {
                        key: CONFIG.RAZORPAY_KEY, amount: amount, currency: "INR",
                        name: name, description: desc,
                        handler: function (response) { successCallback(); }
                    };
                    const rzp = new Razorpay(options);
                    rzp.open();
                }
            },

            // --- AUDIO & MIC ENGINE (The Upgrade) ---
            Audio: {
                startMusic() {
                    const bgMusic = document.getElementById('bg-music');
                    bgMusic.volume = 0.4;
                    bgMusic.play().catch(() => console.log('Autoplay blocked'));
                },

                stopAll() {
                    const bg = document.getElementById('bg-music');
                    const cheer = document.getElementById('cheer-audio');
                    bg.pause(); bg.currentTime = 0;
                    cheer.pause(); cheer.currentTime = 0;
                    this.stopMic();
                },

                async initMic(onBlow) {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        App.State.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        App.State.analyser = App.State.audioContext.createAnalyser();
                        App.State.microphone = App.State.audioContext.createMediaStreamSource(stream);
                        App.State.microphone.connect(App.State.analyser);
                        App.State.analyser.fftSize = 256;

                        const bufferLength = App.State.analyser.frequencyBinCount;
                        const dataArray = new Uint8Array(bufferLength);

                        const detectBlow = () => {
                            if (!App.State.audioContext) return;
                            App.State.analyser.getByteFrequencyData(dataArray);

                            // Blow detection logic: High energy in low frequencies
                            let sum = 0;
                            for (let i = 0; i < bufferLength; i++) sum += dataArray[i];
                            const average = sum / bufferLength;

                            if (average > 50) { // Threshold
                                onBlow();
                                this.stopMic();
                            } else {
                                requestAnimationFrame(detectBlow);
                            }
                        };
                        detectBlow();
                        App.UI.toast("Microphone Active! Blow on the screen üéÇ");
                    } catch (err) {
                        console.error("Mic error", err);
                        App.UI.toast("Microphone access denied. Tap the candle instead.", "error");
                    }
                },

                stopMic() {
                    if (App.State.audioContext) {
                        App.State.audioContext.close();
                        App.State.audioContext = null;
                    }
                }
            },

            // --- ROUTER (The Fix) ---
            Router: {
                init() {
                    window.addEventListener('hashchange', this.handleRoute.bind(this));
                    window.addEventListener('load', this.handleRoute.bind(this)); // Fix refresh issue
                },

                go(route) { window.location.hash = `#${route}`; },

                handleRoute() {
                    App.Audio.stopAll(); // Cleanup audio on nav

                    const hash = window.location.hash.slice(1) || 'home';
                    const [route, param] = hash.split('/');

                    // Hide all views
                    document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));

                    // Show active view
                    const activeView = document.getElementById(`view-${route}`);
                    if (activeView) {
                        activeView.classList.remove('hidden');
                        activeView.classList.add('animate-fade-in');
                        window.scrollTo(0, 0);
                    }

                    // Route Logic
                    if (route === 'dashboard') App.Controllers.loadDashboard();
                    if (route === 'create') App.UI.renderThemes();
                    if (route === 'wish' && param) App.Controllers.loadWish(param);
                    if (route === 'login' && App.State.user) this.go('dashboard');
                }
            },

            // --- CONTROLLERS (Business Logic) ---
            Controllers: {
                updateNav() {
                    const container = document.getElementById('nav-auth-container');
                    if (App.State.user) {
                        container.innerHTML = `
                            <button onclick="App.Router.go('dashboard')" class="text-brand-navy hover:text-brand-pink transition font-bold"><i class="fas fa-user-circle"></i> Dashboard</button>
                            <button onclick="App.Services.logout()" class="text-red-400 hover:text-red-600 transition"><i class="fas fa-sign-out-alt"></i></button>
                        `;
                    } else {
                        container.innerHTML = `<button onclick="App.Router.go('login')" class="text-brand-navy hover:text-brand-pink transition font-bold">Login</button>`;
                    }
                },

                selectTheme(id, isPremium) {
                    if (isPremium && !App.State.isPremium) {
                        App.UI.toast("This theme requires Premium upgrade üëë", "error");
                        return;
                    }
                    App.State.currentTheme = id;
                    App.UI.renderThemes();
                },

                async handleCreate(e) {
                    e.preventDefault();
                    if (!App.State.user) {
                        App.UI.toast("Please login to create a wish");
                        sessionStorage.setItem('return_to', 'create');
                        App.Router.go('login');
                        return;
                    }

                    const btn = document.getElementById('submit-btn');
                    App.UI.setLoading(btn, true, "Wrapping Gift...");

                    try {
                        const fileInput = document.getElementById('image-upload');
                        let imgUrl = null;

                        if (fileInput.files.length) {
                            App.UI.setLoading(btn, true, "Uploading Photo...");
                            imgUrl = await App.Services.uploadImage(fileInput.files[0]);
                        }

                        App.UI.setLoading(btn, true, "Finalizing...");

                        const { data, error } = await App.Services.supabase
                            .from('wishes')
                            .insert([{
                                recipient_name: document.getElementById('recipient').value,
                                message: document.getElementById('message').value,
                                theme: App.State.currentTheme,
                                image_url: imgUrl,
                                creator_id: App.State.user.id
                            }])
                            .select()
                            .single();

                        if (error) throw error;

                        // Show Success Modal
                        App.Controllers.showShareModal(data.id);
                        document.getElementById('create-form').reset();
                        App.State.currentTheme = 'classic';
                        App.UI.renderThemes();

                    } catch (err) {
                        App.UI.toast(err.message || "Something went wrong", "error");
                    } finally {
                        App.UI.setLoading(btn, false);
                    }
                },

                showShareModal(id) {
                    const url = `${window.location.origin}/#wish/${id}`;
                    const modal = document.createElement('div');
                    modal.className = "fixed inset-0 bg-brand-navy/80 backdrop-blur-sm flex items-center justify-center z-[100] p-4";
                    modal.innerHTML = `
                        <div class="bg-white rounded-3xl p-8 max-w-md w-full text-center animate-bounce-in shadow-2xl relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-brand-pink to-brand-navy"></div>
                            <h3 class="text-2xl font-bold text-brand-navy mb-2">Ready to Gift! üéâ</h3>
                            <div class="bg-gray-50 p-4 rounded-xl flex items-center mb-6 border border-gray-200 mt-4">
                                <input type="text" value="${url}" readonly class="bg-transparent flex-1 outline-none text-sm text-gray-600 truncate font-mono">
                                <button onclick="navigator.clipboard.writeText('${url}'); App.UI.toast('Copied!')" class="ml-3 text-brand-pink font-bold text-xs uppercase">Copy</button>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <a href="whatsapp://send?text=${encodeURIComponent('Happy Birthday! üéÇ ' + url)}" class="py-3 bg-[#25D366] text-white rounded-xl font-bold text-sm flex items-center justify-center gap-2 hover:opacity-90"><i class="fab fa-whatsapp"></i> WhatsApp</a>
                                <button onclick="window.location.href='${url}'" class="py-3 bg-brand-navy text-white rounded-xl font-bold text-sm flex items-center justify-center gap-2 hover:opacity-90">Open Wish</button>
                            </div>
                            <button onclick="this.closest('.fixed').remove()" class="mt-4 text-xs text-gray-400 font-bold hover:text-gray-600">Close</button>
                        </div>
                    `;
                    document.body.appendChild(modal);
                },

                async loadDashboard() {
                    if (!App.State.user) return App.Router.go('login');

                    const list = document.getElementById('my-wishes-list');
                    list.innerHTML = '<div class="text-center py-10"><i class="fas fa-spinner fa-spin text-brand-pink text-2xl"></i></div>';

                    // Check banner
                    const banner = document.getElementById('premium-banner');
                    if (banner && !App.State.isPremium) banner.classList.remove('hidden');

                    const { data, error } = await App.Services.supabase
                        .from('wishes').select('*').eq('creator_id', App.State.user.id).order('created_at', { ascending: false });

                    if (!data || data.length === 0) {
                        list.innerHTML = `<div class="text-center py-10 border-2 border-dashed rounded-xl bg-gray-50 text-gray-400">No wishes yet. Create one!</div>`;
                        return;
                    }

                    list.innerHTML = data.map(w => `
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center hover:shadow-md transition">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-full bg-pink-50 flex items-center justify-center text-xl">üéÇ</div>
                                <div>
                                    <h4 class="font-bold text-brand-navy">${w.recipient_name}</h4>
                                    <a href="#wish/${w.id}" class="text-xs text-brand-pink hover:underline">View Wish</a>
                                </div>
                            </div>
                            <button onclick="App.Controllers.deleteWish('${w.id}')" class="text-gray-300 hover:text-red-500 transition px-2"><i class="fas fa-trash"></i></button>
                        </div>
                    `).join('');
                },

                async deleteWish(id) {
                    if (!confirm("Delete this wish?")) return;
                    await App.Services.supabase.from('wishes').delete().eq('id', id);
                    this.loadDashboard();
                    App.UI.toast("Wish deleted");
                },

                async loadWish(id) {
                    const container = document.getElementById('wish-content');
                    container.innerHTML = '<div class="text-white flex flex-col items-center gap-4"><i class="fas fa-birthday-cake fa-bounce text-5xl"></i><p>Baking the cake...</p></div>';

                    const { data, error } = await App.Services.supabase.from('wishes').select('*').eq('id', id).single();

                    if (error || !data) {
                        container.innerHTML = '<div class="text-white text-xl">Wish not found üò¢</div>';
                        return;
                    }

                    // Apply Theme Background
                    const view = document.getElementById('view-wish');
                    view.className = "view-section min-h-screen w-full relative overflow-hidden flex flex-col items-center justify-center"; // Reset

                    if (data.theme === 'love') view.classList.add('bg-love');
                    else if (data.theme === 'midnight') view.classList.add('bg-midnight');
                    else {
                        const colors = { classic: 'from-purple-500 to-pink-500', ocean: 'from-blue-400 to-indigo-600', sunshine: 'from-yellow-400 to-orange-500' };
                        view.classList.add('bg-gradient-to-br');
                        const grad = colors[data.theme] || colors.classic;
                        grad.split(' ').forEach(c => view.classList.add(c));
                    }

                    // Generate Particles
                    let particles = '';
                    if (data.theme === 'love') {
                        for (let i = 0; i < 6; i++) particles += `<div class="floating-heart text-white/30 text-4xl" style="left:${Math.random() * 100}%; animation-delay:${Math.random() * 5}s">‚ù§Ô∏è</div>`;
                    } else if (data.theme === 'midnight') {
                        for (let i = 0; i < 30; i++) particles += `<div class="star-twinkle" style="top:${Math.random() * 100}%; left:${Math.random() * 100}%; width:${Math.random() * 3}px; height:${Math.random() * 3}px; --duration:${2 + Math.random() * 3}s"></div>`;
                    }

                    const cardClass = data.theme === 'midnight' ? 'bg-white/10 border-white/20 text-white' : 'bg-white/90 border-white/50 text-brand-navy';

                    container.innerHTML = `
                        ${particles}
                        
                        <!-- Phase 1: Cake -->
                        <div id="phase-1" class="text-center z-20 transition-all duration-700">
                            <h1 class="text-4xl md:text-6xl font-extrabold text-white mb-8 drop-shadow-lg font-cursive">
                                Happy Birthday <br> <span class="text-yellow-300">${data.recipient_name}</span>!
                            </h1>
                            <div class="relative cursor-pointer hover:scale-105 transition duration-300 inline-block mt-8" onclick="App.Controllers.blowCandle()">
                                <div class="text-[150px] leading-none relative">
                                    üéÇ
                                    <div id="flame" class="absolute top-[-20px] left-[50%] transform -translate-x-1/2 text-5xl flame">üî•</div>
                                </div>
                                <div class="mt-8 bg-black/30 backdrop-blur-md text-white px-6 py-2 rounded-full text-sm font-bold animate-pulse">
                                    üé§ Blow into mic OR üëá Tap to wish
                                </div>
                            </div>
                        </div>

                        <!-- Phase 2: Card (Hidden) -->
                        <div id="phase-2" class="hidden opacity-0 transform translate-y-10 transition-all duration-1000 z-20 max-w-lg w-full px-4">
                            <div class="${cardClass} backdrop-blur-xl rounded-3xl p-8 shadow-2xl border relative text-center">
                                ${data.image_url ? `<img src="${data.image_url}" class="w-32 h-32 rounded-full mx-auto mb-6 object-cover border-4 border-white shadow-lg">` : ''}
                                <p class="text-xl md:text-3xl font-cursive mb-6">"${data.message}"</p>
                                <div class="flex items-center justify-center gap-3 opacity-60 text-xs font-bold uppercase tracking-widest mb-6">
                                    <span class="h-px w-8 bg-current"></span> With Love <span class="h-px w-8 bg-current"></span>
                                </div>
                                <a href="#create" class="inline-block px-6 py-3 bg-brand-pink text-white rounded-full font-bold shadow-lg text-sm hover:scale-105 transition">Create your own</a>
                            </div>
                        </div>
                    `;

                    // Enable Audio & Mic
                    document.body.onclick = () => {
                        App.Audio.startMusic();
                        // Only init mic once
                        if (!App.State.audioContext) App.Audio.initMic(App.Controllers.blowCandle);
                        document.body.onclick = null;
                    };
                },

                blowCandle() {
                    const flame = document.getElementById('flame');
                    if (!flame || flame.classList.contains('hidden')) return;

                    // 1. UI Changes
                    flame.classList.add('hidden');

                    // 2. Audio Effects
                    const bg = document.getElementById('bg-music');
                    const cheer = document.getElementById('cheer-audio');
                    bg.pause();
                    cheer.play();

                    // 3. Confetti
                    App.Controllers.startConfetti();

                    // 4. Phase Transition
                    const p1 = document.getElementById('phase-1');
                    const p2 = document.getElementById('phase-2');

                    p1.style.opacity = '0';
                    p1.style.transform = 'scale(0.9)';

                    setTimeout(() => {
                        p1.classList.add('hidden');
                        p2.classList.remove('hidden');
                        requestAnimationFrame(() => {
                            p2.classList.remove('opacity-0', 'translate-y-10');
                        });
                    }, 600);
                },

                startConfetti() {
                    const canvas = document.getElementById('confetti-canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;

                    const particles = Array.from({ length: 150 }, () => ({
                        x: Math.random() * canvas.width,
                        y: Math.random() * canvas.height - canvas.height,
                        color: ['#FF0055', '#FFD700', '#00BFFF', '#32CD32'][Math.floor(Math.random() * 4)],
                        size: Math.random() * 8 + 2,
                        speedY: Math.random() * 3 + 2,
                        speedX: Math.random() * 2 - 1
                    }));

                    function loop() {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        particles.forEach(p => {
                            p.y += p.speedY;
                            p.x += p.speedX;
                            ctx.fillStyle = p.color;
                            ctx.fillRect(p.x, p.y, p.size, p.size);
                            if (p.y > canvas.height) p.y = -10;
                        });
                        requestAnimationFrame(loop);
                    }
                    loop();
                }
            }
        };

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            App.Services.init();
            App.Router.init();

            // File input preview
            const fileInput = document.getElementById('image-upload');
            if (fileInput) {
                fileInput.onchange = (e) => {
                    const name = e.target.files[0]?.name;
                    document.getElementById('file-upload-text').textContent = name || "Click to upload";
                    document.getElementById('file-upload-text').className = "text-brand-pink font-bold";
                };
            }

            // Create Form
            const form = document.getElementById('create-form');
            if (form) form.addEventListener('submit', App.Controllers.handleCreate);
        });

    </script>
</body>

</html>