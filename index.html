<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WishLink - Create Magic Moments</title>

    <link rel="icon" type="image/png" href="favicon.png">

    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            pink: '#FF0055',
                            navy: '#002366',
                            bg: '#F9FAFB',
                        }
                    },
                    fontFamily: {
                        sans: ['Nunito', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.4s ease-out forwards',
                        'slide-up': 'slideUp 0.5s ease-out forwards',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'bounce-in': 'bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        bounceIn: {
                            '0%': { transform: 'scale(0.3)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --color-primary: #FF0055;
            --color-secondary: #002366;
            --color-bg: #F9FAFB;
        }

        body {
            font-family: 'Nunito', sans-serif;
        }

        .font-cursive {
            font-family: 'Nunito', cursive;
            font-weight: 800;
        }

        html {
            scroll-behavior: smooth;
        }

        /* Toast Animation */
        @keyframes slideDown {
            from {
                transform: translate(-50%, -100%);
                opacity: 0;
            }

            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }

        .toast-enter {
            animation: slideDown 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        /* Interactive Elements */
        .btn-gift {
            background: #FF0055;
            box-shadow: 0 4px 14px 0 rgba(255, 0, 85, 0.39);
            transition: all 0.2s ease;
        }

        .btn-gift:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 0, 85, 0.23);
        }

        .btn-gift:active {
            transform: translateY(0);
        }

        .btn-gift:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        /* Theme Cards */
        .theme-card {
            transition: all 0.3s ease;
        }

        .theme-card.active div:first-child {
            opacity: 1;
            transform: scale(1.03);
            box-shadow: 0 10px 25px -5px rgba(255, 0, 85, 0.25);
            border: 2px solid #FF0055;
        }

        .theme-card.active .check-icon {
            display: flex;
        }

        .theme-card.active .theme-label {
            color: #002366;
            font-weight: 800;
        }

        /* Cake Animations */
        @keyframes flicker {

            0%,
            100% {
                transform: translateX(-50%) scale(1);
                opacity: 1;
            }

            50% {
                transform: translateX(-50%) scale(1.1);
                opacity: 0.9;
            }
        }

        .animate-flicker {
            animation: flicker 0.5s infinite alternate;
        }

        /* --- PREMIUM THEME STYLES --- */

        /* LOVE THEME */
        .bg-love {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%);
            position: relative;
            overflow: hidden;
        }

        .heart-bg {
            position: absolute;
            bottom: -100px;
            width: 40px;
            height: 40px;
            background-color: rgba(255, 255, 255, 0.4);
            transform: rotate(45deg);
            animation: floatHeart 10s infinite linear;
            z-index: 1;
            /* Behind content */
            pointer-events: none;
        }

        .heart-bg::before,
        .heart-bg::after {
            content: "";
            position: absolute;
            width: 40px;
            height: 40px;
            background-color: rgba(255, 255, 255, 0.4);
            border-radius: 50%;
        }

        .heart-bg::before {
            top: -20px;
            left: 0;
        }

        .heart-bg::after {
            left: -20px;
            top: 0;
        }

        @keyframes floatHeart {
            0% {
                transform: translateY(0) rotate(45deg) scale(0.8);
                opacity: 0;
            }

            20% {
                opacity: 0.8;
            }

            100% {
                transform: translateY(-100vh) rotate(45deg) scale(1.2);
                opacity: 0;
            }
        }

        /* MIDNIGHT THEME */
        .bg-midnight {
            background: radial-gradient(circle at bottom, #1b2735 0%, #090a0f 100%);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 10px 2px rgba(255, 255, 255, 0.4);
            animation: twinkle 3s infinite;
            pointer-events: none;
        }

        @keyframes twinkle {
            0% {
                opacity: 0.3;
            }

            50% {
                opacity: 1;
                transform: scale(1.2);
            }

            100% {
                opacity: 0.3;
            }
        }

        .glass-card-midnight {
            background: rgba(255, 255, 255, 0.05) !important;
            /* Override white bg */
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            box-shadow: 0 0 30px rgba(0, 200, 255, 0.2);
            color: #fff !important;
        }

        /* Fix text colors inside midnight card */
        .glass-card-midnight p,
        .glass-card-midnight .font-bold {
            color: white !important;
        }

        .glass-card-midnight .text-brand-navy {
            color: #a5b4fc !important;
            /* Lighter blue for dark mode */
        }
    </style>

    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-brand-bg text-gray-800 selection:bg-pink-100 selection:text-brand-pink">

    <script src="config.js"></script>

    <div id="toast-container"></div>

    <!-- NEW: CEREMONY OVERLAY (Interactive Blow Experience) -->
    <div id="ceremony-overlay"
        class="fixed inset-0 bg-black z-[100] hidden flex-col items-center justify-center text-white text-center p-8 transition-opacity duration-1000">
        <div id="ceremony-text"
            class="text-3xl md:text-5xl font-cursive opacity-0 transition-opacity duration-1000 leading-relaxed text-pink-200 drop-shadow-[0_0_15px_rgba(255,0,85,0.5)]">
            <!-- Text injected via JS -->
        </div>

        <div id="mic-permission-ui" class="hidden flex-col items-center animate-fade-in mt-12">
            <div
                class="w-24 h-24 rounded-full bg-white/10 flex items-center justify-center mb-8 text-4xl animate-pulse ring-4 ring-white/5 shadow-[0_0_30px_rgba(255,255,255,0.1)]">
                üé§</div>
            <h3 class="text-2xl font-bold mb-3">Activate Magic Mode?</h3>
            <p class="mb-8 text-gray-300 max-w-sm text-base leading-relaxed">We need your microphone to detect when you
                physically blow out the candles.</p>
            <button onclick="startMicSequence()"
                class="px-10 py-4 bg-gradient-to-r from-brand-pink to-purple-600 text-white font-bold rounded-full hover:scale-105 transition shadow-lg shadow-pink-500/30 text-lg">Enable
                Magic ‚ú®</button>
            <button onclick="skipMic()"
                class="mt-6 text-sm text-gray-500 hover:text-white transition underline underline-offset-4">No thanks,
                I'll tap</button>
        </div>

        <!-- Visual Mic Meter (Hidden initially) -->
        <div id="mic-meter-container" class="hidden mt-12 flex flex-col items-center gap-2">
            <div class="w-64 h-3 bg-gray-800 rounded-full overflow-hidden border border-gray-700">
                <div id="mic-level"
                    class="h-full bg-gradient-to-r from-green-400 to-emerald-300 w-0 transition-all duration-75 ease-out shadow-[0_0_10px_rgba(74,222,128,0.5)]">
                </div>
            </div>
            <p class="text-xs text-gray-500 uppercase tracking-widest font-bold">Blow Intensity</p>
        </div>
    </div>

    <nav class="fixed top-0 w-full bg-white/90 backdrop-blur-md shadow-sm z-40 h-16 transition-all" id="navbar">
        <div class="max-w-6xl mx-auto px-4 h-full flex items-center justify-between">
            <a href="/" data-link class="flex items-center gap-2 group">
                <img src="logo.png" alt="WishLink Logo" class="h-8 w-auto group-hover:scale-105 transition">
                <span class="text-xl font-bold text-brand-navy tracking-tight hidden md:inline">WishLink<span
                        class="text-brand-pink">.app</span></span>
            </a>

            <div class="flex items-center gap-3 md:gap-6 text-sm font-semibold">
                <a href="/create" data-link
                    class="px-4 py-2 bg-white border border-brand-pink text-brand-pink rounded-full hover:bg-pink-50 transition shadow-sm text-xs md:text-sm whitespace-nowrap gap-2 flex items-center">
                    <i class="fas fa-wand-magic-sparkles"></i> Gift Wish
                </a>

                <button onclick="payForCoffee(50)" class="text-brand-navy hover:text-brand-pink transition px-2 text-lg"
                    title="Buy us a Coffee"><i class="fas fa-coffee"></i></button>

                <button id="nav-login" onclick="navigateTo('/login')"
                    class="text-brand-navy hover:text-brand-pink transition px-2">Login</button>
                <button id="nav-dash" onclick="navigateTo('/dashboard')"
                    class="hidden text-brand-navy hover:text-brand-pink transition flex items-center gap-2">
                    <i class="fas fa-user-circle text-lg"></i> <span class="hidden md:inline">Dashboard</span>
                </button>
                <button id="nav-logout" onclick="handleLogout()"
                    class="hidden text-red-400 hover:text-red-600 transition px-2"><i
                        class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
    </nav>

    <main class="pt-16 min-h-screen flex flex-col">

        <div id="view-home" class="block animate-fade-in">
            <section class="bg-gradient-to-b from-purple-50 via-white to-white pt-24 pb-20 px-4 text-center">
                <span
                    class="px-4 py-1.5 bg-pink-100 text-brand-pink rounded-full text-[10px] md:text-xs font-bold tracking-wider uppercase mb-6 inline-block shadow-sm animate-slide-up">100%
                    Free Forever</span>

                <h1 class="text-4xl md:text-6xl font-extrabold text-brand-navy mb-6 leading-tight animate-slide-up"
                    style="animation-delay: 0.1s;">
                    Make Their Birthday <br> <span
                        class="text-transparent bg-clip-text bg-gradient-to-r from-brand-pink to-brand-navy">Unforgettable</span>
                </h1>

                <p class="text-base md:text-lg text-gray-600 max-w-2xl mx-auto mb-10 leading-relaxed px-4 animate-slide-up"
                    style="animation-delay: 0.2s;">
                    Create a personalized, interactive birthday website in 30 seconds. Send a link that plays music,
                    blows candles, and delivers your love.
                </p>

                <div class="flex flex-col sm:flex-row gap-4 justify-center px-8 animate-slide-up"
                    style="animation-delay: 0.3s;">
                    <button onclick="navigateTo('/create')"
                        class="btn-gift px-8 py-4 text-white rounded-full font-bold text-lg shadow-xl hover:shadow-2xl">
                        Gift this Wish üéÅ
                    </button>
                    <button onclick="navigateTo('/blog')"
                        class="px-8 py-4 bg-white text-gray-700 border border-gray-200 rounded-full font-bold hover:bg-gray-50 transition active:scale-95 text-lg">
                        Read Ideas
                    </button>
                </div>

                <div class="mt-20 max-w-4xl mx-auto bg-white rounded-3xl shadow-2xl overflow-hidden border-[6px] border-white transform -rotate-1 hover:rotate-0 transition duration-700 ease-out cursor-pointer group"
                    onclick="navigateTo('/create')">
                    <div class="bg-gray-100 h-10 flex items-center px-4 gap-2 border-b border-gray-200">
                        <div class="w-3 h-3 bg-red-400 rounded-full"></div>
                        <div class="w-3 h-3 bg-yellow-400 rounded-full"></div>
                        <div class="w-3 h-3 bg-green-400 rounded-full"></div>
                        <div class="ml-auto w-32 h-2 bg-gray-200 rounded-full"></div>
                    </div>
                    <div
                        class="h-64 md:h-96 bg-gray-50 flex flex-col items-center justify-center text-gray-300 relative overflow-hidden">
                        <div
                            class="absolute inset-0 bg-gradient-to-br from-purple-50 to-pink-50 opacity-0 group-hover:opacity-100 transition duration-500">
                        </div>
                        <i
                            class="fas fa-birthday-cake text-6xl opacity-50 mb-3 group-hover:scale-110 transition duration-500 text-brand-pink"></i>
                        <p class="font-bold opacity-50 group-hover:opacity-100 group-hover:text-brand-navy transition">
                            Tap to Create Yours</p>
                    </div>
                </div>
            </section>

            <section class="py-20 px-4 max-w-6xl mx-auto grid md:grid-cols-3 gap-8">
                <div
                    class="p-8 bg-white rounded-2xl shadow-sm border border-gray-100 text-center hover:shadow-xl hover:-translate-y-1 transition duration-300">
                    <div
                        class="w-14 h-14 bg-purple-100 text-brand-pink rounded-full flex items-center justify-center mx-auto mb-6 text-2xl">
                        <i class="fas fa-magic"></i>
                    </div>
                    <h3 class="font-bold text-xl mb-3 text-brand-navy">Interactive Cake</h3>
                    <p class="text-gray-500 text-sm leading-relaxed">They actually have to blow the candle (tap/click)
                        to see your message.</p>
                </div>
                <div
                    class="p-8 bg-white rounded-2xl shadow-sm border border-gray-100 text-center hover:shadow-xl hover:-translate-y-1 transition duration-300">
                    <div
                        class="w-14 h-14 bg-pink-100 text-brand-pink rounded-full flex items-center justify-center mx-auto mb-6 text-2xl">
                        <i class="fas fa-music"></i>
                    </div>
                    <h3 class="font-bold text-xl mb-3 text-brand-navy">Music & Confetti</h3>
                    <p class="text-gray-500 text-sm leading-relaxed">Auto-plays celebration music and showers the screen
                        with digital confetti.</p>
                </div>
                <div
                    class="p-8 bg-white rounded-2xl shadow-sm border border-gray-100 text-center hover:shadow-xl hover:-translate-y-1 transition duration-300">
                    <div
                        class="w-14 h-14 bg-blue-100 text-brand-navy rounded-full flex items-center justify-center mx-auto mb-6 text-2xl">
                        <i class="fas fa-share-alt"></i>
                    </div>
                    <h3 class="font-bold text-xl mb-3 text-brand-navy">Easy Sharing</h3>
                    <p class="text-gray-500 text-sm leading-relaxed">Get a unique link to share on WhatsApp, Instagram,
                        or Messenger instantly.</p>
                </div>
            </section>

            <section class="py-20 bg-white border-t border-gray-100">
                <div class="max-w-6xl mx-auto px-4">
                    <h2 class="text-3xl font-extrabold text-center text-brand-navy mb-12">Wall of Love üíñ</h2>
                    <div class="grid md:grid-cols-3 gap-8">
                        <div class="bg-brand-bg p-8 rounded-2xl relative">
                            <div class="text-4xl text-brand-pink opacity-20 absolute top-4 left-4">‚ùù</div>
                            <p class="text-gray-600 mb-6 italic relative z-10">"My best friend literally cried when she
                                blew out the candle on her phone. Best digital gift ever!"</p>
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-10 h-10 bg-purple-200 rounded-full flex items-center justify-center font-bold text-purple-700">
                                    S</div>
                                <div>
                                    <div class="font-bold text-brand-navy text-sm">Sarah Jenkins</div>
                                    <div class="text-xs text-gray-400">Created 3 wishes</div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-brand-bg p-8 rounded-2xl relative">
                            <div class="text-4xl text-brand-pink opacity-20 absolute top-4 left-4">‚ùù</div>
                            <p class="text-gray-600 mb-6 italic relative z-10">"I forgot my sister's birthday and made
                                this in the Uber. She loved it more than the actual gift lol."</p>
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-10 h-10 bg-blue-200 rounded-full flex items-center justify-center font-bold text-blue-700">
                                    M</div>
                                <div>
                                    <div class="font-bold text-brand-navy text-sm">Mike T.</div>
                                    <div class="text-xs text-gray-400">Saved by WishLink</div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-brand-bg p-8 rounded-2xl relative">
                            <div class="text-4xl text-brand-pink opacity-20 absolute top-4 left-4">‚ùù</div>
                            <p class="text-gray-600 mb-6 italic relative z-10">"The design is so cute and the animations
                                are buttery smooth. Feels very premium for a free tool."</p>
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-10 h-10 bg-pink-200 rounded-full flex items-center justify-center font-bold text-pink-700">
                                    A</div>
                                <div>
                                    <div class="font-bold text-brand-navy text-sm">Ananya G.</div>
                                    <div class="text-xs text-gray-400">Super Fan</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <div id="view-login" class="hidden flex items-center justify-center flex-1 px-4 animate-fade-in bg-gray-50">
            <div
                class="bg-white p-10 rounded-3xl shadow-[0_20px_40px_-10px_rgba(0,35,102,0.1)] max-w-sm w-full text-center border border-gray-100">
                <div
                    class="w-16 h-16 bg-pink-100 text-brand-pink rounded-full flex items-center justify-center mx-auto mb-6 text-2xl shadow-lg">
                    <i class="fas fa-heart"></i>
                </div>
                <h2 class="text-3xl font-bold mb-2 text-brand-navy">Welcome Back!</h2>
                <p class="text-gray-500 mb-8 text-sm">Sign in to save your wishes forever.</p>

                <button onclick="handleLogin()"
                    class="w-full py-3.5 px-4 border border-gray-300 rounded-xl flex items-center justify-center gap-3 hover:bg-gray-50 transition group bg-white">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg"
                        class="w-5 h-5 group-hover:scale-110 transition">
                    <span class="font-bold text-gray-700">Continue with Google</span>
                </button>
                <p class="text-[10px] text-gray-400 mt-6">By continuing, you agree to our Terms & Privacy Policy.</p>
            </div>
        </div>

        <div id="view-dashboard" class="hidden max-w-4xl mx-auto px-4 py-10 w-full animate-fade-in">
            <div class="flex justify-between items-end mb-8">
                <div>
                    <h2 class="text-3xl font-bold text-brand-navy">My Wishes</h2>
                    <p class="text-gray-500 text-sm mt-1">Manage the love you've shared</p>
                </div>
                <a href="/create" data-link
                    class="px-5 py-2.5 bg-brand-pink text-white rounded-xl font-bold shadow-md hover:bg-pink-700 text-sm flex items-center gap-2 transition transform hover:-translate-y-0.5">
                    <i class="fas fa-plus"></i> New Wish
                </a>
            </div>

            <div id="premium-banner"
                class="bg-gradient-to-r from-yellow-400 to-orange-400 p-6 rounded-2xl text-white flex justify-between items-center mb-10 shadow-lg transform transition hover:scale-[1.01]">
                <div>
                    <h3 class="font-bold text-lg flex items-center gap-2"><i class="fas fa-crown text-yellow-100"></i>
                        Go Premium</h3>
                    <p class="text-white/90 text-sm mt-1">Remove ads & unlock premium themes for just $1.</p>
                </div>
                <button onclick="buyPremium()"
                    class="bg-white text-orange-500 px-5 py-2.5 rounded-xl font-bold text-sm hover:bg-orange-50 shadow-sm transition">Upgrade</button>
            </div>

            <div id="my-wishes-list" class="grid gap-4">
            </div>
        </div>

        <div id="view-create" class="hidden max-w-2xl mx-auto px-4 py-10 w-full animate-fade-in">
            <div class="bg-white rounded-3xl shadow-xl p-6 md:p-10 border border-gray-100">
                <h2 class="text-3xl font-bold text-brand-navy mb-8 text-center">Create a New Wish ‚ú®</h2>

                <form id="create-form" class="space-y-8">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1 ml-1">Who is it for?</label>
                        <input type="text" id="recipient" required placeholder="e.g., Sarah"
                            class="w-full px-5 py-4 bg-white border border-gray-200 rounded-xl focus:ring-4 focus:ring-brand-pink/20 focus:border-brand-pink outline-none transition font-semibold text-gray-700 placeholder-gray-300">
                    </div>

                    <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-700 mb-1 ml-1">Your Message</label>
                        <textarea id="message" required rows="4" placeholder="Write something sweet and emotional..."
                            class="w-full px-5 py-4 bg-white border border-gray-200 rounded-xl focus:ring-4 focus:ring-brand-pink/20 focus:border-brand-pink outline-none transition text-gray-700 placeholder-gray-300"></textarea>
                    </div>

                    <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-700 mb-4 ml-1">Choose a Theme</label>
                        <div class="grid grid-cols-3 gap-4">
                            <div class="theme-card active cursor-pointer group relative" data-theme="classic">
                                <div
                                    class="h-24 bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl opacity-60 transition-all duration-300 group-hover:opacity-100">
                                </div>
                                <div class="check-icon absolute inset-0 flex items-center justify-center hidden">
                                    <div
                                        class="bg-white text-brand-pink rounded-full w-8 h-8 flex items-center justify-center shadow-md animate-bounce-in">
                                        <i class="fas fa-check"></i>
                                    </div>
                                </div>
                                <div
                                    class="theme-label text-center text-xs mt-2 font-bold text-gray-400 transition-colors">
                                    Classic</div>
                            </div>
                            <div class="theme-card cursor-pointer group relative" data-theme="ocean">
                                <div
                                    class="h-24 bg-gradient-to-br from-blue-400 to-indigo-600 rounded-xl opacity-60 transition-all duration-300 group-hover:opacity-100">
                                </div>
                                <div class="check-icon absolute inset-0 flex items-center justify-center hidden">
                                    <div
                                        class="bg-white text-brand-pink rounded-full w-8 h-8 flex items-center justify-center shadow-md animate-bounce-in">
                                        <i class="fas fa-check"></i>
                                    </div>
                                </div>
                                <div
                                    class="theme-label text-center text-xs mt-2 font-bold text-gray-400 transition-colors">
                                    Ocean</div>
                            </div>
                            <div class="theme-card cursor-pointer group relative" data-theme="sunshine">
                                <div
                                    class="h-24 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-xl opacity-60 transition-all duration-300 group-hover:opacity-100">
                                </div>
                                <div class="check-icon absolute inset-0 flex items-center justify-center hidden">
                                    <div
                                        class="bg-white text-brand-pink rounded-full w-8 h-8 flex items-center justify-center shadow-md animate-bounce-in">
                                        <i class="fas fa-check"></i>
                                    </div>
                                </div>
                                <div
                                    class="theme-label text-center text-xs mt-2 font-bold text-gray-400 transition-colors">
                                    Sunshine</div>
                            </div>

                            <div class="theme-card relative group cursor-pointer overflow-hidden rounded-xl"
                                data-theme="midnight">
                                <div
                                    class="premium-lock absolute inset-0 bg-black/60 z-20 flex items-center justify-center backdrop-blur-[2px]">
                                    <div
                                        class="bg-white/20 p-3 rounded-full border border-white/30 text-white shadow-lg">
                                        <i class="fas fa-lock"></i>
                                    </div>
                                </div>
                                <div
                                    class="h-24 bg-gradient-to-br from-slate-900 to-slate-700 opacity-80 group-hover:opacity-100 transition">
                                </div>
                                <div class="check-icon absolute inset-0 flex items-center justify-center hidden z-10">
                                    <div
                                        class="bg-white text-brand-pink rounded-full w-8 h-8 flex items-center justify-center shadow-md animate-bounce-in">
                                        <i class="fas fa-check"></i>
                                    </div>
                                </div>
                                <div class="theme-label text-center text-xs mt-2 font-bold text-gray-500">Midnight üåô
                                </div>
                            </div>

                            <div class="theme-card relative group cursor-pointer overflow-hidden rounded-xl"
                                data-theme="love">
                                <div
                                    class="premium-lock absolute inset-0 bg-black/60 z-20 flex items-center justify-center backdrop-blur-[2px]">
                                    <div
                                        class="bg-white/20 p-3 rounded-full border border-white/30 text-white shadow-lg">
                                        <i class="fas fa-lock"></i>
                                    </div>
                                </div>
                                <div
                                    class="h-24 bg-gradient-to-br from-red-500 to-rose-600 opacity-80 group-hover:opacity-100 transition">
                                </div>
                                <div class="check-icon absolute inset-0 flex items-center justify-center hidden z-10">
                                    <div
                                        class="bg-white text-brand-pink rounded-full w-8 h-8 flex items-center justify-center shadow-md animate-bounce-in">
                                        <i class="fas fa-check"></i>
                                    </div>
                                </div>
                                <div class="theme-label text-center text-xs mt-2 font-bold text-gray-500">Love ‚ù§Ô∏è</div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2 ml-1">Add a Memory</label>
                        <div class="relative group">
                            <!-- UPDATED INPUT FOR VIDEO SUPPORT -->
                            <input type="file" id="media-upload" accept="image/*,video/*"
                                onchange="updateFileName(this)"
                                class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                            <div
                                class="w-full bg-white border-2 border-dashed border-gray-300 rounded-xl p-6 flex flex-col items-center justify-center group-hover:border-brand-pink group-hover:bg-pink-50 transition-all duration-300">
                                <div
                                    class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mb-3 group-hover:bg-white text-gray-400 group-hover:text-brand-pink transition-colors">
                                    <i class="fas fa-cloud-upload-alt text-xl"></i>
                                </div>
                                <p id="file-upload-text"
                                    class="text-sm text-gray-400 group-hover:text-brand-navy font-medium transition-colors">
                                    Photo or Video (Max 10MB)</p>
                            </div>
                        </div>
                        <p class="text-xs text-gray-400 mt-2 ml-1">Premium users can upload videos!</p>
                    </div>

                    <button type="submit" id="submit-btn"
                        class="w-full py-4 btn-gift text-white rounded-xl font-bold text-lg flex items-center justify-center gap-2 mt-8">
                        Gift this Wish üéÅ
                    </button>
                </form>
            </div>
        </div>

        <div id="view-wish" class="hidden min-h-screen bg-gray-900 animate-fade-in w-full">
            <div id="wish-content"></div>

            <a href="/" data-link
                class="fixed bottom-4 right-4 bg-white/20 backdrop-blur-sm px-4 py-1.5 rounded-full text-white text-xs font-bold hover:bg-white/40 transition z-50 flex items-center gap-2">
                <span>Made with</span> <span class="font-cursive text-sm">WishLink</span>
            </a>
        </div>

        <div id="view-blog" class="hidden max-w-4xl mx-auto px-4 py-10 w-full animate-fade-in">
            <h2 class="text-3xl font-bold text-brand-navy mb-8">Birthday Ideas & Tips üí°</h2>
            <div class="grid md:grid-cols-2 gap-8">
                <article
                    class="bg-white rounded-2xl overflow-hidden shadow-sm border border-gray-100 hover:shadow-md transition duration-300 group cursor-pointer">
                    <div
                        class="h-48 bg-purple-50 flex items-center justify-center text-brand-pink text-6xl group-hover:scale-110 transition duration-500">
                        üéÇ</div>
                    <div class="p-8">
                        <h3 class="font-bold text-xl mb-3 text-brand-navy group-hover:text-brand-pink transition">10
                            Best Messages for Best Friends</h3>
                        <p class="text-gray-600 mb-4 text-sm leading-relaxed">Struggling to find the right words? Here
                            are the funniest and sweetest birthday wishes to steal.</p>
                        <span class="text-brand-pink font-bold text-sm">Read Article -></span>
                    </div>
                </article>
                <article
                    class="bg-white rounded-2xl overflow-hidden shadow-sm border border-gray-100 hover:shadow-md transition duration-300 group cursor-pointer">
                    <div
                        class="h-48 bg-pink-50 flex items-center justify-center text-brand-pink text-6xl group-hover:scale-110 transition duration-500">
                        üéÅ</div>
                    <div class="p-8">
                        <h3 class="font-bold text-xl mb-3 text-brand-navy group-hover:text-brand-pink transition">Last
                            Minute Digital Gift Ideas</h3>
                        <p class="text-gray-600 mb-4 text-sm leading-relaxed">Forgot a gift? Don't worry. Create a
                            WishLink and pair it with these instant digital vouchers.</p>
                        <span class="text-brand-pink font-bold text-sm">Read Article -></span>
                    </div>
                </article>
            </div>
        </div>

        <div id="view-admin" class="hidden max-w-6xl mx-auto px-4 py-10 w-full animate-fade-in">
            <h2 class="text-2xl font-bold mb-4 text-brand-navy">Admin Dashboard</h2>
            <div class="bg-white p-6 rounded-xl shadow">
                <div id="admin-stats" class="text-xl font-bold">Loading...</div>
            </div>
        </div>

    </main>

    <footer class="bg-gray-900 text-gray-400 py-10 text-center mt-auto border-t border-gray-800">
        <div class="flex items-center justify-center gap-2 mb-6">
            <img src="logo.png" alt="Logo" class="h-6 w-auto brightness-0 invert">
            <span class="font-bold text-white tracking-wide">WishLink</span>
        </div>

        <div class="flex justify-center gap-6 text-sm font-medium mb-6">
            <a href="#" class="hover:text-white transition text-gray-400 hover:scale-105" onclick="payForCoffee(50)">Buy
                us a Coffee ‚òï</a>
            <a href="#" class="hover:text-white transition text-gray-400 hover:scale-105">Privacy Policy</a>
            <a href="#" class="hover:text-white transition text-gray-400 hover:scale-105">Terms of Service</a>
        </div>
        <p class="text-xs text-gray-600">&copy; 2025 WishLink. Crafted with emotions.</p>
    </footer>

    <audio id="bg-music" loop>
        <source src="h-bday.mp3" type="audio/mpeg">
    </audio>
    <audio id="cheer-audio">
        <source src="https://notificationsounds.com/storage/sounds/file-sounds-1235-victory.mp3" type="audio/mpeg">
    </audio>

    <script>
        // --- 1. CONFIG CHECK & INIT ---
        let supabase;
        let currentUser = null;
        let selectedTheme = 'classic';
        let isPremium = false;

        // --- BLOW DETECTION VARIABLES ---
        let isMicActive = false;
        let audioContext, microphone, analyser;
        let blowHistory = [];
        const BLOW_THRESHOLD = 0.25; // Adjusted for better sensitivity
        const SUSTAIN_FRAMES = 8;    // Frames required to sustain

        document.addEventListener('DOMContentLoaded', () => {
            if (typeof CONFIG === 'undefined') {
                showToast('‚ùå config.js missing!', 'error');
                return;
            }

            try {
                supabase = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);

                supabase.auth.onAuthStateChange((event, session) => {
                    currentUser = session?.user || null;
                    updateNavbar();
                    if (currentUser && window.location.pathname === '/login') {
                        const returnTo = sessionStorage.getItem('return_to');
                        if (returnTo) {
                            sessionStorage.removeItem('return_to');
                            navigateTo('/' + returnTo);
                        } else {
                            navigateTo('/dashboard');
                        }
                    }
                });

                supabase.auth.getSession().then(({ data: { session } }) => {
                    currentUser = session?.user || null;
                    updateNavbar();
                });

            } catch (e) {
                console.error("Init Error:", e);
            }

            initThemeSelection();
            const form = document.getElementById('create-form');
            if (form) form.addEventListener('submit', handleFormSubmit);

            router();

            document.body.addEventListener('click', () => {
                const bgMusic = document.getElementById('bg-music');
                if (window.location.pathname.startsWith('/wish') && bgMusic && bgMusic.paused) {
                    bgMusic.volume = 0.4;
                    bgMusic.play().catch(() => { });
                }
            });
        });

        // --- NEW ROUTER LOGIC ---
        document.addEventListener("click", e => {
            const link = e.target.closest("[data-link]");
            if (link) {
                e.preventDefault();
                navigateTo(link.getAttribute("href"));
            }
        });

        window.addEventListener("popstate", () => {
            router();
        });

        const navigateTo = (url) => {
            history.pushState(null, null, url);
            router();
        };

        const router = async () => {
            stopAllAudio();
            stopMic(); // Ensure mic is off on navigation

            const path = window.location.pathname;
            const routes = {
                "/": "view-home",
                "/create": "view-create",
                "/login": "view-login",
                "/dashboard": "view-dashboard",
                "/blog": "view-blog",
                "/admin": "view-admin"
            };

            let viewId = routes[path];
            let param = null;

            if (path.startsWith("/wish/")) {
                viewId = "view-wish";
                param = path.split("/")[2];
            }

            if (!viewId) viewId = "view-home";

            document.querySelectorAll('[id^="view-"]').forEach(el => {
                el.classList.add('hidden');
                el.classList.remove('animate-fade-in');
            });

            const activeEl = document.getElementById(viewId);
            if (activeEl) {
                activeEl.classList.remove('hidden');
                void activeEl.offsetWidth;
                activeEl.classList.add('animate-fade-in');
                window.scrollTo(0, 0);
            }

            checkPremiumStatus();
            updateNavbar();

            if (viewId === 'view-wish' && param) loadWish(param);
            else if (viewId === 'view-dashboard') loadDashboard();
            else if (viewId === 'view-admin') loadAdmin();
        };

        function updateNavbar() {
            const navLogin = document.getElementById('nav-login');
            const navDash = document.getElementById('nav-dash');
            const navLogout = document.getElementById('nav-logout');
            const path = window.location.pathname;

            if (currentUser) {
                navLogin.classList.add('hidden');
                navDash.classList.remove('hidden');
                navLogout.classList.remove('hidden');
            } else {
                if (path === '/login') navLogin.classList.add('hidden');
                else navLogin.classList.remove('hidden');

                navDash.classList.add('hidden');
                navLogout.classList.add('hidden');
            }
        }

        // --- PREMIUM BLOW FEATURE LOGIC ---
        function initCeremony() {
            // This runs if the user is viewing a Premium Wish
            const overlay = document.getElementById('ceremony-overlay');
            const text = document.getElementById('ceremony-text');
            const micUI = document.getElementById('mic-permission-ui');
            const micMeter = document.getElementById('mic-meter-container');

            // Reset state
            micUI.classList.add('hidden');
            micMeter.classList.add('hidden');
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');

            // PHASE 1: THE WISH
            text.style.opacity = '1';
            text.innerHTML = "Close your eyes...";

            setTimeout(() => {
                text.style.opacity = '0';
                setTimeout(() => {
                    text.innerHTML = "Make a wish...";
                    text.style.opacity = '1';

                    setTimeout(() => {
                        // PHASE 2: PERMISSION
                        text.style.opacity = '0';
                        setTimeout(() => {
                            text.innerHTML = "";
                            micUI.classList.remove('hidden');
                            micUI.classList.add('flex');
                        }, 1000);
                    }, 3000);
                }, 1000);
            }, 3000);
        }

        async function startMicSequence() {
            const micUI = document.getElementById('mic-permission-ui');
            const text = document.getElementById('ceremony-text');
            const micMeter = document.getElementById('mic-meter-container');

            try {
                // Request Mic
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                // Init Audio Context
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                microphone = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 512;
                microphone.connect(analyser);

                isMicActive = true;
                blowHistory = [];

                // UI Transition
                micUI.classList.add('hidden');
                text.innerHTML = "Now...<br>Blow out the candles!";
                text.style.opacity = '1';
                micMeter.classList.remove('hidden');

                // Allow reading time, then fade to cake
                setTimeout(() => {
                    document.getElementById('ceremony-overlay').classList.add('opacity-0');
                    setTimeout(() => {
                        document.getElementById('ceremony-overlay').classList.add('hidden');
                        // Update the text on the cake screen
                        const tapText = document.getElementById('tap-instruction');
                        if (tapText) tapText.innerHTML = "üå¨Ô∏è Blow into your mic!";

                        // Start the loop
                        detectBlow();
                    }, 1000);
                }, 2000);

            } catch (err) {
                console.error("Mic denied:", err);
                skipMic();
            }
        }

        function skipMic() {
            document.getElementById('ceremony-overlay').classList.add('hidden');
            // User proceeds to tap interaction manually
        }

        function detectBlow() {
            if (!isMicActive) return;

            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);

            // 1. Calculate RMS (Root Mean Square) for volume
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) {
                sum += (dataArray[i] / 255) * (dataArray[i] / 255);
            }
            let rms = Math.sqrt(sum / dataArray.length);

            // 2. Visual Feedback (Mic Meter)
            const meter = document.getElementById('mic-level');
            if (meter) meter.style.width = (rms * 400) + '%';

            // 3. Rolling Average to filter out sudden clicks
            blowHistory.push(rms);
            if (blowHistory.length > SUSTAIN_FRAMES) blowHistory.shift();

            let avgVolume = blowHistory.reduce((a, b) => a + b, 0) / blowHistory.length;

            // 4. Flicker Effect on Flame
            const flame = document.getElementById('flame');
            if (flame) {
                let scale = 1 - (avgVolume * 0.8);
                flame.style.transform = `translateX(-50%) scale(${Math.max(0.4, scale)})`;
                flame.style.opacity = Math.max(0.4, 1 - avgVolume);
            }

            // 5. Trigger
            if (blowHistory.length >= SUSTAIN_FRAMES && avgVolume > BLOW_THRESHOLD) {
                blowCandle();
            } else {
                requestAnimationFrame(detectBlow);
            }
        }

        function stopMic() {
            if (audioContext) audioContext.close();
            isMicActive = false;
        }

        // --- INTERACTIVE ACTIONS ---
        window.blowCandle = () => {
            const flame = document.getElementById('flame');
            const bgMusic = document.getElementById('bg-music');
            const cheerAudio = document.getElementById('cheer-audio');

            if (!flame || flame.classList.contains('hidden')) return;

            stopMic(); // Kill mic listener
            flame.classList.add('hidden'); // Extinguish visual

            // Audio Transition
            if (bgMusic) {
                bgMusic.pause();
                bgMusic.currentTime = 0;
            }
            if (cheerAudio) {
                cheerAudio.volume = 1.0;
                cheerAudio.play().catch(e => console.log("Audio prevented", e));
            }

            // Delayed music start
            setTimeout(() => {
                if (bgMusic) { bgMusic.volume = 0.5; bgMusic.play(); }
            }, 2000);

            startConfetti();

            // UI Transition
            const phase1 = document.getElementById('phase-1');
            const phase2 = document.getElementById('phase-2');

            phase1.classList.add('opacity-0', 'scale-90', 'pointer-events-none');
            setTimeout(() => phase1.classList.add('hidden'), 500);

            phase2.classList.remove('hidden');
            setTimeout(() => {
                phase2.classList.remove('translate-y-20', 'opacity-0');
            }, 100);
        };

        function startConfetti() {
            const canvas = document.getElementById('confetti-canvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            const particles = [];
            const colors = ['#FF0055', '#002366', '#3b82f6', '#eab308', '#22c55e'];
            for (let i = 0; i < 150; i++) particles.push({
                x: Math.random() * canvas.width, y: Math.random() * canvas.height - canvas.height,
                size: Math.random() * 8 + 4, speedY: Math.random() * 3 + 2, speedX: Math.random() * 2 - 1,
                color: colors[Math.floor(Math.random() * colors.length)], rotation: Math.random() * 360
            });
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                particles.forEach((p, i) => {
                    p.y += p.speedY; p.x += p.speedX; p.rotation += 2;
                    ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.rotation * Math.PI / 180);
                    ctx.fillStyle = p.color; ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size); ctx.restore();
                    if (p.y > canvas.height) particles[i].y = -10;
                });
                requestAnimationFrame(animate);
            }
            animate();
        }

        // --- SUBMIT WISH WITH VIDEO SUPPORT ---
        async function handleFormSubmit(e) {
            e.preventDefault();
            if (!currentUser) {
                showToast("Please sign in to gift this wish ‚ú®");
                sessionStorage.setItem('return_to', 'create');
                setTimeout(() => navigateTo('/login'), 1200);
                return;
            }

            const btn = document.getElementById('submit-btn');
            const originalText = btn.innerHTML;
            const recipient = document.getElementById('recipient').value.trim();
            const message = document.getElementById('message').value.trim();
            const fileInput = document.getElementById('media-upload'); // Changed ID

            if (!recipient || !message) return showToast("Please fill in the details!", "error");

            // Video Constraints Check
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const fileSizeMB = file.size / (1024 * 1024);
                if (fileSizeMB > 10) {
                    showToast("File too large! Max 10MB.", "error");
                    return;
                }
            }

            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Creating Magic...';
            btn.disabled = true;

            try {
                let mediaUrl = null;
                if (fileInput.files.length > 0) {
                    btn.innerHTML = '<i class="fas fa-cloud-upload-alt fa-bounce"></i> Uploading...';
                    mediaUrl = await uploadImage(fileInput.files[0]);
                }

                btn.innerHTML = '<i class="fas fa-pen-fancy fa-bounce"></i> Saving Wish...';

                const { data, error } = await supabase
                    .from('wishes')
                    .insert([{
                        recipient_name: recipient,
                        message: message,
                        theme: selectedTheme,
                        image_url: mediaUrl, // Stores either image or video URL
                        creator_id: currentUser.id
                    }])
                    .select()
                    .single();

                if (error) throw error;

                showShareModal(data.id);
                e.target.reset();
                resetThemeSelection();
                document.getElementById('file-upload-text').innerText = 'Add a sweet memory...';

            } catch (err) {
                console.error(err);
                showToast(err.message, "error");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // --- VIEW WISH (Video Rendering Update) ---
        async function loadWish(id) {
            const container = document.getElementById('wish-content');
            container.innerHTML = '<div class="flex justify-center h-screen items-center gap-3"><i class="fas fa-spinner fa-spin text-4xl text-white"></i><span class="text-white font-medium">Loading Surprise...</span></div>';

            try {
                const { data, error } = await supabase.from('wishes').select('*').eq('id', id).single();
                if (error || !data) {
                    container.innerHTML = '<div class="flex h-screen items-center justify-center"><div class="text-center text-white text-xl bg-white/10 p-8 rounded-xl backdrop-blur-md">Wish not found! Maybe it expired? üéÇ</div></div>';
                } else {
                    renderWishTemplate(data);

                    // --- PREMIUM CHECK FOR BLOW FEATURE ---
                    // If theme is Premium (Love/Midnight), trigger the Ceremony
                    if (data.theme === 'love' || data.theme === 'midnight') {
                        initCeremony();
                    } else {
                        // Ensure overlay is hidden for free wishes
                        document.getElementById('ceremony-overlay').classList.add('hidden');
                    }
                }
            } catch (err) {
                console.error(err);
                container.innerHTML = '<div class="text-center text-white pt-20">Error loading wish.</div>';
            }
        }

        function renderWishTemplate(data) {
            const container = document.getElementById('wish-content');

            // Theme Logic
            let bgClass;
            const theme = data.theme;
            if (theme === 'love') bgClass = 'bg-love';
            else if (theme === 'midnight') bgClass = 'bg-midnight';
            else {
                const themes = {
                    classic: 'from-purple-500 to-pink-500',
                    ocean: 'from-blue-400 to-indigo-600',
                    sunshine: 'from-yellow-400 to-orange-500'
                };
                bgClass = `bg-gradient-to-br ${themes[theme] || themes.classic}`;
            }

            const viewEl = document.getElementById('view-wish');
            viewEl.className = 'min-h-screen relative overflow-hidden';
            if (theme === 'love' || theme === 'midnight') viewEl.classList.add(bgClass);
            else viewEl.classList.add(...bgClass.split(' '));

            // Theme Effects
            let effectsHtml = '';
            if (theme === 'love') {
                effectsHtml = `
                    <div class="heart-bg" style="left: 10%; animation-delay: 0s;"></div>
                    <div class="heart-bg" style="left: 30%; animation-delay: 2s; transform: scale(0.5) rotate(45deg);"></div>
                    <div class="heart-bg" style="left: 70%; animation-delay: 4s;"></div>
                    <div class="heart-bg" style="left: 50%; animation-delay: 6s; transform: scale(1.2) rotate(45deg);"></div>
                    <div class="heart-bg" style="left: 90%; animation-delay: 1s;"></div>
                `;
            } else if (theme === 'midnight') {
                let stars = "";
                for (let i = 0; i < 50; i++) {
                    const top = Math.random() * 100;
                    const left = Math.random() * 100;
                    const delay = Math.random() * 3;
                    stars += `<div class="star" style="top: ${top}%; left: ${left}%; animation-delay: ${delay}s"></div>`;
                }
                effectsHtml = stars;
            }

            const cardClass = theme === 'midnight'
                ? 'glass-card-midnight rounded-3xl p-8 md:p-12 shadow-2xl relative overflow-hidden'
                : 'bg-white/95 backdrop-blur-xl rounded-3xl p-8 md:p-12 shadow-2xl border-4 border-white/50 relative overflow-hidden';

            // --- MEDIA RENDERING LOGIC ---
            let mediaContent = '';
            if (data.image_url) {
                // Check extension for video
                const isVideo = data.image_url.match(/\.(mp4|webm|mov)$/i);
                if (isVideo) {
                    mediaContent = `<video src="${data.image_url}" autoplay loop muted playsinline class="w-full max-h-64 rounded-xl mx-auto mb-6 object-cover border-4 border-purple-200 shadow-lg"></video>`;
                } else {
                    mediaContent = `<img src="${data.image_url}" class="w-32 h-32 rounded-full mx-auto mb-6 object-cover border-4 border-purple-200 shadow-lg transform hover:scale-105 transition duration-500">`;
                }
            }

            container.innerHTML = `
                ${effectsHtml}
                <canvas id="confetti-canvas" class="absolute inset-0 w-full h-full pointer-events-none z-20"></canvas>
                <div class="relative z-10 flex flex-col items-center justify-center min-h-screen p-4 text-center">
                    
                    <div id="phase-1" class="animate-fade-in-up">
                        <div class="text-white text-sm md:text-lg font-bold tracking-[0.2em] mb-4 opacity-90 uppercase">It's a Special Day</div>
                        <h1 class="text-5xl md:text-7xl font-extrabold text-white mb-8 drop-shadow-lg font-cursive leading-tight">
                            Happy Birthday<br><span class="text-yellow-300 relative inline-block transform -rotate-2">${data.recipient_name}</span>!
                        </h1>
                        <div class="cake-container relative mt-10 mb-20 cursor-pointer group transition-transform hover:scale-105 duration-300" onclick="blowCandle()">
                            <div class="plate absolute bottom-0 w-64 h-4 bg-white rounded-full shadow-lg left-1/2 transform -translate-x-1/2 opacity-50"></div>
                            <div class="cake-body w-48 h-32 bg-pink-300 mx-auto rounded-lg relative shadow-2xl flex items-center justify-center">
                                <div class="absolute w-full h-4 bg-pink-400 top-1/2 transform -translate-y-1/2"></div>
                                <div class="icing absolute -top-4 w-52 h-10 bg-white rounded-full shadow-sm"></div>
                            </div>
                            <div class="candle absolute -top-16 left-1/2 transform -translate-x-1/2 w-4 h-16 bg-red-400 border-2 border-red-500 rounded">
                                <div class="stripe w-full h-2 bg-white mt-2 transform -skew-y-12 opacity-50"></div>
                                <div class="stripe w-full h-2 bg-white mt-4 transform -skew-y-12 opacity-50"></div>
                            </div>
                            <div id="flame" class="flame absolute -top-24 left-1/2 transform -translate-x-1/2 w-6 h-8 bg-yellow-400 rounded-full shadow-[0_0_20px_#ffcc00] animate-flicker">
                                <div class="w-2 h-4 bg-white opacity-50 rounded-full mx-auto mt-2"></div>
                            </div>
                            <div id="tap-instruction" class="mt-8 text-white text-sm font-bold bg-black/20 px-4 py-2 rounded-full inline-block backdrop-blur-sm animate-bounce">üëá Tap candle to wish!</div>
                        </div>
                    </div>

                    <div id="phase-2" class="hidden max-w-2xl w-full mx-auto transform transition-all duration-1000 translate-y-20 opacity-0">
                        <div class="${cardClass}">
                            <div class="absolute top-0 right-0 p-4 opacity-10 text-4xl">üéâ</div>
                            <div class="absolute bottom-0 left-0 p-4 opacity-10 text-4xl">üéÇ</div>

                            ${mediaContent}
                            
                            <p class="text-2xl md:text-4xl text-brand-navy font-cursive leading-relaxed mb-8">"${data.message}"</p>
                            
                            <div class="flex items-center justify-center gap-3 text-sm text-gray-500 font-bold tracking-widest uppercase mb-4">
                                <span class="h-px w-8 bg-gray-300"></span> With Love <span class="h-px w-8 bg-gray-300"></span>
                            </div>

                            <div class="mt-8 pt-6 border-t border-gray-100 bg-gray-50 -mx-8 -mb-8 px-8 pb-8">
                                <p class="text-brand-navy font-bold text-sm mb-4">Did this make you smile? üòä<br><span class="text-brand-pink">Say thanks with a coffee!</span></p>
                                <div class="flex gap-3 justify-center">
                                    <button onclick="payForCoffee(10)" class="px-5 py-2.5 bg-white border-2 border-yellow-300 rounded-xl text-brand-navy font-bold hover:bg-yellow-50 text-xs transition transform hover:-translate-y-1 shadow-sm">‚Çπ10</button>
                                    <button onclick="payForCoffee(50)" class="px-5 py-2.5 bg-white border-2 border-yellow-300 rounded-xl text-brand-navy font-bold hover:bg-yellow-50 text-xs transition transform hover:-translate-y-1 shadow-sm">‚Çπ50</button>
                                    <button onclick="payForCoffee(100)" class="px-5 py-2.5 bg-yellow-400 text-brand-navy rounded-xl font-bold hover:bg-yellow-500 text-xs shadow-md transition transform hover:-translate-y-1 ring-2 ring-yellow-200">‚Çπ100</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-10">
                            <a href="/create" data-link class="inline-block px-8 py-3 bg-white text-brand-pink rounded-full font-bold shadow-lg hover:scale-105 transition transform text-sm md:text-base ring-4 ring-brand-pink/30">Create your own WishLink üéÅ</a>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- UTILS ---
        function stopAllAudio() {
            const bgMusic = document.getElementById('bg-music');
            const cheerAudio = document.getElementById('cheer-audio');
            if (bgMusic) { bgMusic.pause(); bgMusic.currentTime = 0; }
            if (cheerAudio) { cheerAudio.pause(); cheerAudio.currentTime = 0; }
        }

        function checkPremiumStatus() {
            if (!currentUser) return;
            const status = localStorage.getItem('is_premium_' + currentUser.id);
            if (status === 'true') {
                isPremium = true;
                unlockThemes();
            }
        }

        function unlockThemes() {
            document.querySelectorAll('.premium-lock').forEach(el => el.classList.add('hidden'));
            const banner = document.getElementById('premium-banner');
            if (banner) banner.style.display = 'none';
        }

        // ... Existing Utils (Toast, Payment, Upload) from your file ...
        window.showToast = (message, type = 'success') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const colors = type === 'error' ? 'bg-red-500' : 'bg-brand-navy';
            const icon = type === 'error' ? 'fa-exclamation-circle' : 'fa-check-circle';
            toast.className = `toast-enter fixed top-6 left-1/2 transform -translate-x-1/2 z-[60] flex items-center gap-3 px-6 py-3 rounded-full shadow-2xl ${colors} text-white min-w-[300px] justify-center backdrop-blur-md bg-opacity-95`;
            toast.innerHTML = `<i class="fas ${icon}"></i><span class="font-semibold text-sm">${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translate(-50%, -100%)';
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        };

        function handlePayment(amount, description) { /* ... Your existing logic ... */ }
        function payForCoffee(amount) { alert("Coffee feature"); } // Simplified for this view, your original has logic
        function buyPremium() { alert("Premium unlocked!"); if (currentUser) localStorage.setItem('is_premium_' + currentUser.id, 'true'); checkPremiumStatus(); }

        window.handleLogin = async () => { /* ... Your existing logic ... */ };
        window.handleLogout = async () => { /* ... Your existing logic ... */ };

        async function uploadImage(file) { /* ... Your existing logic ... */ return "sample_url.jpg"; }
        window.updateFileName = (input) => {
            document.getElementById('file-upload-text').innerText = input.files[0] ? input.files[0].name : "Photo/Video";
        }
    </script>
</body>

</html>