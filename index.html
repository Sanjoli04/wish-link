<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WishLink - Create Magic Moments</title>
    <link rel="icon" type="image/png" href="favicon.png">

    <!-- External SDKs -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Chewy&family=Varela+Round&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { pink: '#FF0055', navy: '#002366', bg: '#F9FAFB' }
                    },
                    fontFamily: {
                        sans: ['Nunito', 'sans-serif'],
                        cursive: ['Nunito', 'cursive'],
                        chewy: ['Chewy', 'cursive'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'slide-up': 'slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'bounce-in': 'bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55)',
                        'slide-in-left': 'slideInLeft 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        bounceIn: { '0%': { transform: 'scale(0)' }, '70%': { transform: 'scale(1.1)' }, '100%': { transform: 'scale(1)' } },
                        slideInLeft: { '0%': { opacity: '0', transform: 'translateX(-20px)' }, '100%': { opacity: '1', transform: 'translateX(0)' } }
                    }
                }
            }
        }
    </script>

    <style>
        /* --- CORE STYLES --- */
        body {
            font-family: 'Nunito', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            scroll-behavior: smooth;
        }

        /* --- FLAME ANIMATIONS --- */
        .flame {
            transform-origin: center bottom;
            animation: flicker 1.5s infinite ease-in-out;
        }

        .flame-out {
            animation: popOut 0.3s forwards !important;
        }

        @keyframes flicker {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.1);
                opacity: 0.9;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes popOut {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.4);
                opacity: 0.8;
            }

            100% {
                transform: scale(0);
                opacity: 0;
            }
        }

        /* --- TOASTS --- */
        #toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            pointer-events: auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 12px 24px;
            border-radius: 50px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            color: #002366;
            transform: translateY(-50px);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid rgba(255, 255, 255, 0.5);
            min-width: 300px;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            border-left: 4px solid #10b981;
        }

        .toast.error {
            border-left: 4px solid #ef4444;
        }

        /* --- DONATION NOTIFICATION --- */
        #donation-popup-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 9000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .donation-card {
            pointer-events: auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            padding: 12px 20px;
            border-radius: 16px;
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInLeft 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            max-width: 300px;
        }

        /* --- MODAL TRANSITIONS --- */
        .modal-bg {
            transition: opacity 0.3s ease;
        }

        .modal-content {
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .modal-hidden {
            opacity: 0;
            pointer-events: none;
        }

        .modal-hidden .modal-content {
            transform: scale(0.9);
        }

        .modal-visible {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-visible .modal-content {
            transform: scale(1);
        }

        /* --- UI ELEMENTS --- */
        .btn-gift {
            background: #FF0055;
            box-shadow: 0 4px 14px 0 rgba(255, 0, 85, 0.39);
            transition: all 0.2s ease;
        }

        .btn-gift:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 0, 85, 0.23);
        }

        .btn-gift:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        .theme-card {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .theme-card.active {
            border-color: #FF0055;
            transform: scale(1.02);
            box-shadow: 0 10px 25px -5px rgba(255, 0, 85, 0.25);
        }

        .theme-card.active .check-icon {
            display: flex;
        }

        /* Themes */
        .bg-love {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
        }

        .bg-midnight {
            background: radial-gradient(circle at bottom, #1b2735 0%, #090a0f 100%);
            color: white;
        }

        .floating-heart {
            position: absolute;
            animation: floatUp 8s linear infinite;
            pointer-events: none;
            opacity: 0;
        }

        @keyframes floatUp {
            0% {
                transform: translateY(100vh) scale(0.5);
                opacity: 0;
            }

            20% {
                opacity: 0.6;
            }

            100% {
                transform: translateY(-20vh) scale(1.2);
                opacity: 0;
            }
        }

        .star-twinkle {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle var(--duration) infinite;
            opacity: 0;
        }

        @keyframes twinkle {

            0%,
            100% {
                opacity: 0.2;
                transform: scale(0.8);
            }

            50% {
                opacity: 1;
                transform: scale(1.2);
                box-shadow: 0 0 10px white;
            }
        }
    </style>
</head>

<body
    class="bg-brand-bg text-gray-800 selection:bg-pink-100 selection:text-brand-pink overflow-x-hidden flex flex-col min-h-screen">

    <script src="config.js"></script>
    <div id="toast-container"></div>
    <div id="donation-popup-container"></div>

    <!-- CUSTOM DONATION MODAL -->
    <div id="donation-modal"
        class="modal-bg modal-hidden fixed inset-0 bg-brand-navy/80 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
        <div
            class="modal-content bg-white rounded-3xl p-8 max-w-sm w-full text-center shadow-2xl relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-yellow-400 to-orange-500"></div>

            <div
                class="w-16 h-16 bg-yellow-100 text-yellow-600 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl shadow-sm animate-bounce-in">
                ‚òï</div>
            <h3 class="text-2xl font-bold text-brand-navy mb-2">Buy us a Coffee</h3>
            <p class="text-gray-500 text-sm mb-6">Support WishLink & join the Wall of Love!</p>

            <div class="mb-6 text-left">
                <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 ml-1">Your Note
                    (Optional)</label>
                <textarea id="donation-note-input" rows="3" placeholder="Write something sweet..."
                    class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-brand-pink focus:border-transparent outline-none transition text-sm resize-none"></textarea>
            </div>

            <button onclick="App.Controllers.processDonation()" id="donate-confirm-btn"
                class="w-full py-3.5 bg-brand-pink text-white rounded-xl font-bold text-sm shadow-lg shadow-pink-200 hover:shadow-pink-300 hover:-translate-y-0.5 transition flex items-center justify-center gap-2">
                Donate <span id="donate-amount-display">‚Çπ50</span>
            </button>
            <button onclick="App.UI.toggleDonationModal(false)"
                class="mt-4 text-xs text-gray-400 font-bold hover:text-gray-600 uppercase tracking-widest">Cancel</button>
        </div>
    </div>

    <nav class="fixed top-0 w-full bg-white/90 backdrop-blur-md shadow-sm z-50 h-16 transition-all">
        <div class="max-w-6xl mx-auto px-4 h-full flex items-center justify-between">
            <a href="#home" class="flex items-center gap-2 group">
                <img src="logo.png" onerror="this.src='https://placehold.co/40'" alt="WishLink"
                    class="h-8 w-auto group-hover:scale-105 transition">
                <span class="text-xl font-bold text-brand-navy tracking-tight hidden md:inline">WishLink<span
                        class="text-brand-pink">.app</span></span>
            </a>
            <div class="flex items-center gap-3 md:gap-6 text-sm font-semibold">
                <a href="#create" onclick="App.State.editingId = null"
                    class="px-4 py-2 bg-white border border-brand-pink text-brand-pink rounded-full hover:bg-pink-50 transition shadow-sm text-xs md:text-sm whitespace-nowrap gap-2 flex items-center">
                    <i class="fas fa-wand-magic-sparkles"></i> Gift Wish
                </a>
                <button onclick="App.Services.buyCoffee(50)"
                    class="text-brand-navy hover:text-brand-pink transition px-2 text-lg" title="Buy us a Coffee"><i
                        class="fas fa-coffee"></i></button>
                <div id="nav-auth-container" class="flex items-center gap-4"></div>
            </div>
        </div>
    </nav>

    <main class="pt-16 flex-grow flex flex-col relative">
        <div id="view-home" class="view-section hidden">
            <!-- Hero -->
            <section class="bg-gradient-to-b from-purple-50 via-white to-white pt-24 pb-20 px-4 text-center">
                <span
                    class="px-4 py-1.5 bg-pink-100 text-brand-pink rounded-full text-[10px] md:text-xs font-bold tracking-wider uppercase mb-6 inline-block shadow-sm animate-slide-up">100%
                    Free Forever</span>
                <h1 class="text-4xl md:text-6xl font-extrabold text-brand-navy mb-6 leading-tight animate-slide-up"
                    style="animation-delay: 0.1s;">
                    Make Their Birthday <br> <span
                        class="text-transparent bg-clip-text bg-gradient-to-r from-brand-pink to-brand-navy">Unforgettable</span>
                </h1>
                <p class="text-base md:text-lg text-gray-600 max-w-2xl mx-auto mb-10 leading-relaxed px-4 animate-slide-up"
                    style="animation-delay: 0.2s;">
                    Create a personalized, interactive birthday website in 30 seconds. Send a link that plays music,
                    blows candles, and delivers your love.
                </p>
                <div class="flex flex-col sm:flex-row gap-4 justify-center px-8 animate-slide-up"
                    style="animation-delay: 0.3s;">
                    <button onclick="App.State.editingId = null; App.Router.go('create')"
                        class="btn-gift px-8 py-4 text-white rounded-full font-bold text-lg shadow-xl">Gift this Wish
                        üéÅ</button>
                    <button onclick="App.Router.go('blog')"
                        class="px-8 py-4 bg-white text-gray-700 border border-gray-200 rounded-full font-bold hover:bg-gray-50 transition">Read
                        Ideas</button>
                </div>

                <!-- Demo Preview -->
                <div class="mt-20 max-w-4xl mx-auto bg-white rounded-3xl shadow-2xl overflow-hidden border-[6px] border-white transform -rotate-1 hover:rotate-0 transition duration-700 cursor-pointer group"
                    onclick="App.State.editingId = null; App.Router.go('create')">
                    <div class="bg-gray-100 h-10 flex items-center px-4 gap-2 border-b border-gray-200">
                        <div class="w-3 h-3 bg-red-400 rounded-full"></div>
                        <div class="w-3 h-3 bg-yellow-400 rounded-full"></div>
                        <div class="w-3 h-3 bg-green-400 rounded-full"></div>
                    </div>
                    <div
                        class="h-64 md:h-96 bg-gray-50 flex flex-col items-center justify-center text-gray-300 relative overflow-hidden group-hover:bg-gray-100 transition-colors">
                        <i
                            class="fas fa-birthday-cake text-6xl opacity-50 mb-3 text-brand-pink group-hover:scale-110 transition duration-500"></i>
                        <p class="font-bold opacity-50 text-brand-navy">Tap to Create Yours</p>
                    </div>
                </div>
            </section>

            <!-- Testimonials / Wall of Love -->
            <section class="py-20 bg-white border-t border-gray-100">
                <div class="max-w-6xl mx-auto px-4">
                    <div class="text-center mb-12">
                        <span
                            class="text-brand-pink font-bold tracking-wider text-xs uppercase bg-pink-50 px-3 py-1 rounded-full">Community</span>
                        <h2 class="text-3xl font-extrabold text-brand-navy mt-3">Wall of Love üíñ</h2>
                        <p class="text-gray-500 text-sm mt-2">Kind words from our supporters in the last 7 days</p>
                    </div>

                    <div id="wall-of-love-grid" class="grid md:grid-cols-3 gap-8">
                        <!-- Content Injected via JS -->
                        <div
                            class="col-span-3 text-center py-10 bg-gray-50 rounded-3xl border border-dashed border-gray-200">
                            <div class="text-4xl mb-4">üíå</div>
                            <p class="text-gray-500 font-medium">Be the first to leave a note this week!</p>
                            <button onclick="App.Services.buyCoffee(50)"
                                class="mt-4 text-brand-pink font-bold hover:underline text-sm">Send a Gift & Note
                                &rarr;</button>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- VIEW: LOGIN -->
        <div id="view-login"
            class="view-section hidden flex items-center justify-center flex-1 px-4 bg-gray-50 min-h-[80vh]">
            <div
                class="bg-white p-10 rounded-3xl shadow-xl max-w-sm w-full text-center border border-gray-100 animate-slide-up">
                <div
                    class="w-16 h-16 bg-pink-100 text-brand-pink rounded-full flex items-center justify-center mx-auto mb-6 text-2xl shadow-lg">
                    <i class="fas fa-heart"></i>
                </div>
                <h2 class="text-3xl font-bold mb-2 text-brand-navy">Welcome Back!</h2>
                <p class="text-gray-500 mb-8 text-sm">Sign in to save your wishes forever.</p>
                <button onclick="App.Services.login()"
                    class="w-full py-3.5 px-4 border border-gray-300 rounded-xl flex items-center justify-center gap-3 hover:bg-gray-50 transition bg-white text-gray-700 font-bold">
                    <i class="fab fa-google text-red-500"></i> Continue with Google
                </button>
                <p class="text-[10px] text-gray-400 mt-6">By continuing, you agree to our Terms.</p>
            </div>
        </div>

        <!-- VIEW: DASHBOARD -->
        <div id="view-dashboard" class="view-section hidden max-w-4xl mx-auto px-4 py-10 w-full">
            <div class="flex flex-col md:flex-row justify-between items-end mb-8 gap-4">
                <div>
                    <h2 class="text-3xl font-bold text-brand-navy">My Wishes</h2>
                    <p class="text-gray-500 text-sm mt-1">Manage the love you've shared</p>
                </div>
                <div class="flex items-center gap-4">
                    <div
                        class="bg-yellow-50 px-4 py-2 rounded-xl border border-yellow-200 text-yellow-700 text-sm font-bold flex items-center gap-2">
                        <span>‚òï Donated:</span>
                        <span id="user-total-donation">‚Çπ0</span>
                    </div>
                    <a href="#create" onclick="App.State.editingId = null"
                        class="px-5 py-2.5 bg-brand-pink text-white rounded-xl font-bold shadow-md hover:bg-pink-700 text-sm flex items-center gap-2 transition"><i
                            class="fas fa-plus"></i> New Wish</a>
                </div>
            </div>
            <!-- Premium Banner -->
            <div id="premium-banner"
                class="hidden bg-gradient-to-r from-yellow-400 to-orange-400 p-6 rounded-2xl text-white flex justify-between items-center mb-10 shadow-lg">
                <div>
                    <h3 class="font-bold text-lg flex items-center gap-2"><i class="fas fa-crown text-yellow-100"></i>
                        Go Premium</h3>
                    <p class="text-white/90 text-sm mt-1">Unlock premium themes & remove ads for $1.</p>
                </div>
                <button onclick="App.Services.buyPremium()"
                    class="bg-white text-orange-500 px-5 py-2.5 rounded-xl font-bold text-sm hover:bg-orange-50 shadow-sm transition">Upgrade</button>
            </div>
            <div id="my-wishes-list" class="grid gap-4"></div>
        </div>

        <!-- VIEW: CREATE -->
        <div id="view-create" class="view-section hidden max-w-2xl mx-auto px-4 py-10 w-full">
            <div class="bg-white rounded-3xl shadow-xl p-6 md:p-10 border border-gray-100 animate-slide-up">
                <h2 id="create-title" class="text-3xl font-bold text-brand-navy mb-8 text-center">Create a New Wish ‚ú®
                </h2>
                <form id="create-form" class="space-y-6">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1 ml-1">Who is it for?</label>
                        <input type="text" id="recipient" required placeholder="e.g., Sarah"
                            class="w-full px-5 py-4 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-brand-pink focus:border-transparent outline-none transition font-semibold">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1 ml-1">Your Message</label>
                        <textarea id="message" required rows="4" placeholder="Write something sweet..."
                            class="w-full px-5 py-4 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-brand-pink outline-none transition"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-4 ml-1">Choose a Theme</label>
                        <div class="grid grid-cols-3 gap-4" id="theme-selector"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2 ml-1">Add a Photo (Optional)</label>
                        <div class="relative group cursor-pointer">
                            <input type="file" id="image-upload" accept="image/*"
                                class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                            <div id="upload-preview"
                                class="w-full bg-gray-50 border-2 border-dashed border-gray-300 rounded-xl p-6 flex flex-col items-center justify-center group-hover:border-brand-pink group-hover:bg-pink-50 transition-all">
                                <div
                                    class="w-12 h-12 bg-white rounded-full flex items-center justify-center mb-3 shadow-sm text-gray-400">
                                    <i class="fas fa-camera text-xl"></i>
                                </div>
                                <p id="file-upload-text" class="text-sm text-gray-500 font-medium">Click to upload</p>
                            </div>
                        </div>
                    </div>
                    <button type="submit" id="submit-btn"
                        class="w-full py-4 btn-gift text-white rounded-xl font-bold text-lg flex items-center justify-center gap-2 mt-4">Gift
                        this Wish üéÅ</button>
                </form>
            </div>
        </div>

        <!-- VIEW: WISH (PUBLIC) -->
        <div id="view-wish" class="view-section hidden min-h-screen bg-gray-900 w-full relative overflow-hidden">
            <div id="wish-content"
                class="relative z-10 w-full h-full min-h-screen flex flex-col items-center justify-center"></div>
            <canvas id="confetti-canvas" class="absolute inset-0 w-full h-full pointer-events-none z-20"></canvas>
            <a href="#home"
                class="fixed bottom-4 right-4 bg-white/20 backdrop-blur-sm px-4 py-1.5 rounded-full text-white text-xs font-bold hover:bg-white/40 transition z-50 flex items-center gap-2">
                <span>Made with</span> <span class="font-cursive text-sm">WishLink</span>
            </a>
        </div>

        <!-- VIEW: BLOG -->
        <div id="view-blog" class="view-section hidden max-w-4xl mx-auto px-4 py-10">
            <h2 class="text-3xl font-bold text-brand-navy mb-8">Birthday Ideas & Tips üí°</h2>
            <div class="grid md:grid-cols-2 gap-8">
                <article
                    class="bg-white rounded-2xl overflow-hidden shadow-sm border border-gray-100 hover:shadow-md transition duration-300 group cursor-pointer">
                    <div
                        class="h-48 bg-purple-50 flex items-center justify-center text-brand-pink text-6xl group-hover:scale-110 transition duration-500">
                        üéÇ</div>
                    <div class="p-8">
                        <h3 class="font-bold text-xl mb-3 text-brand-navy group-hover:text-brand-pink transition">10
                            Best Messages for Best Friends</h3>
                        <p class="text-gray-600 mb-4 text-sm leading-relaxed">Struggling to find the right words? Here
                            are the funniest and sweetest birthday wishes to steal.</p>
                        <span class="text-brand-pink font-bold text-sm">Read Article -></span>
                    </div>
                </article>
                <article
                    class="bg-white rounded-2xl overflow-hidden shadow-sm border border-gray-100 hover:shadow-md transition duration-300 group cursor-pointer">
                    <div
                        class="h-48 bg-pink-50 flex items-center justify-center text-brand-pink text-6xl group-hover:scale-110 transition duration-500">
                        üéÅ</div>
                    <div class="p-8">
                        <h3 class="font-bold text-xl mb-3 text-brand-navy group-hover:text-brand-pink transition">Last
                            Minute Digital Gift Ideas</h3>
                        <p class="text-gray-600 mb-4 text-sm leading-relaxed">Forgot a gift? Don't worry. Create a
                            WishLink and pair it with these instant digital vouchers.</p>
                        <span class="text-brand-pink font-bold text-sm">Read Article -></span>
                    </div>
                </article>
            </div>
        </div>
    </main>

    <!-- FOOTER -->
    <footer class="bg-gray-900 text-gray-400 py-10 text-center border-t border-gray-800 z-10 relative">
        <div class="flex items-center justify-center gap-2 mb-6">
            <img src="logo.png" onerror="this.src='https://placehold.co/20'" alt="Logo"
                class="h-6 w-auto brightness-0 invert">
            <span class="font-bold text-white tracking-wide">WishLink</span>
        </div>
        <div class="flex justify-center gap-6 text-sm font-medium mb-6">
            <button class="hover:text-white transition text-gray-400 hover:scale-105"
                onclick="App.Services.buyCoffee(50)">Buy us a Coffee ‚òï</button>
            <a href="#" class="hover:text-white transition text-gray-400 hover:scale-105">Privacy Policy</a>
            <a href="#" class="hover:text-white transition text-gray-400 hover:scale-105">Terms of Service</a>
        </div>
        <p class="text-xs text-gray-600">&copy; 2025 WishLink. Crafted with emotions.</p>
    </footer>

    <!-- AUDIO ELEMENTS -->
    <audio id="bg-music" loop preload="auto">
        <source src="h-bday.mp3" type="audio/mpeg">
    </audio>
    <audio id="cheer-audio" preload="auto">
        <source src="https://notificationsounds.com/storage/sounds/file-sounds-1235-victory.mp3" type="audio/mpeg">
    </audio>

    <!-- APP LOGIC -->
    <script>
        // --- HELPERS ---
        const Utils = {
            timeAgo(dateString) {
                const date = new Date(dateString);
                const now = new Date();
                const seconds = Math.floor((now - date) / 1000);

                if (seconds < 60) return "Just now";
                let interval = Math.floor(seconds / 31536000);
                if (interval > 1) return interval + "y ago";
                interval = Math.floor(seconds / 2592000);
                if (interval > 1) return interval + "mo ago";
                interval = Math.floor(seconds / 86400);
                if (interval > 1) return interval + "d ago";
                interval = Math.floor(seconds / 3600);
                if (interval > 1) return interval + "h ago";
                interval = Math.floor(seconds / 60);
                if (interval > 1) return interval + "m ago";
                return "Just now";
            }
        };

        // --- CAKE REGISTRY ---
        const CakeFactory = {
            // Reusable Candle Group (Scaled & Positioned for 300x400 viewbox)
            getCandles(x, y) {
                return `
                    <g transform="translate(${x}, ${y}) scale(0.3)">
                        <g class="candle">
                            <rect x="-25" y="0" width="50" height="100" rx="8" fill="#ffd700" />
                            <rect x="-15" y="-30" width="30" height="35" rx="4" fill="#ffed4e" />
                            <g class="flame" style="transform-origin: 0px -30px;">
                                <path d="M 0 -30 Q -15 -80 0 -120 Q 15 -80 0 -30" fill="#ffb700" style="filter: drop-shadow(0 0 10px #ffb700);"/>
                                <path d="M 0 -35 Q -7 -70 0 -100 Q 7 -70 0 -35" fill="#ffd700" />
                            </g>
                        </g>
                    </g>
                `;
            },

            // 1. Classic Cake (Simple Vector)
            getSimpleCake() {
                return `
                    <svg width="300" height="300" viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-64 h-auto mx-auto">
                        <ellipse cx="100" cy="170" rx="90" ry="15" fill="#f0f0f0" />
                        <ellipse cx="100" cy="168" rx="90" ry="15" fill="#e0e0e0" />
                        <path d="M40 110 L40 150 C40 165 160 165 160 150 L160 110" fill="#8B4513" />
                        <ellipse cx="100" cy="110" rx="60" ry="20" fill="#A0522D" />
                        <path d="M38 110 C38 110 50 130 70 115 C90 100 110 130 130 115 C150 100 162 110 162 110 L162 100 C162 100 100 80 38 100 Z" fill="#FFC0CB" />
                        <ellipse cx="100" cy="100" rx="62" ry="22" fill="#FFB6C1" />
                        ${this.getCandles(100, 60)}
                    </svg>
                `;
            },

            // 2. Carrot Cake (Sunshine)
            getCarrotCake() {
                return `
                    <svg viewBox="0 0 300 400" xmlns="http://www.w3.org/2000/svg" class="w-64 h-auto mx-auto">
                        <defs>
                            <linearGradient id="frosting-grad" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#FFF8E1" />
                                <stop offset="20%" style="stop-color:#FFFFFF" />
                                <stop offset="100%" style="stop-color:#FFE0B2" />
                            </linearGradient>
                            <linearGradient id="sponge-grad" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#D84315" />
                                <stop offset="50%" style="stop-color:#EF6C00" />
                                <stop offset="100%" style="stop-color:#BF360C" />
                            </linearGradient>
                            <pattern id="crumb-texture" x="0" y="0" width="10" height="10" patternUnits="userSpaceOnUse">
                                <circle cx="2" cy="2" r="1" fill="#3E2723" opacity="0.1"/>
                                <circle cx="7" cy="6" r="1" fill="#3E2723" opacity="0.1"/>
                            </pattern>
                            <mask id="crumb-mask">
                                <rect x="0" y="0" width="300" height="400" fill="white"/>
                            </mask>
                            <filter id="soft-shadow">
                                <feGaussianBlur in="SourceAlpha" stdDeviation="3"/>
                                <feOffset dx="0" dy="2" result="offsetblur"/>
                                <feComponentTransfer>
                                    <feFuncA type="linear" slope="0.3"/>
                                </feComponentTransfer>
                                <feMerge> 
                                    <feMergeNode in="offsetblur"/>
                                    <feMergeNode in="SourceGraphic"/> 
                                </feMerge>
                            </filter>
                        </defs>
                        <ellipse cx="150" cy="345" rx="90" ry="15" fill="#FFF" stroke="#CFD8DC" stroke-width="1"/>
                        <g id="bottom-tier">
                            <path d="M 65 260 L 65 330 C 65 350, 235 350, 235 330 L 235 260" fill="url(#frosting-grad)" />
                            <path d="M 65 260 C 65 280, 235 280, 235 260 C 235 240, 65 240, 65 260" fill="#FFE0B2" />
                            <g mask="url(#crumb-mask)">
                                <path d="M 65 295 C 65 315, 235 315, 235 295 L 235 285 C 235 305, 65 305, 65 285 Z" fill="url(#sponge-grad)" />
                                <path d="M 65 295 C 65 315, 235 315, 235 295 L 235 285 C 235 305, 65 305, 65 285 Z" fill="url(#crumb-texture)" />
                            </g>
                            <ellipse cx="150" cy="260" rx="60" ry="8" fill="#000" opacity="0.2" filter="url(#soft-shadow)" />
                        </g>
                        <g id="top-tier" transform="translate(0, 20)">
                            <path d="M 95 190 L 95 240 C 95 255, 205 255, 205 240 L 205 190" fill="url(#frosting-grad)" />
                            <path d="M 95 190 C 95 205, 205 205, 205 190 C 205 175, 95 175, 95 190" fill="#FFE0B2" />
                            <path d="M 95 215 C 95 230, 205 230, 205 215 L 205 205 C 205 220, 95 220, 95 205 Z" fill="url(#sponge-grad)" />
                            <path d="M 95 215 C 95 230, 205 230, 205 215 L 205 205 C 205 220, 95 220, 95 205 Z" fill="url(#crumb-texture)" />
                        </g>
                        <!-- Candles Overlay -->
                        ${this.getCandles(150, 185)}
                        ${this.getCandles(120, 190)}
                        ${this.getCandles(180, 190)}
                    </svg>
                `;
            },

            // 3. White Berry Drip (Ocean)
            getBerryCake() {
                return `
                    <svg viewBox="0 0 300 400" xmlns="http://www.w3.org/2000/svg" class="w-64 h-auto mx-auto">
                        <defs>
                            <linearGradient id="pink-body-grad" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#FFC1E3" />
                                <stop offset="100%" style="stop-color:#F06292" />
                            </linearGradient>
                            <linearGradient id="white-frost-grad" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#FFFFFF" />
                                <stop offset="100%" style="stop-color:#E0E0E0" />
                            </linearGradient>
                            <filter id="soft-blur">
                                <feGaussianBlur in="SourceAlpha" stdDeviation="2.5" />
                            </filter>
                        </defs>
                        <ellipse cx="150" cy="340" rx="90" ry="12" fill="#5D4037" opacity="0.2" filter="url(#soft-blur)" />
                        <g id="bottom-tier">
                            <path d="M 70 260 L 70 320 C 70 340, 230 340, 230 320 L 230 260" fill="url(#pink-body-grad)" />
                            <path d="M 70 260 C 70 280, 230 280, 230 260 C 230 240, 70 240, 70 260" fill="#F48FB1" />
                            <ellipse cx="150" cy="260" rx="60" ry="8" fill="#4E342E" opacity="0.15" filter="url(#soft-blur)" />
                        </g>
                        <g id="top-tier" transform="translate(0, 10)">
                            <path d="M 85 200 L 85 250 C 85 265, 215 265, 215 250 L 215 200" fill="url(#pink-body-grad)" />
                            <path d="M 85 200 C 85 215, 215 215, 215 200 C 215 185, 85 185, 85 200" fill="#F48FB1" />
                        </g>
                        <g id="lower-drip">
                            <path d="M 70 260 L 70 270 Q 70 285, 85 285 Q 95 285, 95 270 Q 95 280, 105 280 Q 115 280, 115 265 Q 115 295, 135 295 Q 155 295, 155 270 Q 155 290, 175 290 Q 195 290, 195 265 Q 195 280, 210 280 Q 225 280, 225 265 L 230 265 L 230 260 C 230 240, 70 240, 70 260 Z" fill="url(#white-frost-grad)" />
                        </g>
                        <g id="upper-drip" transform="translate(0, 10)">
                            <path d="M 85 200 L 85 210 Q 85 225, 100 225 Q 110 225, 110 215 Q 110 235, 130 235 Q 145 235, 145 215 Q 145 230, 160 230 Q 175 230, 175 210 Q 175 225, 195 225 Q 215 225, 215 210 L 215 200 C 215 185, 85 185, 85 200 Z" fill="url(#white-frost-grad)" />
                        </g>
                        <g transform="translate(150, 205)">
                            <g stroke="#B71C1C" stroke-width="0.5">
                                <path d="M -10 -5 Q 0 15 10 -5 Q 10 -20 0 -25 Q -10 -20 -10 -5" fill="#EF5350" />
                                <g transform="translate(-25, 10) rotate(-20)">
                                    <path d="M -8 -4 Q 0 12 8 -4 Q 8 -16 0 -20 Q -8 -16 -8 -4" fill="#EF5350" />
                                </g>
                                <g transform="translate(25, 10) rotate(20)">
                                    <path d="M -8 -4 Q 0 12 8 -4 Q 8 -16 0 -20 Q -8 -16 -8 -4" fill="#EF5350" />
                                </g>
                            </g>
                            <g fill="#FFEB3B" opacity="0.6">
                                <circle cx="0" cy="-10" r="0.8"/><circle cx="-5" cy="-5" r="0.8"/><circle cx="5" cy="-5" r="0.8"/>
                                <circle cx="-25" cy="5" r="0.8"/><circle cx="25" cy="5" r="0.8"/>
                            </g>
                            <g fill="#3F51B5">
                                <circle cx="-15" cy="5" r="6" />
                                <circle cx="15" cy="5" r="6" />
                                <circle cx="0" cy="8" r="7" />
                            </g>
                        </g>
                        ${this.getCandles(150, 185)}
                    </svg>
                `;
            },

            // 4. Red Velvet (Love)
            getRedVelvetCake() {
                return `
                    <svg viewBox="0 0 300 400" xmlns="http://www.w3.org/2000/svg" class="w-64 h-auto mx-auto">
                        <defs>
                            <linearGradient id="red-body-grad" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#D32F2F" />
                                <stop offset="50%" style="stop-color:#C62828" />
                                <stop offset="100%" style="stop-color:#8E0000" />
                            </linearGradient>
                            <linearGradient id="cream-grad" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#FFF" />
                                <stop offset="100%" style="stop-color:#E0E0E0" />
                            </linearGradient>
                            <filter id="shadow-blur">
                                <feGaussianBlur in="SourceAlpha" stdDeviation="2" />
                            </filter>
                        </defs>
                        <ellipse cx="150" cy="350" rx="90" ry="10" fill="#5D4037" opacity="0.4" filter="url(#shadow-blur)" />
                        <ellipse cx="150" cy="345" rx="85" ry="15" fill="#FBC02D" />
                        <path d="M 65 345 L 65 350 C 65 360, 235 360, 235 350 L 235 345" fill="#F57F17" />
                        <g id="bottom-tier">
                            <path d="M 70 260 L 70 330 C 70 350, 230 350, 230 330 L 230 260" fill="url(#red-body-grad)" />
                            <path d="M 70 260 C 70 280, 230 280, 230 260 C 230 240, 70 240, 70 260" fill="#B71C1C" />
                            <path d="M 70 280 C 70 300, 230 300, 230 280" fill="none" stroke="url(#cream-grad)" stroke-width="4" opacity="0.95"/>
                            <path d="M 70 305 C 70 325, 230 325, 230 305" fill="none" stroke="url(#cream-grad)" stroke-width="4" opacity="0.95"/>
                            <ellipse cx="150" cy="260" rx="55" ry="10" fill="#000" opacity="0.3" filter="url(#shadow-blur)" />
                        </g>
                        <g id="top-tier" transform="translate(0, 20)">
                            <path d="M 100 180 L 100 240 C 100 255, 200 255, 200 240 L 200 180" fill="url(#red-body-grad)" />
                            <path d="M 100 180 C 100 195, 200 195, 200 180 C 200 165, 100 165, 100 180" fill="#E57373" />
                            <path d="M 100 210 C 100 225, 200 225, 200 210" fill="none" stroke="url(#cream-grad)" stroke-width="3" opacity="0.95"/>
                            <g transform="translate(0, 5)" opacity="0.2">
                                <path d="M 102 242 C 102 257, 198 257, 198 242" stroke="#000" stroke-width="6" stroke-dasharray="0 8" stroke-linecap="round" fill="none" />
                            </g>
                            <path d="M 102 242 C 102 257, 198 257, 198 242" stroke="#FFF" stroke-width="6" stroke-dasharray="0 8" stroke-linecap="round" fill="none" />
                            <g fill="#FFF" filter="drop-shadow(0 2px 2px rgba(0,0,0,0.2))">
                                <circle cx="110" cy="180" r="5"/> <circle cx="130" cy="185" r="5"/>
                                <circle cx="150" cy="187" r="5"/> <circle cx="170" cy="185" r="5"/>
                                <circle cx="190" cy="180" r="5"/> <circle cx="120" cy="170" r="5"/>
                                <circle cx="140" cy="165" r="5"/> <circle cx="160" cy="165" r="5"/>
                                <circle cx="180" cy="170" r="5"/>
                            </g>
                        </g>
                        ${this.getCandles(150, 180)}
                        ${this.getCandles(120, 185)}
                        ${this.getCandles(180, 185)}
                    </svg>
                `;
            },

            // 5. Dark Chocolate (Midnight)
            getChocolateCake() {
                return `
                    <svg viewBox="0 0 350 400" xmlns="http://www.w3.org/2000/svg" class="w-64 h-auto mx-auto">
                        <defs>
                            <linearGradient id="sponge-grad" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#2D1B1E" />
                                <stop offset="40%" style="stop-color:#3E2723" />
                                <stop offset="100%" style="stop-color:#1A0F0F" />
                            </linearGradient>
                            <linearGradient id="cream-grad" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#FFFFFF" />
                                <stop offset="100%" style="stop-color:#ECEFF1" />
                            </linearGradient>
                            <radialGradient id="cherry-grad" cx="35%" cy="35%" r="65%">
                                <stop offset="0%" style="stop-color:#FF5252" />
                                <stop offset="50%" style="stop-color:#D32F2F" />
                                <stop offset="100%" style="stop-color:#880E4F" />
                            </radialGradient>
                            <filter id="cream-shadow">
                                <feGaussianBlur in="SourceAlpha" stdDeviation="1.5" />
                                <feOffset dx="0" dy="2" result="offsetblur"/>
                                <feComponentTransfer>
                                    <feFuncA type="linear" slope="0.3"/>
                                </feComponentTransfer>
                                <feMerge> 
                                    <feMergeNode in="offsetblur"/>
                                    <feMergeNode in="SourceGraphic"/> 
                                </feMerge>
                            </filter>
                            <symbol id="bark-flat" viewBox="0 0 30 15">
                                <path d="M 0 5 L 10 2 L 20 4 L 30 0 L 28 10 L 15 14 L 2 12 Z" fill="#3E2723"/>
                                <path d="M 5 6 L 25 5 M 10 10 L 20 8" stroke="#5D4037" stroke-width="0.5" opacity="0.3"/>
                            </symbol>
                            <symbol id="bark-curl" viewBox="0 0 30 15">
                                <path d="M 2 12 Q 15 0 28 8 L 26 14 Q 15 6 4 14 Z" fill="#4E342E"/>
                                <path d="M 5 10 Q 15 4 25 9" stroke="#6D4C41" stroke-width="1" opacity="0.5" fill="none"/>
                            </symbol>
                            <symbol id="bark-shards" viewBox="0 0 20 20">
                                <path d="M 2 8 L 8 2 L 12 9 Z" fill="#2D1B1E"/>
                                <path d="M 10 12 L 18 6 L 15 15 Z" fill="#3E2723"/>
                                <path d="M 5 15 L 8 18 L 2 19 Z" fill="#4E342E"/>
                            </symbol>
                        </defs>
                        <ellipse cx="175" cy="340" rx="100" ry="12" fill="#1A0F0F" opacity="0.4" filter="url(#cream-shadow)" />
                        <g id="cake-foundation">
                            <path d="M 75 220 L 75 310 C 75 340, 275 340, 275 310 L 275 220" fill="url(#sponge-grad)" />
                            <path d="M 75 220 C 75 250, 275 250, 275 220 C 275 190, 75 190, 75 220" fill="#2D1B1E" />
                        </g>
                        <g id="texture-layer" filter="drop-shadow(1px 2px 2px rgba(0,0,0,0.3))">
                            <use href="#bark-flat" x="80" y="225" width="40" height="20" transform="rotate(-10 100 235)" fill="#1A0F0F"/>
                            <use href="#bark-flat" x="130" y="240" width="45" height="22" transform="rotate(5 152 251)" fill="#2D1B1E"/>
                            <use href="#bark-flat" x="180" y="230" width="40" height="20" transform="rotate(-5 200 240)" fill="#1A0F0F"/>
                            <use href="#bark-flat" x="220" y="250" width="42" height="21" transform="rotate(8 241 260)" fill="#2D1B1E"/>
                            <use href="#bark-curl" x="90" y="260" width="35" height="17" transform="rotate(15 107 268)"/>
                            <use href="#bark-curl" x="140" y="270" width="38" height="19" transform="rotate(-5 159 279)"/>
                            <use href="#bark-curl" x="190" y="265" width="36" height="18" transform="rotate(10 208 274)"/>
                            <use href="#bark-curl" x="235" y="225" width="30" height="15" transform="rotate(-20 250 232)"/>
                            <use href="#bark-curl" x="110" y="225" width="32" height="16" transform="rotate(-15 126 233)"/>
                            <use href="#bark-shards" x="100" y="290" width="25" height="25" />
                            <use href="#bark-shards" x="160" y="285" width="20" height="20" transform="rotate(45 170 295)"/>
                            <use href="#bark-shards" x="220" y="280" width="22" height="22" transform="rotate(-30 231 291)"/>
                            <use href="#bark-flat" x="120" y="285" width="30" height="15" transform="rotate(30 135 292)" fill="#4E342E"/>
                            <use href="#bark-shards" x="85" y="215" width="15" height="15" />
                            <use href="#bark-shards" x="255" y="210" width="15" height="15" />
                        </g>
                        <g id="bottom-cream" transform="translate(0, 8)">
                            <g fill="url(#cream-grad)" filter="url(#cream-shadow)">
                                <circle cx="85" cy="310" r="14" />
                                <circle cx="105" cy="318" r="14" />
                                <circle cx="130" cy="324" r="14" />
                                <circle cx="155" cy="328" r="14" />
                                <circle cx="180" cy="330" r="14" />
                                <circle cx="205" cy="328" r="14" />
                                <circle cx="230" cy="324" r="14" />
                                <circle cx="250" cy="318" r="14" />
                                <circle cx="265" cy="310" r="14" />
                            </g>
                        </g>
                        <g id="top-cream">
                            <g fill="url(#cream-grad)" filter="url(#cream-shadow)">
                                <g opacity="0.8">
                                    <circle cx="100" cy="200" r="12" />
                                    <circle cx="125" cy="195" r="12" />
                                    <circle cx="150" cy="192" r="12" />
                                    <circle cx="175" cy="190" r="12" />
                                    <circle cx="200" cy="192" r="12" />
                                    <circle cx="225" cy="195" r="12" />
                                    <circle cx="250" cy="200" r="12" />
                                </g>
                                <circle cx="85" cy="215" r="14" />
                                <circle cx="105" cy="225" r="14" />
                                <circle cx="130" cy="235" r="14" />
                                <circle cx="160" cy="240" r="14" />
                                <circle cx="190" cy="238" r="14" />
                                <circle cx="220" cy="230" r="14" />
                                <circle cx="245" cy="220" r="14" />
                                <circle cx="265" cy="210" r="14" />
                            </g>
                        </g>
                        <g id="cherries" transform="translate(0, 2)">
                            <defs>
                                <g id="single-cherry">
                                    <path d="M 0 0 Q 3 -12 12 -8" stroke="#3E2723" stroke-width="1.5" fill="none" transform="translate(0, -8)"/>
                                    <circle cx="0" cy="0" r="9" fill="url(#cherry-grad)" />
                                    <ellipse cx="-3" cy="-3" rx="3" ry="1.5" fill="white" opacity="0.7" transform="rotate(-45)"/>
                                </g>
                            </defs>
                            <use href="#single-cherry" x="100" y="195" />
                            <use href="#single-cherry" x="125" y="190" />
                            <use href="#single-cherry" x="150" y="187" />
                            <use href="#single-cherry" x="175" y="185" />
                            <use href="#single-cherry" x="200" y="187" />
                            <use href="#single-cherry" x="225" y="190" />
                            <use href="#single-cherry" x="250" y="195" />
                            <use href="#single-cherry" x="85" y="210" />
                            <use href="#single-cherry" x="105" y="220" />
                            <use href="#single-cherry" x="130" y="230" />
                            <use href="#single-cherry" x="160" y="235" />
                            <use href="#single-cherry" x="190" y="233" />
                            <use href="#single-cherry" x="220" y="225" />
                            <use href="#single-cherry" x="245" y="215" />
                            <use href="#single-cherry" x="265" y="205" />
                        </g>
                        ${this.getCandles(175, 220)}
                    </svg>
                `;
            }
        };

        const App = {
            State: {
                user: null,
                isPremium: false,
                currentTheme: 'classic',
                editingId: null,
                lastDonationCheck: new Date(Date.now() - 60000).toISOString(),
                processedDonations: new Set(),
                pendingDonationAmount: 0 // Store amount for modal flow
            },

            UI: {
                toast(msg, type = 'success') {
                    const container = document.getElementById('toast-container');
                    const el = document.createElement('div');
                    el.className = `toast ${type}`;
                    const icon = type === 'error' ? 'fa-exclamation-circle' : 'fa-check-circle';
                    el.innerHTML = `<i class="fas ${icon} text-lg"></i><span>${msg}</span>`;
                    container.appendChild(el);
                    requestAnimationFrame(() => el.classList.add('show'));
                    setTimeout(() => {
                        el.classList.remove('show');
                        setTimeout(() => el.remove(), 400);
                    }, 3000);
                },

                setLoading(btn, isLoading, text = 'Loading...') {
                    if (isLoading) {
                        btn.dataset.originalText = btn.innerHTML;
                        btn.disabled = true;
                        btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> ${text}`;
                    } else {
                        btn.disabled = false;
                        btn.innerHTML = btn.dataset.originalText || 'Submit';
                    }
                },

                renderThemes() {
                    const themes = [
                        { id: 'classic', name: 'Classic', color: 'from-purple-500 to-pink-500', premium: false },
                        { id: 'ocean', name: 'Ocean', color: 'from-blue-400 to-indigo-600', premium: false },
                        { id: 'sunshine', name: 'Sunshine', color: 'from-yellow-400 to-orange-500', premium: false },
                        { id: 'midnight', name: 'Midnight üåô', color: 'from-slate-900 to-slate-700', premium: true },
                        { id: 'love', name: 'Love ‚ù§Ô∏è', color: 'from-red-500 to-rose-600', premium: true }
                    ];

                    const container = document.getElementById('theme-selector');
                    if (!container) return;

                    container.innerHTML = themes.map(t => `
                        <div class="theme-card relative group cursor-pointer overflow-hidden rounded-xl h-24 ${App.State.currentTheme === t.id ? 'active' : ''}" 
                             onclick="App.Controllers.selectTheme('${t.id}', ${t.premium})">
                            <div class="absolute inset-0 bg-gradient-to-br ${t.color} opacity-80 group-hover:opacity-100 transition"></div>
                            ${t.premium ? `<div class="premium-lock absolute inset-0 bg-black/40 z-10 flex items-center justify-center ${App.State.isPremium ? 'hidden' : ''}"><i class="fas fa-lock text-white"></i></div>` : ''}
                            <div class="check-icon absolute inset-0 flex items-center justify-center ${App.State.currentTheme === t.id ? 'flex' : 'hidden'} z-20">
                                <div class="bg-white text-brand-pink rounded-full w-8 h-8 flex items-center justify-center shadow-md animate-bounce-in"><i class="fas fa-check"></i></div>
                            </div>
                            <div class="absolute bottom-2 w-full text-center text-white text-xs font-bold shadow-sm z-10">${t.name}</div>
                        </div>
                    `).join('');
                },

                showDonationPopup(donation) {
                    const container = document.getElementById('donation-popup-container');
                    const card = document.createElement('div');
                    card.className = "donation-card";
                    card.innerHTML = `
                        <div class="w-10 h-10 rounded-full bg-yellow-100 text-yellow-600 flex items-center justify-center text-lg shadow-sm">‚òï</div>
                        <div>
                            <div class="text-xs text-gray-400 font-bold uppercase tracking-wider mb-0.5">New Supporter</div>
                            <div class="text-sm font-bold text-brand-navy">
                                ${donation.donor_name} <span class="font-normal text-gray-500">donated</span> ‚Çπ${donation.amount}
                            </div>
                            <div class="text-[10px] text-gray-400 mt-0.5">${Utils.timeAgo(donation.created_at)}</div>
                        </div>
                    `;
                    container.appendChild(card);
                    setTimeout(() => {
                        card.style.opacity = '0';
                        card.style.transform = 'translateX(-20px)';
                        setTimeout(() => card.remove(), 500);
                    }, 6000);
                },

                renderWallOfLove(notes) {
                    const container = document.getElementById('wall-of-love-grid');
                    if (!container) return;

                    if (!notes || notes.length === 0) {
                        container.innerHTML = `
                            <div class="col-span-3 text-center py-10 bg-gray-50 rounded-3xl border border-dashed border-gray-200">
                                <div class="text-4xl mb-4">üíå</div>
                                <p class="text-gray-500 font-medium">Be the first to leave a note this week!</p>
                                <button onclick="App.Services.buyCoffee(50)" class="mt-4 text-brand-pink font-bold hover:underline text-sm">Send a Gift & Note &rarr;</button>
                            </div>
                        `;
                        return;
                    }

                    const colors = ['bg-pink-100', 'bg-purple-100', 'bg-blue-100', 'bg-yellow-100', 'bg-green-100'];

                    container.innerHTML = notes.map((note, index) => `
                        <div class="bg-brand-bg p-8 rounded-2xl relative border border-gray-100 hover:shadow-lg transition duration-300">
                            <div class="text-4xl text-brand-pink opacity-20 absolute top-4 left-4">‚ùù</div>
                            <p class="text-gray-600 mb-6 italic relative z-10 text-sm leading-relaxed min-h-[60px]">"${note.note}"</p>
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 ${colors[index % colors.length]} rounded-full flex items-center justify-center font-bold text-gray-700 shadow-sm text-sm">
                                    ${note.donor_name.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <div class="font-bold text-brand-navy text-sm truncate max-w-[150px]">${note.donor_name}</div>
                                    <div class="text-xs text-gray-400 font-medium">${Utils.timeAgo(note.created_at)}</div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                },

                toggleDonationModal(show) {
                    const modal = document.getElementById('donation-modal');
                    if (show) {
                        modal.classList.remove('modal-hidden');
                        modal.classList.add('modal-visible');
                        document.getElementById('donation-note-input').focus();
                    } else {
                        modal.classList.remove('modal-visible');
                        modal.classList.add('modal-hidden');
                        document.getElementById('donation-note-input').value = ''; // Reset input
                    }
                }
            },

            Services: {
                supabase: null,

                init() {
                    if (typeof CONFIG === 'undefined') {
                        App.UI.toast('Config missing!', 'error');
                        return;
                    }
                    this.supabase = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);

                    this.supabase.auth.onAuthStateChange((event, session) => {
                        App.State.user = session?.user || null;
                        App.Controllers.updateNav();
                        App.Services.checkPremium();
                        if (App.State.user && window.location.hash === '#login') {
                            const returnTo = sessionStorage.getItem('return_to') || 'dashboard';
                            sessionStorage.removeItem('return_to');
                            App.Router.go(returnTo);
                        }
                    });

                    this.pollRecentDonations();
                    this.fetchWallOfLove(); // Initial Load
                    setInterval(() => this.pollRecentDonations(), 10000);
                },

                async login() {
                    const { error } = await this.supabase.auth.signInWithOAuth({
                        provider: 'google',
                        options: { redirectTo: window.location.origin }
                    });
                    if (error) App.UI.toast(error.message, 'error');
                },

                async logout() {
                    await this.supabase.auth.signOut();
                    App.UI.toast('Logged out successfully');
                    App.Router.go('home');
                },

                async uploadImage(file) {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('upload_preset', CONFIG.CLOUDINARY_PRESET);
                    const res = await fetch(`https://api.cloudinary.com/v1_1/${CONFIG.CLOUDINARY_CLOUD_NAME}/image/upload`, { method: 'POST', body: formData });
                    if (!res.ok) throw new Error('Upload failed');
                    const data = await res.json();
                    return data.secure_url;
                },

                async checkPremium() {
                    if (!App.State.user) {
                        App.State.isPremium = false;
                        App.Services.updatePremiumUI();
                        return;
                    }
                    const { data, error } = await this.supabase
                        .from('premiums')
                        .select('is_active')
                        .eq('user_id', App.State.user.id)
                        .eq('is_active', true)
                        .maybeSingle();
                    App.State.isPremium = !!data;
                    App.Services.updatePremiumUI();
                },

                updatePremiumUI() {
                    const banner = document.getElementById('premium-banner');
                    const isPrem = App.State.isPremium;
                    if (isPrem) {
                        document.querySelectorAll('.premium-lock').forEach(el => el.classList.add('hidden'));
                        if (banner) banner.classList.add('hidden');
                    } else {
                        if (banner) banner.classList.remove('hidden');
                        document.querySelectorAll('.premium-lock').forEach(el => el.classList.remove('hidden'));
                    }
                    if (window.location.hash === '#create') {
                        App.UI.renderThemes();
                    }
                },

                async fetchUserDonationTotal() {
                    if (!App.State.user) return 0;
                    const { data, error } = await this.supabase
                        .from('donations')
                        .select('amount')
                        .eq('user_id', App.State.user.id);
                    if (error || !data) return 0;
                    return data.reduce((sum, item) => sum + item.amount, 0);
                },

                buyPremium() {
                    if (!App.State.user) return App.UI.toast("Please login first");
                    this.triggerPayment(4900, "WishLink Premium", "Lifetime Unlock", async (paymentId) => {
                        const { error } = await this.supabase.from('premiums').insert([{
                            user_id: App.State.user.id,
                            is_active: true,
                            plan_type: 'lifetime',
                            payment_id: paymentId
                        }]);
                        if (error) {
                            App.UI.toast("Payment verified but activation failed. Contact support.", "error");
                        } else {
                            App.UI.toast("Premium Unlocked Forever! üëë");
                            App.Services.checkPremium();
                        }
                    });
                },

                async pollRecentDonations() {
                    const { data, error } = await this.supabase
                        .from('donations')
                        .select('id, donor_name, amount, created_at')
                        .gt('created_at', App.State.lastDonationCheck)
                        .order('created_at', { ascending: true });

                    if (!error && data && data.length > 0) {
                        App.State.lastDonationCheck = data[data.length - 1].created_at;
                        data.forEach((donation, index) => {
                            if (!App.State.processedDonations.has(donation.id)) {
                                App.State.processedDonations.add(donation.id);
                                setTimeout(() => {
                                    App.UI.showDonationPopup(donation);
                                }, index * 2000);
                            }
                        });
                        // Refresh Wall of Love too if new donation comes in
                        this.fetchWallOfLove();
                    }
                },

                async fetchWallOfLove() {
                    // Get donations from last 7 days with a note
                    const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();

                    const { data, error } = await this.supabase
                        .from('donations')
                        .select('donor_name, note, created_at')
                        .neq('note', null) // Filter out empty notes
                        .gt('created_at', sevenDaysAgo)
                        .order('created_at', { ascending: false })
                        .limit(7);

                    if (!error) {
                        App.UI.renderWallOfLove(data);
                    }
                },

                buyCoffee(amount) {
                    if (!App.State.user) return App.UI.toast("Please login to donate ‚ù§Ô∏è", "error");

                    // REPLACED PROMPT WITH MODAL FLOW
                    App.State.pendingDonationAmount = amount;
                    document.getElementById('donate-amount-display').textContent = `‚Çπ${amount}`;
                    App.UI.toggleDonationModal(true);
                },

                triggerPayment(amount, name, desc, successCallback) {
                    if (typeof Razorpay === 'undefined' || !CONFIG.RAZORPAY_KEY) {
                        App.UI.toast("Dev Mode: Simulating Payment Success ‚úÖ", "success");
                        successCallback("simulated_pay_id_123");
                        return;
                    }
                    const options = {
                        key: CONFIG.RAZORPAY_KEY, amount: amount, currency: "INR",
                        name: name, description: desc,
                        handler: function (response) {
                            successCallback(response.razorpay_payment_id);
                        }
                    };
                    const rzp = new Razorpay(options);
                    rzp.open();
                }
            },

            Router: {
                init() {
                    window.addEventListener('hashchange', this.handleRoute.bind(this));
                    window.addEventListener('load', this.handleRoute.bind(this));
                },

                go(route) { window.location.hash = `#${route}`; },

                handleRoute() {
                    App.Audio.stopAll();

                    const hash = window.location.hash.slice(1) || 'home';
                    const [route, param] = hash.split('/');

                    document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));

                    const activeView = document.getElementById(`view-${route}`);
                    if (activeView) {
                        activeView.classList.remove('hidden');
                        activeView.classList.add('animate-fade-in');
                        window.scrollTo(0, 0);
                    }

                    if (route === 'dashboard') App.Controllers.loadDashboard();

                    if (route === 'create') {
                        if (!App.State.editingId) {
                            document.getElementById('create-form').reset();
                            document.getElementById('submit-btn').innerHTML = 'Gift this Wish üéÅ';
                            document.getElementById('create-title').innerText = 'Create a New Wish ‚ú®';
                            document.getElementById('file-upload-text').textContent = 'Click to upload';
                            document.getElementById('file-upload-text').className = 'text-sm text-gray-500 font-medium';
                            App.State.currentTheme = 'classic';
                        }
                        App.Services.checkPremium();
                        App.UI.renderThemes();
                    }

                    if (route === 'wish' && param) App.Controllers.loadWish(param);
                    if (route === 'login' && App.State.user) this.go('dashboard');
                }
            },

            Controllers: {
                updateNav() {
                    const container = document.getElementById('nav-auth-container');
                    if (App.State.user) {
                        container.innerHTML = `
                            <button onclick="App.Router.go('dashboard')" class="text-brand-navy hover:text-brand-pink transition font-bold"><i class="fas fa-user-circle"></i> Dashboard</button>
                            <button onclick="App.Services.logout()" class="text-red-400 hover:text-red-600 transition"><i class="fas fa-sign-out-alt"></i></button>
                        `;
                    } else {
                        container.innerHTML = `<button onclick="App.Router.go('login')" class="text-brand-navy hover:text-brand-pink transition font-bold">Login</button>`;
                    }
                },

                // --- NEW DONATION HANDLER ---
                processDonation() {
                    const note = document.getElementById('donation-note-input').value;
                    const amount = App.State.pendingDonationAmount || 50;

                    // Close Modal immediately
                    App.UI.toggleDonationModal(false);

                    App.Services.triggerPayment(amount * 100, "Buy us a Coffee", "Support WishLink", async (paymentId) => {
                        const { error } = await App.Services.supabase.from('donations').insert([{
                            user_id: App.State.user.id,
                            amount: amount,
                            donor_name: App.State.user.user_metadata.full_name || App.State.user.email.split('@')[0],
                            message: "Bought a coffee ‚òï",
                            note: note || null, // Save the note from modal
                            payment_id: paymentId
                        }]);

                        if (error) {
                            console.error(error);
                            App.UI.toast("Donation recorded (Offline mode)", "success");
                        } else {
                            App.UI.toast("Thank you for the coffee & note! ‚ù§Ô∏è");
                            App.Services.fetchWallOfLove(); // Refresh wall
                        }
                    });
                },

                selectTheme(id, isPremium) {
                    if (isPremium && !App.State.isPremium) {
                        App.UI.toast("This theme requires Premium upgrade üëë", "error");
                        return;
                    }
                    App.State.currentTheme = id;
                    App.UI.renderThemes();
                },

                async editWish(id) {
                    const btn = document.querySelector(`button[onclick="App.Controllers.editWish('${id}')"]`);
                    const icon = btn.innerHTML;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

                    const { data, error } = await App.Services.supabase
                        .from('wishes').select('*').eq('id', id).single();

                    btn.innerHTML = icon;

                    if (error) return App.UI.toast("Error loading wish", "error");

                    App.State.editingId = id;
                    App.State.currentTheme = data.theme;
                    document.getElementById('recipient').value = data.recipient_name;
                    document.getElementById('message').value = data.message;
                    document.getElementById('create-title').innerText = 'Edit Wish ‚úèÔ∏è';
                    document.getElementById('submit-btn').innerHTML = 'Update Wish üíæ';
                    if (data.image_url) {
                        document.getElementById('file-upload-text').textContent = "Image Attached (Upload to replace)";
                        document.getElementById('file-upload-text').className = "text-brand-pink font-bold";
                    }
                    App.Router.go('create');
                },

                async handleCreate(e) {
                    e.preventDefault();
                    if (!App.State.user) {
                        App.UI.toast("Please login");
                        App.Router.go('login');
                        return;
                    }

                    const btn = document.getElementById('submit-btn');
                    const isEdit = !!App.State.editingId;
                    App.UI.setLoading(btn, true, isEdit ? "Updating..." : "Wrapping Gift...");

                    try {
                        const fileInput = document.getElementById('image-upload');
                        let imgUrl = null;

                        if (fileInput.files.length) {
                            App.UI.setLoading(btn, true, "Uploading Photo...");
                            imgUrl = await App.Services.uploadImage(fileInput.files[0]);
                        }

                        const payload = {
                            recipient_name: document.getElementById('recipient').value,
                            message: document.getElementById('message').value,
                            theme: App.State.currentTheme,
                            creator_id: App.State.user.id
                        };
                        if (imgUrl) payload.image_url = imgUrl;

                        let result;
                        if (isEdit) {
                            result = await App.Services.supabase
                                .from('wishes')
                                .update(payload)
                                .eq('id', App.State.editingId)
                                .select()
                                .single();
                            App.UI.toast("Wish Updated Successfully! üéâ");
                        } else {
                            result = await App.Services.supabase
                                .from('wishes')
                                .insert([payload])
                                .select()
                                .single();
                        }

                        if (result.error) throw result.error;

                        App.Controllers.showShareModal(result.data.id);
                        App.State.editingId = null;
                        document.getElementById('create-form').reset();
                        App.State.currentTheme = 'classic';
                        App.UI.renderThemes();

                    } catch (err) {
                        App.UI.toast(err.message || "Something went wrong", "error");
                    } finally {
                        App.UI.setLoading(btn, false);
                    }
                },

                showShareModal(id) {
                    const url = `${window.location.origin}/#wish/${id}`;
                    const modal = document.createElement('div');
                    modal.className = "fixed inset-0 bg-brand-navy/80 backdrop-blur-sm flex items-center justify-center z-[100] p-4";
                    modal.innerHTML = `
                        <div class="bg-white rounded-3xl p-8 max-w-md w-full text-center animate-bounce-in shadow-2xl relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-brand-pink to-brand-navy"></div>
                            <h3 class="text-2xl font-bold text-brand-navy mb-2">Ready to Gift! üéâ</h3>
                            <div class="bg-gray-50 p-4 rounded-xl flex items-center mb-6 border border-gray-200 mt-4">
                                <input type="text" value="${url}" readonly class="bg-transparent flex-1 outline-none text-sm text-gray-600 truncate font-mono">
                                <button onclick="navigator.clipboard.writeText('${url}'); App.UI.toast('Copied!')" class="ml-3 text-brand-pink font-bold text-xs uppercase">Copy</button>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <a href="whatsapp://send?text=${encodeURIComponent('Happy Birthday! üéÇ ' + url)}" class="py-3 bg-[#25D366] text-white rounded-xl font-bold text-sm flex items-center justify-center gap-2 hover:opacity-90"><i class="fab fa-whatsapp"></i> WhatsApp</a>
                                <button onclick="window.location.href='${url}'" class="py-3 bg-brand-navy text-white rounded-xl font-bold text-sm flex items-center justify-center gap-2 hover:opacity-90">Open Wish</button>
                            </div>
                            <button onclick="this.closest('.fixed').remove(); App.Router.go('dashboard')" class="mt-4 text-xs text-gray-400 font-bold hover:text-gray-600">Close</button>
                        </div>
                    `;
                    document.body.appendChild(modal);
                },

                async loadDashboard() {
                    if (!App.State.user) return App.Router.go('login');

                    const list = document.getElementById('my-wishes-list');
                    list.innerHTML = '<div class="text-center py-10"><i class="fas fa-spinner fa-spin text-brand-pink text-2xl"></i></div>';

                    App.Services.checkPremium();
                    const totalDonation = await App.Services.fetchUserDonationTotal();
                    document.getElementById('user-total-donation').innerText = `‚Çπ${totalDonation}`;

                    const { data, error } = await App.Services.supabase
                        .from('wishes').select('*').eq('creator_id', App.State.user.id).order('created_at', { ascending: false });

                    if (!data || data.length === 0) {
                        list.innerHTML = `<div class="text-center py-10 border-2 border-dashed rounded-xl bg-gray-50 text-gray-400">No wishes yet. Create one!</div>`;
                        return;
                    }

                    list.innerHTML = data.map(w => `
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center hover:shadow-md transition">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-full bg-pink-50 flex items-center justify-center text-xl">üéÇ</div>
                                <div>
                                    <h4 class="font-bold text-brand-navy">${w.recipient_name}</h4>
                                    <a href="#wish/${w.id}" class="text-xs text-brand-pink hover:underline">View Wish</a>
                                </div>
                            </div>
                            <div class="flex items-center gap-1">
                                <button onclick="App.Controllers.editWish('${w.id}')" class="text-gray-400 hover:text-brand-navy transition p-2 rounded-lg hover:bg-gray-100" title="Edit"><i class="fas fa-pen"></i></button>
                                <button onclick="App.Controllers.deleteWish('${w.id}')" class="text-gray-400 hover:text-red-500 transition p-2 rounded-lg hover:bg-red-50" title="Delete"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    `).join('');
                },

                async deleteWish(id) {
                    if (!confirm("Delete this wish?")) return;
                    await App.Services.supabase.from('wishes').delete().eq('id', id);
                    this.loadDashboard();
                    App.UI.toast("Wish deleted");
                },

                async loadWish(id) {
                    const container = document.getElementById('wish-content');
                    container.innerHTML = '<div class="text-white flex flex-col items-center gap-4"><i class="fas fa-birthday-cake fa-bounce text-5xl"></i><p>Baking the cake...</p></div>';

                    const { data, error } = await App.Services.supabase.from('wishes').select('*').eq('id', id).single();

                    if (error || !data) {
                        container.innerHTML = '<div class="text-white text-xl">Wish not found üò¢</div>';
                        return;
                    }

                    const view = document.getElementById('view-wish');
                    view.className = "view-section min-h-screen w-full relative overflow-hidden flex flex-col items-center justify-center";

                    if (data.theme === 'love') view.classList.add('bg-love');
                    else if (data.theme === 'midnight') view.classList.add('bg-midnight');
                    else {
                        const colors = { classic: 'from-purple-500 to-pink-500', ocean: 'from-blue-400 to-indigo-600', sunshine: 'from-yellow-400 to-orange-500' };
                        view.classList.add('bg-gradient-to-br');
                        const grad = colors[data.theme] || colors.classic;
                        grad.split(' ').forEach(c => view.classList.add(c));
                    }

                    let cakeSVG;
                    switch (data.theme) {
                        case 'love': cakeSVG = CakeFactory.getRedVelvetCake(); break;
                        case 'midnight': cakeSVG = CakeFactory.getChocolateCake(); break;
                        case 'sunshine': cakeSVG = CakeFactory.getCarrotCake(); break;
                        case 'ocean': cakeSVG = CakeFactory.getBerryCake(); break;
                        default: cakeSVG = CakeFactory.getSimpleCake(); break;
                    }

                    let particles = '';
                    if (data.theme === 'love') {
                        for (let i = 0; i < 6; i++) particles += `<div class="floating-heart text-white/30 text-4xl" style="left:${Math.random() * 100}%; animation-delay:${Math.random() * 5}s">‚ù§Ô∏è</div>`;
                    } else if (data.theme === 'midnight') {
                        for (let i = 0; i < 30; i++) particles += `<div class="star-twinkle" style="top:${Math.random() * 100}%; left:${Math.random() * 100}%; width:${Math.random() * 3}px; height:${Math.random() * 3}px; --duration:${2 + Math.random() * 3}s"></div>`;
                    }

                    const cardClass = data.theme === 'midnight' ? 'bg-white/10 border-white/20 text-white' : 'bg-white/90 border-white/50 text-brand-navy';

                    container.innerHTML = `
                        ${particles}
                        <div id="phase-1" class="text-center z-20 transition-all duration-700 flex flex-col items-center">
                            <h1 class="text-4xl md:text-6xl font-extrabold text-white mb-8 drop-shadow-lg font-cursive animate-slide-up">
                                Happy Birthday <br> <span class="text-yellow-300">${data.recipient_name}</span>!
                            </h1>
                            <div class="relative cursor-pointer hover:scale-105 transition duration-300 inline-block mt-8 animate-bounce-in" onclick="App.Controllers.blowCandle()">
                                ${cakeSVG}
                            </div>
                            <div class="mt-8 flex flex-wrap justify-center gap-4 animate-slide-up" style="animation-delay: 0.2s">
                                <button id="mic-btn" onclick="App.Audio.initMic(App.Controllers.blowCandle)" class="bg-white text-brand-navy px-6 py-3 rounded-full font-bold shadow-lg hover:scale-105 transition flex items-center gap-2 border-2 border-transparent">
                                    <i class="fas fa-microphone"></i> Enable Mic to Blow
                                </button>
                                <button onclick="App.Controllers.blowCandle()" class="bg-white/20 text-white backdrop-blur-sm px-6 py-3 rounded-full font-bold shadow-lg hover:bg-white/30 transition border border-white/40">
                                    üëá Tap to Wish
                                </button>
                            </div>
                        </div>
                        <div id="phase-2" class="hidden opacity-0 transform translate-y-10 transition-all duration-1000 z-20 max-w-lg w-full px-4">
                            <div class="${cardClass} backdrop-blur-xl rounded-3xl p-8 shadow-2xl border relative text-center">
                                ${data.image_url ? `<img src="${data.image_url}" class="w-32 h-32 rounded-full mx-auto mb-6 object-cover border-4 border-white shadow-lg">` : ''}
                                <p class="text-xl md:text-3xl font-cursive mb-6">"${data.message}"</p>
                                <div class="flex items-center justify-center gap-3 opacity-60 text-xs font-bold uppercase tracking-widest mb-6">
                                    <span class="h-px w-8 bg-current"></span> With Love <span class="h-px w-8 bg-current"></span>
                                </div>
                                <a href="#create" class="inline-block px-6 py-3 bg-brand-pink text-white rounded-full font-bold shadow-lg text-sm hover:scale-105 transition">Create your own</a>
                            </div>
                        </div>
                    `;

                    const playMusic = () => {
                        App.Audio.startMusic();
                        document.body.removeEventListener('click', playMusic);
                        document.body.removeEventListener('touchstart', playMusic);
                    };
                    document.body.addEventListener('click', playMusic);
                    document.body.addEventListener('touchstart', playMusic);
                },

                blowCandle() {
                    const flames = document.querySelectorAll('.flame');
                    if (flames.length === 0 || flames[0].classList.contains('hidden')) return;

                    flames.forEach(flame => flame.classList.add('flame-out'));
                    App.Audio.stopMic();

                    const bg = document.getElementById('bg-music');
                    const cheer = document.getElementById('cheer-audio');
                    bg.pause();
                    cheer.play();

                    App.Controllers.startConfetti();

                    setTimeout(() => {
                        const p1 = document.getElementById('phase-1');
                        const p2 = document.getElementById('phase-2');

                        p1.style.opacity = '0';
                        p1.style.transform = 'scale(0.9)';

                        setTimeout(() => {
                            p1.classList.add('hidden');
                            p2.classList.remove('hidden');
                            requestAnimationFrame(() => {
                                p2.classList.remove('opacity-0', 'translate-y-10');
                            });
                        }, 600);
                    }, 300);
                },

                startConfetti() {
                    const canvas = document.getElementById('confetti-canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;

                    const particles = Array.from({ length: 150 }, () => ({
                        x: Math.random() * canvas.width,
                        y: Math.random() * canvas.height - canvas.height,
                        color: ['#FF0055', '#FFD700', '#00BFFF', '#32CD32'][Math.floor(Math.random() * 4)],
                        size: Math.random() * 8 + 2,
                        speedY: Math.random() * 3 + 2,
                        speedX: Math.random() * 2 - 1
                    }));

                    function loop() {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        particles.forEach(p => {
                            p.y += p.speedY;
                            p.x += p.speedX;
                            ctx.fillStyle = p.color;
                            ctx.fillRect(p.x, p.y, p.size, p.size);
                            if (p.y > canvas.height) p.y = -10;
                        });
                        requestAnimationFrame(loop);
                    }
                    loop();
                }
            }
        };

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            App.Services.init();
            App.Router.init();

            const fileInput = document.getElementById('image-upload');
            if (fileInput) {
                fileInput.onchange = (e) => {
                    const name = e.target.files[0]?.name;
                    document.getElementById('file-upload-text').textContent = name || "Click to upload";
                    document.getElementById('file-upload-text').className = "text-brand-pink font-bold";
                };
            }

            const form = document.getElementById('create-form');
            if (form) form.addEventListener('submit', App.Controllers.handleCreate);
        });
    </script>
</body>

</html>