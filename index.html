<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WishLink - Create Magic Moments</title>
    <link rel="icon" type="image/png" href="favicon.png">

    <!-- External SDKs -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Chewy&family=Varela+Round&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { pink: '#FF0055', navy: '#002366', bg: '#F9FAFB' }
                    },
                    fontFamily: {
                        sans: ['Nunito', 'sans-serif'],
                        cursive: ['Nunito', 'cursive'],
                        chewy: ['Chewy', 'cursive'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'slide-up': 'slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'bounce-in': 'bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55)',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        bounceIn: { '0%': { transform: 'scale(0)' }, '70%': { transform: 'scale(1.1)' }, '100%': { transform: 'scale(1)' } }
                    }
                }
            }
        }
    </script>

    <style>
        /* --- CORE STYLES --- */
        body {
            font-family: 'Nunito', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            scroll-behavior: smooth;
        }

        /* --- FLAME ANIMATIONS --- */
        .flame {
            transform-origin: center bottom;
            animation: flicker 1.5s infinite ease-in-out;
        }

        .flame-out {
            animation: popOut 0.3s forwards !important;
        }

        @keyframes flicker {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.1);
                opacity: 0.9;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes popOut {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.4);
                opacity: 0.8;
            }

            100% {
                transform: scale(0);
                opacity: 0;
            }
        }

        /* --- TOASTS --- */
        #toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            pointer-events: auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 12px 24px;
            border-radius: 50px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            color: #002366;
            transform: translateY(-50px);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid rgba(255, 255, 255, 0.5);
            min-width: 300px;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            border-left: 4px solid #10b981;
        }

        .toast.error {
            border-left: 4px solid #ef4444;
        }

        /* --- UI ELEMENTS --- */
        .btn-gift {
            background: #FF0055;
            box-shadow: 0 4px 14px 0 rgba(255, 0, 85, 0.39);
            transition: all 0.2s ease;
        }

        .btn-gift:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 0, 85, 0.23);
        }

        .btn-gift:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        .theme-card {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .theme-card.active {
            border-color: #FF0055;
            transform: scale(1.02);
            box-shadow: 0 10px 25px -5px rgba(255, 0, 85, 0.25);
        }

        .theme-card.active .check-icon {
            display: flex;
        }

        /* Themes */
        .bg-love {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
        }

        .bg-midnight {
            background: radial-gradient(circle at bottom, #1b2735 0%, #090a0f 100%);
            color: white;
        }

        .floating-heart {
            position: absolute;
            animation: floatUp 8s linear infinite;
            pointer-events: none;
            opacity: 0;
        }

        @keyframes floatUp {
            0% {
                transform: translateY(100vh) scale(0.5);
                opacity: 0;
            }

            20% {
                opacity: 0.6;
            }

            100% {
                transform: translateY(-20vh) scale(1.2);
                opacity: 0;
            }
        }

        .star-twinkle {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle var(--duration) infinite;
            opacity: 0;
        }

        @keyframes twinkle {

            0%,
            100% {
                opacity: 0.2;
                transform: scale(0.8);
            }

            50% {
                opacity: 1;
                transform: scale(1.2);
                box-shadow: 0 0 10px white;
            }
        }
    </style>
</head>

<body
    class="bg-brand-bg text-gray-800 selection:bg-pink-100 selection:text-brand-pink overflow-x-hidden flex flex-col min-h-screen">

    <script src="config.js"></script>
    <div id="toast-container"></div>

    <nav class="fixed top-0 w-full bg-white/90 backdrop-blur-md shadow-sm z-50 h-16 transition-all">
        <div class="max-w-6xl mx-auto px-4 h-full flex items-center justify-between">
            <a href="#home" class="flex items-center gap-2 group">
                <img src="logo.png" onerror="this.src='https://placehold.co/40'" alt="WishLink"
                    class="h-8 w-auto group-hover:scale-105 transition">
                <span class="text-xl font-bold text-brand-navy tracking-tight hidden md:inline">WishLink<span
                        class="text-brand-pink">.app</span></span>
            </a>
            <div class="flex items-center gap-3 md:gap-6 text-sm font-semibold">
                <a href="#create"
                    class="px-4 py-2 bg-white border border-brand-pink text-brand-pink rounded-full hover:bg-pink-50 transition shadow-sm text-xs md:text-sm whitespace-nowrap gap-2 flex items-center">
                    <i class="fas fa-wand-magic-sparkles"></i> Gift Wish
                </a>
                <button onclick="App.Services.buyCoffee(50)"
                    class="text-brand-navy hover:text-brand-pink transition px-2 text-lg" title="Buy us a Coffee"><i
                        class="fas fa-coffee"></i></button>
                <div id="nav-auth-container" class="flex items-center gap-4"></div>
            </div>
        </div>
    </nav>

    <main class="pt-16 flex-grow flex flex-col relative">
        <div id="view-home" class="view-section hidden">
            <!-- Hero -->
            <section class="bg-gradient-to-b from-purple-50 via-white to-white pt-24 pb-20 px-4 text-center">
                <span
                    class="px-4 py-1.5 bg-pink-100 text-brand-pink rounded-full text-[10px] md:text-xs font-bold tracking-wider uppercase mb-6 inline-block shadow-sm animate-slide-up">100%
                    Free Forever</span>
                <h1 class="text-4xl md:text-6xl font-extrabold text-brand-navy mb-6 leading-tight animate-slide-up"
                    style="animation-delay: 0.1s;">
                    Make Their Birthday <br> <span
                        class="text-transparent bg-clip-text bg-gradient-to-r from-brand-pink to-brand-navy">Unforgettable</span>
                </h1>
                <p class="text-base md:text-lg text-gray-600 max-w-2xl mx-auto mb-10 leading-relaxed px-4 animate-slide-up"
                    style="animation-delay: 0.2s;">
                    Create a personalized, interactive birthday website in 30 seconds. Send a link that plays music,
                    blows candles, and delivers your love.
                </p>
                <div class="flex flex-col sm:flex-row gap-4 justify-center px-8 animate-slide-up"
                    style="animation-delay: 0.3s;">
                    <button onclick="App.Router.go('create')"
                        class="btn-gift px-8 py-4 text-white rounded-full font-bold text-lg shadow-xl">Gift this Wish
                        üéÅ</button>
                    <button onclick="App.Router.go('blog')"
                        class="px-8 py-4 bg-white text-gray-700 border border-gray-200 rounded-full font-bold hover:bg-gray-50 transition">Read
                        Ideas</button>
                </div>

                <!-- Demo Preview -->
                <div class="mt-20 max-w-4xl mx-auto bg-white rounded-3xl shadow-2xl overflow-hidden border-[6px] border-white transform -rotate-1 hover:rotate-0 transition duration-700 cursor-pointer group"
                    onclick="App.Router.go('create')">
                    <div class="bg-gray-100 h-10 flex items-center px-4 gap-2 border-b border-gray-200">
                        <div class="w-3 h-3 bg-red-400 rounded-full"></div>
                        <div class="w-3 h-3 bg-yellow-400 rounded-full"></div>
                        <div class="w-3 h-3 bg-green-400 rounded-full"></div>
                    </div>
                    <div
                        class="h-64 md:h-96 bg-gray-50 flex flex-col items-center justify-center text-gray-300 relative overflow-hidden group-hover:bg-gray-100 transition-colors">
                        <i
                            class="fas fa-birthday-cake text-6xl opacity-50 mb-3 text-brand-pink group-hover:scale-110 transition duration-500"></i>
                        <p class="font-bold opacity-50 text-brand-navy">Tap to Create Yours</p>
                    </div>
                </div>
            </section>

            <!-- Testimonials -->
            <section class="py-20 bg-white border-t border-gray-100">
                <div class="max-w-6xl mx-auto px-4">
                    <h2 class="text-3xl font-extrabold text-center text-brand-navy mb-12">Wall of Love üíñ</h2>
                    <div class="grid md:grid-cols-3 gap-8">
                        <div class="bg-brand-bg p-8 rounded-2xl relative">
                            <div class="text-4xl text-brand-pink opacity-20 absolute top-4 left-4">‚ùù</div>
                            <p class="text-gray-600 mb-6 italic relative z-10">"My best friend literally cried when she
                                blew out the candle on her phone. Best digital gift ever!"</p>
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-10 h-10 bg-purple-200 rounded-full flex items-center justify-center font-bold text-purple-700">
                                    S</div>
                                <div>
                                    <div class="font-bold text-brand-navy text-sm">Sarah Jenkins</div>
                                    <div class="text-xs text-gray-400">Created 3 wishes</div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-brand-bg p-8 rounded-2xl relative">
                            <div class="text-4xl text-brand-pink opacity-20 absolute top-4 left-4">‚ùù</div>
                            <p class="text-gray-600 mb-6 italic relative z-10">"I forgot my sister's birthday and made
                                this in the Uber. She loved it more than the actual gift lol."</p>
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-10 h-10 bg-blue-200 rounded-full flex items-center justify-center font-bold text-blue-700">
                                    M</div>
                                <div>
                                    <div class="font-bold text-brand-navy text-sm">Mike T.</div>
                                    <div class="text-xs text-gray-400">Saved by WishLink</div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-brand-bg p-8 rounded-2xl relative">
                            <div class="text-4xl text-brand-pink opacity-20 absolute top-4 left-4">‚ùù</div>
                            <p class="text-gray-600 mb-6 italic relative z-10">"The design is so cute and the animations
                                are buttery smooth. Feels very premium for a free tool."</p>
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-10 h-10 bg-pink-200 rounded-full flex items-center justify-center font-bold text-pink-700">
                                    A</div>
                                <div>
                                    <div class="font-bold text-brand-navy text-sm">Ananya G.</div>
                                    <div class="text-xs text-gray-400">Super Fan</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- VIEW: LOGIN -->
        <div id="view-login"
            class="view-section hidden flex items-center justify-center flex-1 px-4 bg-gray-50 min-h-[80vh]">
            <div
                class="bg-white p-10 rounded-3xl shadow-xl max-w-sm w-full text-center border border-gray-100 animate-slide-up">
                <div
                    class="w-16 h-16 bg-pink-100 text-brand-pink rounded-full flex items-center justify-center mx-auto mb-6 text-2xl shadow-lg">
                    <i class="fas fa-heart"></i></div>
                <h2 class="text-3xl font-bold mb-2 text-brand-navy">Welcome Back!</h2>
                <p class="text-gray-500 mb-8 text-sm">Sign in to save your wishes forever.</p>
                <button onclick="App.Services.login()"
                    class="w-full py-3.5 px-4 border border-gray-300 rounded-xl flex items-center justify-center gap-3 hover:bg-gray-50 transition bg-white text-gray-700 font-bold">
                    <i class="fab fa-google text-red-500"></i> Continue with Google
                </button>
                <p class="text-[10px] text-gray-400 mt-6">By continuing, you agree to our Terms.</p>
            </div>
        </div>

        <!-- VIEW: DASHBOARD -->
        <div id="view-dashboard" class="view-section hidden max-w-4xl mx-auto px-4 py-10 w-full">
            <div class="flex justify-between items-end mb-8">
                <div>
                    <h2 class="text-3xl font-bold text-brand-navy">My Wishes</h2>
                    <p class="text-gray-500 text-sm mt-1">Manage the love you've shared</p>
                </div>
                <a href="#create"
                    class="px-5 py-2.5 bg-brand-pink text-white rounded-xl font-bold shadow-md hover:bg-pink-700 text-sm flex items-center gap-2 transition"><i
                        class="fas fa-plus"></i> New Wish</a>
            </div>
            <!-- Premium Banner -->
            <div id="premium-banner"
                class="hidden bg-gradient-to-r from-yellow-400 to-orange-400 p-6 rounded-2xl text-white flex justify-between items-center mb-10 shadow-lg">
                <div>
                    <h3 class="font-bold text-lg flex items-center gap-2"><i class="fas fa-crown text-yellow-100"></i>
                        Go Premium</h3>
                    <p class="text-white/90 text-sm mt-1">Unlock premium themes & remove ads for $1.</p>
                </div>
                <button onclick="App.Services.buyPremium()"
                    class="bg-white text-orange-500 px-5 py-2.5 rounded-xl font-bold text-sm hover:bg-orange-50 shadow-sm transition">Upgrade</button>
            </div>
            <div id="my-wishes-list" class="grid gap-4"></div>
        </div>

        <!-- VIEW: CREATE -->
        <div id="view-create" class="view-section hidden max-w-2xl mx-auto px-4 py-10 w-full">
            <div class="bg-white rounded-3xl shadow-xl p-6 md:p-10 border border-gray-100 animate-slide-up">
                <h2 class="text-3xl font-bold text-brand-navy mb-8 text-center">Create a New Wish ‚ú®</h2>
                <form id="create-form" class="space-y-6">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1 ml-1">Who is it for?</label>
                        <input type="text" id="recipient" required placeholder="e.g., Sarah"
                            class="w-full px-5 py-4 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-brand-pink focus:border-transparent outline-none transition font-semibold">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1 ml-1">Your Message</label>
                        <textarea id="message" required rows="4" placeholder="Write something sweet..."
                            class="w-full px-5 py-4 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-brand-pink outline-none transition"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-4 ml-1">Choose a Theme</label>
                        <div class="grid grid-cols-3 gap-4" id="theme-selector"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2 ml-1">Add a Photo (Optional)</label>
                        <div class="relative group cursor-pointer">
                            <input type="file" id="image-upload" accept="image/*"
                                class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                            <div id="upload-preview"
                                class="w-full bg-gray-50 border-2 border-dashed border-gray-300 rounded-xl p-6 flex flex-col items-center justify-center group-hover:border-brand-pink group-hover:bg-pink-50 transition-all">
                                <div
                                    class="w-12 h-12 bg-white rounded-full flex items-center justify-center mb-3 shadow-sm text-gray-400">
                                    <i class="fas fa-camera text-xl"></i></div>
                                <p id="file-upload-text" class="text-sm text-gray-500 font-medium">Click to upload</p>
                            </div>
                        </div>
                    </div>
                    <button type="submit" id="submit-btn"
                        class="w-full py-4 btn-gift text-white rounded-xl font-bold text-lg flex items-center justify-center gap-2 mt-4">Gift
                        this Wish üéÅ</button>
                </form>
            </div>
        </div>

        <!-- VIEW: WISH (PUBLIC) -->
        <div id="view-wish" class="view-section hidden min-h-screen bg-gray-900 w-full relative overflow-hidden">
            <div id="wish-content"
                class="relative z-10 w-full h-full min-h-screen flex flex-col items-center justify-center"></div>
            <canvas id="confetti-canvas" class="absolute inset-0 w-full h-full pointer-events-none z-20"></canvas>
            <a href="#home"
                class="fixed bottom-4 right-4 bg-white/20 backdrop-blur-sm px-4 py-1.5 rounded-full text-white text-xs font-bold hover:bg-white/40 transition z-50 flex items-center gap-2">
                <span>Made with</span> <span class="font-cursive text-sm">WishLink</span>
            </a>
        </div>

        <!-- VIEW: BLOG -->
        <div id="view-blog" class="view-section hidden max-w-4xl mx-auto px-4 py-10">
            <h2 class="text-3xl font-bold text-brand-navy mb-8">Birthday Ideas & Tips üí°</h2>
            <div class="grid md:grid-cols-2 gap-8">
                <article
                    class="bg-white rounded-2xl overflow-hidden shadow-sm border border-gray-100 hover:shadow-md transition duration-300 group cursor-pointer">
                    <div
                        class="h-48 bg-purple-50 flex items-center justify-center text-brand-pink text-6xl group-hover:scale-110 transition duration-500">
                        üéÇ</div>
                    <div class="p-8">
                        <h3 class="font-bold text-xl mb-3 text-brand-navy group-hover:text-brand-pink transition">10
                            Best Messages for Best Friends</h3>
                        <p class="text-gray-600 mb-4 text-sm leading-relaxed">Struggling to find the right words? Here
                            are the funniest and sweetest birthday wishes to steal.</p>
                        <span class="text-brand-pink font-bold text-sm">Read Article -></span>
                    </div>
                </article>
                <article
                    class="bg-white rounded-2xl overflow-hidden shadow-sm border border-gray-100 hover:shadow-md transition duration-300 group cursor-pointer">
                    <div
                        class="h-48 bg-pink-50 flex items-center justify-center text-brand-pink text-6xl group-hover:scale-110 transition duration-500">
                        üéÅ</div>
                    <div class="p-8">
                        <h3 class="font-bold text-xl mb-3 text-brand-navy group-hover:text-brand-pink transition">Last
                            Minute Digital Gift Ideas</h3>
                        <p class="text-gray-600 mb-4 text-sm leading-relaxed">Forgot a gift? Don't worry. Create a
                            WishLink and pair it with these instant digital vouchers.</p>
                        <span class="text-brand-pink font-bold text-sm">Read Article -></span>
                    </div>
                </article>
            </div>
        </div>
    </main>

    <!-- FOOTER -->
    <footer class="bg-gray-900 text-gray-400 py-10 text-center border-t border-gray-800 z-10 relative">
        <div class="flex items-center justify-center gap-2 mb-6">
            <img src="logo.png" onerror="this.src='https://placehold.co/20'" alt="Logo"
                class="h-6 w-auto brightness-0 invert">
            <span class="font-bold text-white tracking-wide">WishLink</span>
        </div>
        <div class="flex justify-center gap-6 text-sm font-medium mb-6">
            <button class="hover:text-white transition text-gray-400 hover:scale-105"
                onclick="App.Services.buyCoffee(50)">Buy us a Coffee ‚òï</button>
            <a href="#" class="hover:text-white transition text-gray-400 hover:scale-105">Privacy Policy</a>
            <a href="#" class="hover:text-white transition text-gray-400 hover:scale-105">Terms of Service</a>
        </div>
        <p class="text-xs text-gray-600">&copy; 2025 WishLink. Crafted with emotions.</p>
    </footer>

    <!-- AUDIO ELEMENTS -->
    <audio id="bg-music" loop preload="auto">
        <source src="h-bday.mp3" type="audio/mpeg">
    </audio>
    <audio id="cheer-audio" preload="auto">
        <source src="https://notificationsounds.com/storage/sounds/file-sounds-1235-victory.mp3" type="audio/mpeg">
    </audio>

    <!-- APP LOGIC -->
    <script>
        // --- CAKE REGISTRY ---
        const CakeFactory = {
            // Standard Interactive Candle Group (Scaled for 300x400 viewbox)
            // Note: Scale 0.3 fits the 1000px coordinate system into the 300px one
            getCandles(x, y) {
                return `
                    <g transform="translate(${x}, ${y}) scale(0.3)">
                        <g class="candle">
                            <rect x="-25" y="0" width="50" height="100" rx="8" fill="#ffd700" />
                            <rect x="-15" y="-30" width="30" height="35" rx="4" fill="#ffed4e" />
                            <g class="flame" style="transform-origin: 0px -30px;">
                                <path d="M 0 -30 Q -15 -80 0 -120 Q 15 -80 0 -30" fill="#ffb700" style="filter: drop-shadow(0 0 10px #ffb700);"/>
                                <path d="M 0 -35 Q -7 -70 0 -100 Q 7 -70 0 -35" fill="#ffd700" />
                            </g>
                        </g>
                    </g>
                `;
            },

            // 1. Simple Vector Cake (Classic)
            getSimpleCake() {
                return `
                    <svg width="250" height="250" viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <ellipse cx="100" cy="170" rx="90" ry="15" fill="#f0f0f0" />
                        <ellipse cx="100" cy="168" rx="90" ry="15" fill="#e0e0e0" />
                        <path d="M40 110 L40 150 C40 165 160 165 160 150 L160 110" fill="#8B4513" />
                        <ellipse cx="100" cy="110" rx="60" ry="20" fill="#A0522D" />
                        <path d="M38 110 C38 110 50 130 70 115 C90 100 110 130 130 115 C150 100 162 110 162 110 L162 100 C162 100 100 80 38 100 Z" fill="#FFC0CB" />
                        <ellipse cx="100" cy="100" rx="62" ry="22" fill="#FFB6C1" />
                        ${this.getCandles(100, 60)}
                    </svg>
                `;
            },

            // 2. Carrot Cake (Sunshine)
            getCarrotCake() {
                return `
                    <svg viewBox="0 0 300 400" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <linearGradient id="frosting-grad" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#FFF8E1" />
                                <stop offset="20%" style="stop-color:#FFFFFF" />
                                <stop offset="100%" style="stop-color:#FFE0B2" />
                            </linearGradient>
                            <linearGradient id="sponge-grad" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#D84315" />
                                <stop offset="50%" style="stop-color:#EF6C00" />
                                <stop offset="100%" style="stop-color:#BF360C" />
                            </linearGradient>
                        </defs>
                        <ellipse cx="150" cy="345" rx="90" ry="15" fill="#FFF" stroke="#CFD8DC" stroke-width="1"/>
                        <path d="M 65 260 L 65 330 C 65 350, 235 350, 235 330 L 235 260" fill="url(#frosting-grad)" />
                        <path d="M 65 260 C 65 280, 235 280, 235 260 C 235 240, 65 240, 65 260" fill="#FFE0B2" />
                        <path d="M 95 190 L 95 240 C 95 255, 205 255, 205 240 L 205 190" fill="url(#frosting-grad)" />
                        <path d="M 95 190 C 95 205, 205 205, 205 190 C 205 175, 95 175, 95 190" fill="#FFE0B2" />
                        ${this.getCandles(150, 190)}
                        ${this.getCandles(120, 195)}
                        ${this.getCandles(180, 195)}
                    </svg>
                `;
            },

            // 3. White Berry Drip (Ocean)
            getBerryCake() {
                return `
                    <svg viewBox="0 0 300 400" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <linearGradient id="pink-body-grad" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#FFC1E3" />
                                <stop offset="100%" style="stop-color:#F06292" />
                            </linearGradient>
                            <linearGradient id="white-frost-grad" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#FFFFFF" />
                                <stop offset="100%" style="stop-color:#E0E0E0" />
                            </linearGradient>
                        </defs>
                        <ellipse cx="150" cy="340" rx="90" ry="12" fill="#5D4037" opacity="0.2" />
                        <path d="M 70 260 L 70 320 C 70 340, 230 340, 230 320 L 230 260" fill="url(#pink-body-grad)" />
                        <path d="M 70 260 C 70 280, 230 280, 230 260 C 230 240, 70 240, 70 260" fill="#F48FB1" />
                        <path d="M 85 200 L 85 250 C 85 265, 215 265, 215 250 L 215 200" fill="url(#pink-body-grad)" />
                        <path d="M 85 200 C 85 215, 215 215, 215 200 C 215 185, 85 185, 85 200" fill="#F48FB1" />
                        <path d="M 85 200 L 85 210 Q 85 225, 100 225 Q 110 225, 110 215 Q 110 235, 130 235 Q 145 235, 145 215 Q 145 230, 160 230 Q 175 230, 175 210 Q 175 225, 195 225 Q 215 225, 215 210 L 215 200 C 215 185, 85 185, 85 200 Z" fill="url(#white-frost-grad)" />
                        ${this.getCandles(150, 200)}
                    </svg>
                `;
            },

            // 4. Red Velvet (Love - Premium)
            getRedVelvetCake() {
                return `
                    <svg viewBox="0 0 300 400" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <linearGradient id="red-body-grad" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#D32F2F" />
                                <stop offset="50%" style="stop-color:#C62828" />
                                <stop offset="100%" style="stop-color:#8E0000" />
                            </linearGradient>
                            <linearGradient id="cream-grad" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#FFF" />
                                <stop offset="100%" style="stop-color:#E0E0E0" />
                            </linearGradient>
                        </defs>
                        <ellipse cx="150" cy="345" rx="85" ry="15" fill="#FBC02D" />
                        <path d="M 70 260 L 70 330 C 70 350, 230 350, 230 330 L 230 260" fill="url(#red-body-grad)" />
                        <path d="M 70 260 C 70 280, 230 280, 230 260 C 230 240, 70 240, 70 260" fill="#B71C1C" />
                        <path d="M 70 280 C 70 300, 230 300, 230 280" fill="none" stroke="url(#cream-grad)" stroke-width="4" opacity="0.95"/>
                        <path d="M 100 180 L 100 240 C 100 255, 200 255, 200 240 L 200 180" fill="url(#red-body-grad)" />
                        <path d="M 100 180 C 100 195, 200 195, 200 180 C 200 165, 100 165, 100 180" fill="#E57373" />
                        ${this.getCandles(150, 180)}
                        ${this.getCandles(120, 185)}
                        ${this.getCandles(180, 185)}
                    </svg>
                `;
            },

            // 5. Dark Chocolate (Midnight - Premium)
            getChocolateCake() {
                return `
                    <svg viewBox="0 0 350 400" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <linearGradient id="sponge-grad" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#2D1B1E" />
                                <stop offset="100%" style="stop-color:#1A0F0F" />
                            </linearGradient>
                        </defs>
                        <ellipse cx="175" cy="340" rx="100" ry="12" fill="#1A0F0F" opacity="0.4" />
                        <path d="M 75 220 L 75 310 C 75 340, 275 340, 275 310 L 275 220" fill="url(#sponge-grad)" />
                        <path d="M 75 220 C 75 250, 275 250, 275 220 C 275 190, 75 190, 75 220" fill="#2D1B1E" />
                        <!-- Shavings -->
                        <path d="M 80 225 L 120 225 L 120 245 Z" fill="#3E2723" />
                        <path d="M 150 230 L 190 230 L 190 250 Z" fill="#4E342E" />
                        ${this.getCandles(175, 220)}
                        ${this.getCandles(125, 230)}
                        ${this.getCandles(225, 230)}
                    </svg>
                `;
            }
        };

        const App = {
            State: {
                user: null,
                isPremium: false,
                currentTheme: 'classic',
                audioContext: null,
                microphone: null,
                analyser: null,
                isBlowing: false,
                mediaStream: null
            },

            UI: {
                toast(msg, type = 'success') {
                    const container = document.getElementById('toast-container');
                    const el = document.createElement('div');
                    el.className = `toast ${type}`;
                    const icon = type === 'error' ? 'fa-exclamation-circle' : 'fa-check-circle';
                    el.innerHTML = `<i class="fas ${icon} text-lg"></i><span>${msg}</span>`;
                    container.appendChild(el);
                    requestAnimationFrame(() => el.classList.add('show'));
                    setTimeout(() => {
                        el.classList.remove('show');
                        setTimeout(() => el.remove(), 400);
                    }, 3000);
                },

                setLoading(btn, isLoading, text = 'Loading...') {
                    if (isLoading) {
                        btn.dataset.originalText = btn.innerHTML;
                        btn.disabled = true;
                        btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> ${text}`;
                    } else {
                        btn.disabled = false;
                        btn.innerHTML = btn.dataset.originalText || 'Submit';
                    }
                },

                renderThemes() {
                    const themes = [
                        { id: 'classic', name: 'Classic', color: 'from-purple-500 to-pink-500', premium: false },
                        { id: 'ocean', name: 'Ocean', color: 'from-blue-400 to-indigo-600', premium: false },
                        { id: 'sunshine', name: 'Sunshine', color: 'from-yellow-400 to-orange-500', premium: false },
                        { id: 'midnight', name: 'Midnight üåô', color: 'from-slate-900 to-slate-700', premium: true },
                        { id: 'love', name: 'Love ‚ù§Ô∏è', color: 'from-red-500 to-rose-600', premium: true }
                    ];

                    const container = document.getElementById('theme-selector');
                    if (!container) return;

                    container.innerHTML = themes.map(t => `
                        <div class="theme-card relative group cursor-pointer overflow-hidden rounded-xl h-24 ${App.State.currentTheme === t.id ? 'active' : ''}" 
                             onclick="App.Controllers.selectTheme('${t.id}', ${t.premium})">
                            <div class="absolute inset-0 bg-gradient-to-br ${t.color} opacity-80 group-hover:opacity-100 transition"></div>
                            ${t.premium ? `<div class="premium-lock absolute inset-0 bg-black/40 z-10 flex items-center justify-center ${App.State.isPremium ? 'hidden' : ''}"><i class="fas fa-lock text-white"></i></div>` : ''}
                            <div class="check-icon absolute inset-0 flex items-center justify-center ${App.State.currentTheme === t.id ? 'flex' : 'hidden'} z-20">
                                <div class="bg-white text-brand-pink rounded-full w-8 h-8 flex items-center justify-center shadow-md animate-bounce-in"><i class="fas fa-check"></i></div>
                            </div>
                            <div class="absolute bottom-2 w-full text-center text-white text-xs font-bold shadow-sm z-10">${t.name}</div>
                        </div>
                    `).join('');
                }
            },

            Services: {
                supabase: null,

                init() {
                    if (typeof CONFIG === 'undefined') {
                        App.UI.toast('Config missing!', 'error');
                        return;
                    }
                    this.supabase = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);

                    this.supabase.auth.onAuthStateChange((event, session) => {
                        App.State.user = session?.user || null;
                        App.Controllers.updateNav();
                        App.Services.checkPremium();
                        if (App.State.user && window.location.hash === '#login') {
                            const returnTo = sessionStorage.getItem('return_to') || 'dashboard';
                            sessionStorage.removeItem('return_to');
                            App.Router.go(returnTo);
                        }
                    });
                },

                async login() {
                    const { error } = await this.supabase.auth.signInWithOAuth({
                        provider: 'google',
                        options: { redirectTo: window.location.origin }
                    });
                    if (error) App.UI.toast(error.message, 'error');
                },

                async logout() {
                    await this.supabase.auth.signOut();
                    App.UI.toast('Logged out successfully');
                    App.Router.go('home');
                },

                async uploadImage(file) {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('upload_preset', CONFIG.CLOUDINARY_PRESET);
                    const res = await fetch(`https://api.cloudinary.com/v1_1/${CONFIG.CLOUDINARY_CLOUD_NAME}/image/upload`, { method: 'POST', body: formData });
                    if (!res.ok) throw new Error('Upload failed');
                    const data = await res.json();
                    return data.secure_url;
                },

                checkPremium() {
                    if (!App.State.user) return;
                    const isPrem = localStorage.getItem(`premium_${App.State.user.id}`) === 'true';
                    App.State.isPremium = isPrem;
                    if (isPrem) {
                        document.querySelectorAll('.premium-lock').forEach(el => el.classList.add('hidden'));
                        const banner = document.getElementById('premium-banner');
                        if (banner) banner.classList.add('hidden');
                    }
                },

                buyPremium() {
                    this.triggerPayment(4900, "WishLink Premium", "Unlock all themes", () => {
                        App.UI.toast("Payment Successful! Premium Unlocked üëë");
                        localStorage.setItem(`premium_${App.State.user.id}`, 'true');
                        App.Services.checkPremium();
                    });
                },

                buyCoffee(amount) {
                    this.triggerPayment(amount * 100, "Buy us a Coffee", "Thanks for your support! ‚òï", () => {
                        App.UI.toast("Thank you for the coffee! ‚ù§Ô∏è");
                    });
                },

                triggerPayment(amount, name, desc, successCallback) {
                    if (typeof Razorpay === 'undefined' || !CONFIG.RAZORPAY_KEY) {
                        alert("Payment Config Missing. Simulating success for demo.");
                        successCallback();
                        return;
                    }
                    const options = {
                        key: CONFIG.RAZORPAY_KEY, amount: amount, currency: "INR",
                        name: name, description: desc,
                        handler: function (response) { successCallback(); }
                    };
                    const rzp = new Razorpay(options);
                    rzp.open();
                }
            },

            Audio: {
                startMusic() {
                    const bgMusic = document.getElementById('bg-music');
                    bgMusic.volume = 0.4;
                    bgMusic.play().catch(() => console.log('Autoplay blocked'));
                },

                stopAll() {
                    const bg = document.getElementById('bg-music');
                    const cheer = document.getElementById('cheer-audio');
                    bg.pause(); bg.currentTime = 0;
                    cheer.pause(); cheer.currentTime = 0;
                    this.stopMic();
                },

                async initMic(onBlow) {
                    try {
                        App.State.mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        App.State.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        App.State.analyser = App.State.audioContext.createAnalyser();
                        App.State.microphone = App.State.audioContext.createMediaStreamSource(App.State.mediaStream);
                        App.State.microphone.connect(App.State.analyser);
                        App.State.analyser.fftSize = 256;

                        const bufferLength = App.State.analyser.frequencyBinCount;
                        const dataArray = new Uint8Array(bufferLength);

                        // Visual Indicator
                        const btn = document.getElementById('mic-btn');
                        if (btn) {
                            btn.innerHTML = '<i class="fas fa-microphone-lines fa-beat"></i> Listening...';
                            btn.classList.remove('bg-white', 'text-brand-navy');
                            btn.classList.add('bg-red-500', 'text-white', 'border-red-500');
                        }

                        const detectBlow = () => {
                            if (!App.State.audioContext) return;
                            App.State.analyser.getByteFrequencyData(dataArray);

                            let sum = 0;
                            for (let i = 0; i < bufferLength; i++) sum += dataArray[i];
                            const average = sum / bufferLength;

                            if (average > 40) { // Threshold adjusted to match script.js
                                onBlow();
                                this.stopMic();
                            } else {
                                requestAnimationFrame(detectBlow);
                            }
                        };
                        detectBlow();
                        App.UI.toast("Microphone Active! Blow on the screen üí®");
                    } catch (err) {
                        console.error("Mic error", err);
                        App.UI.toast("Microphone denied. Tap the cake instead.", "error");
                    }
                },

                stopMic() {
                    if (App.State.mediaStream) {
                        App.State.mediaStream.getTracks().forEach(track => track.stop());
                        App.State.mediaStream = null;
                    }
                    if (App.State.audioContext) {
                        App.State.audioContext.close();
                        App.State.audioContext = null;
                    }

                    // Reset Button UI
                    const btn = document.getElementById('mic-btn');
                    if (btn) {
                        btn.innerHTML = '<i class="fas fa-microphone"></i> Enable Mic';
                        btn.classList.add('bg-white', 'text-brand-navy');
                        btn.classList.remove('bg-red-500', 'text-white', 'border-red-500');
                    }
                }
            },

            Router: {
                init() {
                    window.addEventListener('hashchange', this.handleRoute.bind(this));
                    window.addEventListener('load', this.handleRoute.bind(this));
                },

                go(route) { window.location.hash = `#${route}`; },

                handleRoute() {
                    App.Audio.stopAll();

                    const hash = window.location.hash.slice(1) || 'home';
                    const [route, param] = hash.split('/');

                    document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));

                    const activeView = document.getElementById(`view-${route}`);
                    if (activeView) {
                        activeView.classList.remove('hidden');
                        activeView.classList.add('animate-fade-in');
                        window.scrollTo(0, 0);
                    }

                    if (route === 'dashboard') App.Controllers.loadDashboard();
                    if (route === 'create') App.UI.renderThemes();
                    if (route === 'wish' && param) App.Controllers.loadWish(param);
                    if (route === 'login' && App.State.user) this.go('dashboard');
                }
            },

            Controllers: {
                updateNav() {
                    const container = document.getElementById('nav-auth-container');
                    if (App.State.user) {
                        container.innerHTML = `
                            <button onclick="App.Router.go('dashboard')" class="text-brand-navy hover:text-brand-pink transition font-bold"><i class="fas fa-user-circle"></i> Dashboard</button>
                            <button onclick="App.Services.logout()" class="text-red-400 hover:text-red-600 transition"><i class="fas fa-sign-out-alt"></i></button>
                        `;
                    } else {
                        container.innerHTML = `<button onclick="App.Router.go('login')" class="text-brand-navy hover:text-brand-pink transition font-bold">Login</button>`;
                    }
                },

                selectTheme(id, isPremium) {
                    if (isPremium && !App.State.isPremium) {
                        App.UI.toast("This theme requires Premium upgrade üëë", "error");
                        return;
                    }
                    App.State.currentTheme = id;
                    App.UI.renderThemes();
                },

                async handleCreate(e) {
                    e.preventDefault();
                    if (!App.State.user) {
                        App.UI.toast("Please login to create a wish");
                        sessionStorage.setItem('return_to', 'create');
                        App.Router.go('login');
                        return;
                    }

                    const btn = document.getElementById('submit-btn');
                    App.UI.setLoading(btn, true, "Wrapping Gift...");

                    try {
                        const fileInput = document.getElementById('image-upload');
                        let imgUrl = null;

                        if (fileInput.files.length) {
                            App.UI.setLoading(btn, true, "Uploading Photo...");
                            imgUrl = await App.Services.uploadImage(fileInput.files[0]);
                        }

                        App.UI.setLoading(btn, true, "Finalizing...");

                        const { data, error } = await App.Services.supabase
                            .from('wishes')
                            .insert([{
                                recipient_name: document.getElementById('recipient').value,
                                message: document.getElementById('message').value,
                                theme: App.State.currentTheme,
                                image_url: imgUrl,
                                creator_id: App.State.user.id
                            }])
                            .select()
                            .single();

                        if (error) throw error;

                        App.Controllers.showShareModal(data.id);
                        document.getElementById('create-form').reset();
                        App.State.currentTheme = 'classic';
                        App.UI.renderThemes();

                    } catch (err) {
                        App.UI.toast(err.message || "Something went wrong", "error");
                    } finally {
                        App.UI.setLoading(btn, false);
                    }
                },

                showShareModal(id) {
                    const url = `${window.location.origin}/#wish/${id}`;
                    const modal = document.createElement('div');
                    modal.className = "fixed inset-0 bg-brand-navy/80 backdrop-blur-sm flex items-center justify-center z-[100] p-4";
                    modal.innerHTML = `
                        <div class="bg-white rounded-3xl p-8 max-w-md w-full text-center animate-bounce-in shadow-2xl relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-brand-pink to-brand-navy"></div>
                            <h3 class="text-2xl font-bold text-brand-navy mb-2">Ready to Gift! üéâ</h3>
                            <div class="bg-gray-50 p-4 rounded-xl flex items-center mb-6 border border-gray-200 mt-4">
                                <input type="text" value="${url}" readonly class="bg-transparent flex-1 outline-none text-sm text-gray-600 truncate font-mono">
                                <button onclick="navigator.clipboard.writeText('${url}'); App.UI.toast('Copied!')" class="ml-3 text-brand-pink font-bold text-xs uppercase">Copy</button>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <a href="whatsapp://send?text=${encodeURIComponent('Happy Birthday! üéÇ ' + url)}" class="py-3 bg-[#25D366] text-white rounded-xl font-bold text-sm flex items-center justify-center gap-2 hover:opacity-90"><i class="fab fa-whatsapp"></i> WhatsApp</a>
                                <button onclick="window.location.href='${url}'" class="py-3 bg-brand-navy text-white rounded-xl font-bold text-sm flex items-center justify-center gap-2 hover:opacity-90">Open Wish</button>
                            </div>
                            <button onclick="this.closest('.fixed').remove()" class="mt-4 text-xs text-gray-400 font-bold hover:text-gray-600">Close</button>
                        </div>
                    `;
                    document.body.appendChild(modal);
                },

                async loadDashboard() {
                    if (!App.State.user) return App.Router.go('login');

                    const list = document.getElementById('my-wishes-list');
                    list.innerHTML = '<div class="text-center py-10"><i class="fas fa-spinner fa-spin text-brand-pink text-2xl"></i></div>';

                    const banner = document.getElementById('premium-banner');
                    if (banner && !App.State.isPremium) banner.classList.remove('hidden');

                    const { data, error } = await App.Services.supabase
                        .from('wishes').select('*').eq('creator_id', App.State.user.id).order('created_at', { ascending: false });

                    if (!data || data.length === 0) {
                        list.innerHTML = `<div class="text-center py-10 border-2 border-dashed rounded-xl bg-gray-50 text-gray-400">No wishes yet. Create one!</div>`;
                        return;
                    }

                    list.innerHTML = data.map(w => `
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center hover:shadow-md transition">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-full bg-pink-50 flex items-center justify-center text-xl">üéÇ</div>
                                <div>
                                    <h4 class="font-bold text-brand-navy">${w.recipient_name}</h4>
                                    <a href="#wish/${w.id}" class="text-xs text-brand-pink hover:underline">View Wish</a>
                                </div>
                            </div>
                            <button onclick="App.Controllers.deleteWish('${w.id}')" class="text-gray-300 hover:text-red-500 transition px-2"><i class="fas fa-trash"></i></button>
                        </div>
                    `).join('');
                },

                async deleteWish(id) {
                    if (!confirm("Delete this wish?")) return;
                    await App.Services.supabase.from('wishes').delete().eq('id', id);
                    this.loadDashboard();
                    App.UI.toast("Wish deleted");
                },

                async loadWish(id) {
                    const container = document.getElementById('wish-content');
                    container.innerHTML = '<div class="text-white flex flex-col items-center gap-4"><i class="fas fa-birthday-cake fa-bounce text-5xl"></i><p>Baking the cake...</p></div>';

                    const { data, error } = await App.Services.supabase.from('wishes').select('*').eq('id', id).single();

                    if (error || !data) {
                        container.innerHTML = '<div class="text-white text-xl">Wish not found üò¢</div>';
                        return;
                    }

                    const view = document.getElementById('view-wish');
                    view.className = "view-section min-h-screen w-full relative overflow-hidden flex flex-col items-center justify-center";

                    if (data.theme === 'love') view.classList.add('bg-love');
                    else if (data.theme === 'midnight') view.classList.add('bg-midnight');
                    else {
                        const colors = { classic: 'from-purple-500 to-pink-500', ocean: 'from-blue-400 to-indigo-600', sunshine: 'from-yellow-400 to-orange-500' };
                        view.classList.add('bg-gradient-to-br');
                        const grad = colors[data.theme] || colors.classic;
                        grad.split(' ').forEach(c => view.classList.add(c));
                    }

                    // Cake Selection Logic based on Theme
                    let cakeSVG;
                    switch (data.theme) {
                        case 'love': cakeSVG = CakeFactory.getRedVelvetCake(); break;
                        case 'midnight': cakeSVG = CakeFactory.getChocolateCake(); break;
                        case 'sunshine': cakeSVG = CakeFactory.getCarrotCake(); break;
                        case 'ocean': cakeSVG = CakeFactory.getBerryCake(); break;
                        default: cakeSVG = CakeFactory.getSimpleCake(); break;
                    }

                    let particles = '';
                    if (data.theme === 'love') {
                        for (let i = 0; i < 6; i++) particles += `<div class="floating-heart text-white/30 text-4xl" style="left:${Math.random() * 100}%; animation-delay:${Math.random() * 5}s">‚ù§Ô∏è</div>`;
                    } else if (data.theme === 'midnight') {
                        for (let i = 0; i < 30; i++) particles += `<div class="star-twinkle" style="top:${Math.random() * 100}%; left:${Math.random() * 100}%; width:${Math.random() * 3}px; height:${Math.random() * 3}px; --duration:${2 + Math.random() * 3}s"></div>`;
                    }

                    const cardClass = data.theme === 'midnight' ? 'bg-white/10 border-white/20 text-white' : 'bg-white/90 border-white/50 text-brand-navy';

                    container.innerHTML = `
                        ${particles}
                        
                        <div id="phase-1" class="text-center z-20 transition-all duration-700 flex flex-col items-center">
                            <h1 class="text-4xl md:text-6xl font-extrabold text-white mb-8 drop-shadow-lg font-cursive animate-slide-up">
                                Happy Birthday <br> <span class="text-yellow-300">${data.recipient_name}</span>!
                            </h1>
                            
                            <!-- DYNAMIC SVG CAKE -->
                            <div class="relative cursor-pointer hover:scale-105 transition duration-300 inline-block mt-8 animate-bounce-in" onclick="App.Controllers.blowCandle()">
                                ${cakeSVG}
                            </div>

                            <!-- CONTROLS -->
                            <div class="mt-8 flex flex-wrap justify-center gap-4 animate-slide-up" style="animation-delay: 0.2s">
                                <button id="mic-btn" onclick="App.Audio.initMic(App.Controllers.blowCandle)" class="bg-white text-brand-navy px-6 py-3 rounded-full font-bold shadow-lg hover:scale-105 transition flex items-center gap-2 border-2 border-transparent">
                                    <i class="fas fa-microphone"></i> Enable Mic to Blow
                                </button>
                                <button onclick="App.Controllers.blowCandle()" class="bg-white/20 text-white backdrop-blur-sm px-6 py-3 rounded-full font-bold shadow-lg hover:bg-white/30 transition border border-white/40">
                                    üëá Tap to Wish
                                </button>
                            </div>
                        </div>

                        <!-- Phase 2: Card -->
                        <div id="phase-2" class="hidden opacity-0 transform translate-y-10 transition-all duration-1000 z-20 max-w-lg w-full px-4">
                            <div class="${cardClass} backdrop-blur-xl rounded-3xl p-8 shadow-2xl border relative text-center">
                                ${data.image_url ? `<img src="${data.image_url}" class="w-32 h-32 rounded-full mx-auto mb-6 object-cover border-4 border-white shadow-lg">` : ''}
                                <p class="text-xl md:text-3xl font-cursive mb-6">"${data.message}"</p>
                                <div class="flex items-center justify-center gap-3 opacity-60 text-xs font-bold uppercase tracking-widest mb-6">
                                    <span class="h-px w-8 bg-current"></span> With Love <span class="h-px w-8 bg-current"></span>
                                </div>
                                <a href="#create" class="inline-block px-6 py-3 bg-brand-pink text-white rounded-full font-bold shadow-lg text-sm hover:scale-105 transition">Create your own</a>
                            </div>
                        </div>
                    `;

                    const playMusic = () => {
                        App.Audio.startMusic();
                        document.body.removeEventListener('click', playMusic);
                        document.body.removeEventListener('touchstart', playMusic);
                    };
                    document.body.addEventListener('click', playMusic);
                    document.body.addEventListener('touchstart', playMusic);
                },

                blowCandle() {
                    const flames = document.querySelectorAll('.flame');
                    if (flames.length === 0 || flames[0].classList.contains('hidden')) return;

                    // Apply the 'flame-out' class
                    flames.forEach(flame => flame.classList.add('flame-out'));

                    // Stop Mic Immediately
                    App.Audio.stopMic();

                    const bg = document.getElementById('bg-music');
                    const cheer = document.getElementById('cheer-audio');
                    bg.pause();
                    cheer.play();

                    App.Controllers.startConfetti();

                    // Wait for flame animation (300ms) then switch phase
                    setTimeout(() => {
                        const p1 = document.getElementById('phase-1');
                        const p2 = document.getElementById('phase-2');

                        p1.style.opacity = '0';
                        p1.style.transform = 'scale(0.9)';

                        setTimeout(() => {
                            p1.classList.add('hidden');
                            p2.classList.remove('hidden');
                            requestAnimationFrame(() => {
                                p2.classList.remove('opacity-0', 'translate-y-10');
                            });
                        }, 600);
                    }, 300);
                },

                startConfetti() {
                    const canvas = document.getElementById('confetti-canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;

                    const particles = Array.from({ length: 150 }, () => ({
                        x: Math.random() * canvas.width,
                        y: Math.random() * canvas.height - canvas.height,
                        color: ['#FF0055', '#FFD700', '#00BFFF', '#32CD32'][Math.floor(Math.random() * 4)],
                        size: Math.random() * 8 + 2,
                        speedY: Math.random() * 3 + 2,
                        speedX: Math.random() * 2 - 1
                    }));

                    function loop() {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        particles.forEach(p => {
                            p.y += p.speedY;
                            p.x += p.speedX;
                            ctx.fillStyle = p.color;
                            ctx.fillRect(p.x, p.y, p.size, p.size);
                            if (p.y > canvas.height) p.y = -10;
                        });
                        requestAnimationFrame(loop);
                    }
                    loop();
                }
            }
        };

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            App.Services.init();
            App.Router.init();

            const fileInput = document.getElementById('image-upload');
            if (fileInput) {
                fileInput.onchange = (e) => {
                    const name = e.target.files[0]?.name;
                    document.getElementById('file-upload-text').textContent = name || "Click to upload";
                    document.getElementById('file-upload-text').className = "text-brand-pink font-bold";
                };
            }

            const form = document.getElementById('create-form');
            if (form) form.addEventListener('submit', App.Controllers.handleCreate);
        });
    </script>
</body>

</html>